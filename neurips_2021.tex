\documentclass{article}

% if you need to pass options to natbib, use, e.g.:
%     \PassOptionsToPackage{numbers, compress}{natbib}
% before loading neurips_2021

% ready for submission
\usepackage{neurips_2021}

% to compile a preprint version, e.g., for submission to arXiv, add add the
% [preprint] option:
%     \usepackage[preprint]{neurips_2021}

% to compile a camera-ready version, add the [final] option, e.g.:
%     \usepackage[final]{neurips_2021}

% to avoid loading the natbib package, add option nonatbib:
%    \usepackage[nonatbib]{neurips_2021}

\usepackage[utf8]{inputenc} % allow utf-8 input
\usepackage[T1]{fontenc}    % use 8-bit T1 fonts
\usepackage{hyperref}       % hyperlinks
\usepackage{url}            % simple URL typesetting
\usepackage{booktabs}       % professional-quality tables
\usepackage{amsfonts}       % blackboard math symbols
\usepackage{nicefrac}       % compact symbols for 1/2, etc.
\usepackage{microtype}      % microtypography
\usepackage{xcolor}         % colors

\include{macros}
\usepackage[textsize=tiny]{todonotes}
\usepackage{footnote}
\usepackage{mathtools}
\usepackage[flushleft]{threeparttable}

\newcommand{\alexander}[1]{\todo[inline]{\textbf{Alexander: }#1}}

\newcommand*{\probavailable}{\ensuremath{p_{\textnormal{a}}}}
\newcommand*{\probpairaa}{\ensuremath{p_{\textnormal{aa}}}}
\newcommand*{\probpairan}{\ensuremath{p_{\textnormal{an}}}}
\newcommand*{\probpairnn}{\ensuremath{p_{\textnormal{nn}}}}

\newcommand*{\probpage}{\ensuremath{p_{\text{page}}}}
\newcommand*{\probmega}{\ensuremath{p_{\text{mega}}}}

\allowdisplaybreaks
\makeatletter
\newcommand{\vast}{\bBigg@{4}}
\newcommand{\Vast}{\bBigg@{5}}
\makeatother

\newcommand{\improvement}[1]{{\color{orange}#1}}
\newcommand{\degeneration}[1]{{\color{red}#1}}

\title{Formatting Instructions For NeurIPS 2021}

% The \author macro works with any number of authors. There are two commands
% used to separate the names and addresses of multiple authors: \And and \AND.
%
% Using \And between authors leaves it to LaTeX to determine where to break the
% lines. Using \AND forces a line break at that point. So, if LaTeX puts 3 of 4
% authors names on the first line, and the last on the second line, try using
% \AND instead of \And before the third author name.

\author{%
  Alexander Tyurin\\
  KAUST\\
  Saudi Arabia\\
  \texttt{alexandertiurin@gmail.com} \\
  \And
  Peter Richt\'{a}rik \\
  KAUST\\
  Saudi Arabia\\
  \texttt{richtarik@gmail.com} \\
}

\begin{document}

\maketitle

\begin{abstract}
\end{abstract}

\section{Introduction}

\begin{enumerate}
  \item Partial Participation
  \item Variance Reduction
  \item No Synchronization
  \item Compression
\end{enumerate}

% \begin{table*}
%   \caption{\textbf{General Nonconvex Case.} The number of communication rounds (iterations) and the oracle complexity of algorithms to get an $\varepsilon$-solution ($\Exp{\norm{\nabla f(\widehat{x})}^2} \leq \varepsilon$).}
%   \label{table:general_case}
%   \centering 
%   \small
%   \begin{threeparttable}
%     \begin{tabular}{cccccc}
%       \midrule
%     Setting & Method & Comm. Rounds & Comm. Comp. & Oracle Comp. & Partial Participation \\
%      \midrule\midrule
%      \multirow{4}{*}{\tablesmall{Gradient}} 
%      & \algnamesmall{PP-MARINA} &   $\frac{1}{\varepsilon} + \frac{(\omega + 1)\sqrt{n}}{\varepsilon s}$ & SOTA & Optimal & No \\
%      & \algnamesmall{FRECON} &   $\frac{1}{\varepsilon} + \frac{(\omega + 1)\sqrt{n}}{\varepsilon s}$ & SOTA & Optimal & Yes \\
%      & \algnamesmall{DASHA} &   $\frac{1}{\varepsilon} + \frac{(\omega + 1)\sqrt{n}}{\varepsilon s}$ & SOTA & Optimal & Yes \\
%      & \algnamesmall{DASHA-PP} (New) &  $\frac{1}{\varepsilon} + \frac{(\omega + 1)\sqrt{n}}{\varepsilon s}$ & SOTA & Optimal & Yes \\
%     \end{tabular}
% \end{threeparttable}
% \end{table*}
% A comparison of methods with partial participation of nodes:

% \begin{table}[h]
%   \caption{}
%   \centering 
%   \small
%   \begin{threeparttable}
%     \begin{tabular}{cccccc}
%       \midrule
%     Setting & Method & Comm. Rounds & Comm. Comp. & Oracle Comp. & Partial Participation \\
%      \midrule\midrule
%      \multirow{2}{*}{\tablesmall{Finite-Sum}} 
%      & \algnamesmall{DASHA} &   $\frac{1}{\varepsilon} + \frac{(\omega + 1)\sqrt{n}}{\varepsilon s}$ & SOTA & Optimal & Yes \\
%      & \algnamesmall{DASHA-PP} (New) &  $\frac{1}{\varepsilon} + \frac{(\omega + 1)\sqrt{n}}{\varepsilon s}$ & SOTA & Optimal & Yes \\
%     \end{tabular}
% \end{threeparttable}
% \end{table}

% \begin{table}[h]
%   \caption{}
%   \centering 
%   \small
%   \begin{threeparttable}
%     \begin{tabular}{cccccc}
%       \midrule
%     Setting & Method & Comm. Rounds & Comm. Comp. & Oracle Comp. & Partial Participation \\
%      \midrule\midrule
%      \multirow{2}{*}{\tablesmall{Stochastic}} 
%      & \algnamesmall{DASHA} &   $\frac{1}{\varepsilon} + \frac{(\omega + 1)\sqrt{n}}{\varepsilon s}$ & SOTA & Optimal & Yes \\
%      & \algnamesmall{DASHA-PP} (New) &  $\frac{1}{\varepsilon} + \frac{(\omega + 1)\sqrt{n}}{\varepsilon s}$ & SOTA & Optimal & Yes \\
%     \end{tabular}
% \end{threeparttable}
% \end{table}


\section{Assumptions}

In this section, we list the assumptions that we use in the paper.

\subsection{Functions assumptions\footnote{Note that $L \leq \widehat{L},$ $\widehat{L} \leq L_{\max},$ and $\widehat{L} \leq L_{\sigma}.$}}
Now, we provide assumptions for the functions $f_i.$
\begin{assumption}
    \label{ass:lower_bound}
    There exists $f^* \in \R$ such that $f(x) \geq f^*$ for all $x \in \R$.
\end{assumption}
\begin{assumption}
    \label{ass:lipschitz_constant}
    The function $f$ is $L$--smooth for all $i \in [n]$, i.e., $\norm{\nabla f(x) - \nabla f(y)} \leq L \norm{x - y}$ for all $x, y \in \R^d.$
\end{assumption}
\begin{assumption} \leavevmode
    \label{ass:nodes_lipschitz_constant}
    The functions $f_i$ are $L_i$--smooth. We define $\widehat{L}^2 \eqdef \frac{1}{n} \sum_{i=1}^{n} L_i^2.$
\end{assumption}
The next assumption is used in the finite-sum setting \eqref{eq:task_minibatch}.
\begin{assumption}
    \label{ass:max_lipschitz_constant}
    The function $f_{ij}$ is $L_{ij}$-smooth for all $i \in [n], j \in [m].$ Let $L_{\max} \eqdef \max_{i \in [n], j \in [m]} L_{ij}.$
\end{assumption}
The two assumptions below are provided for the stochastic setting \eqref{eq:task_staochastic}.
\begin{assumption}
    \label{ass:stochastic_unbiased_and_variance_bounded}
    For all $i \in [n]$ and for all $x \in \R^d,$ the stochastic gradient $\nabla f_i(x;\xi)$ is unbiased and has bounded variance, i.e.,
    $$\ExpSub{\xi}{\nabla f_i(x;\xi)} = \nabla f_i(x), \qquad \text{and} \qquad \ExpSub{\xi}{\norm{\nabla f_i(x;\xi) - \nabla f_i(x)}^2} \leq \sigma^2,$$ 
    where $\sigma^2 \geq 0.$
\end{assumption}
\begin{assumption}
    \label{ass:mean_square_smoothness}
    For all $i \in [n]$ and for all $x, y \in \R,$ the stochastic gradient $\nabla f_i(x;\xi)$ satisfies the mean-squared smoothness property, i.e.,
    % $$\ExpSub{\xi}{\norm{\nabla f_i(x;\xi) - \nabla f_i(y;\xi) - \left(\nabla f_i(x) - \nabla f_i(y)\right)}^2} \leq L_{\sigma}^2 \norm{x - y}^2.$$
    $$\ExpSub{\xi}{\norm{\nabla f_i(x;\xi) - \nabla f_i(y;\xi)}^2} \leq L_{\sigma}^2 \norm{x - y}^2.$$
\end{assumption}

\alexander{It is better to fix proofs with a new definition}

\subsection{Compressors assumptions}
\begin{definition}
    A stochastic mapping $\cC\,:\,\R^d \rightarrow \R^d$ is an \textit{unbiased compressor} if
    there exists $\omega \in \R$ such that
    \begin{align}
        \label{eq:compressor}
        \hspace{-0.2cm}\Exp{\cC(x)} = x, \qquad \Exp{\norm{\cC(x) - x}^2} \leq \omega \norm{x}^2, \qquad \forall x \in \R^d.
    \end{align}
    We denote this class of unbiased compressors  as $\mathbb{U}(\omega).$
\end{definition}
\begin{assumption}
\label{ass:compressors}
 $\cC_i \in \mathbb{U}(\omega)$ for all $i\in [n]$, and the compressors are  \textit{independent}.
\end{assumption}

\subsection{Nodes partial participation assumptions}
\label{sec:partial_participation}

\newcommand\Item[1][]{%
  \ifx\relax#1\relax  \item \else \item[#1] \fi
  \abovedisplayskip=0pt\abovedisplayshortskip=0pt~\vspace*{-\baselineskip}}

\begin{assumption}
  \label{ass:partial_participation}
  The partial participation of nodes has the following distribution: exists constants $\probavailable \in (0, 1]$ and $\probpairaa \in [0, 1],$ such that
  \begin{enumerate}
    \Item \begin{align*}\Prob\left(i^{\textnormal{th}} \textnormal{ node is \textit{participating}}\right) = \probavailable, \quad \forall i \in [n],\end{align*}
    \Item \begin{align*}\Prob\left(i^{\textnormal{th}} \textnormal{ node is \textit{participating}}, j^{\textnormal{th}} \textnormal{ node is \textit{participating}}\right) = \probpairaa, \quad \forall i \neq j \in [n],\end{align*}
    \Item \begin{align} \label{eq:partial_participation_constraint}
      \probpairaa \leq \probavailable^2,
    \end{align}
  \end{enumerate}
  and these events from different communication rounds are independent.
\end{assumption}
Standard partial participation strategies, including $s$--nice sampling (with $\probavailable = \nicefrac{s}{n}$ and $\probpairaa~=~\nicefrac{s(s-1)}{n(n-1)}$) and independent participation (with $\probpairaa = \probavailable^2$), satisfy the assumptions.

\section{Algorithm description}

\begin{minipage}{\textwidth}
\begin{algorithm}[H]
  \caption{\algname{DASHA-PP}}
  \label{alg:main_algorithm}
  \begin{algorithmic}[1]
  \STATE \textbf{Input:} starting point $x^0 \in \R^d$, stepsize $\gamma > 0$, momentum $a \in (0, 1]$, 
  momentum $b \in (0, 1]$, probability $\probavailable \in (0, 1]$ that a node is \textit{participating}\textsuperscript{\red (a)},
  batch size $B$ (only in \algname{DASHA-PP-PAGE} and \algname{DASHA-PP-MVR}), 
  probability $\probpage \in (0, 1]$ (only in \algname{DASHA-PP-PAGE}),
  number of iterations~$T \geq 1$
  \STATE Initialize $g^0_i\in \R^d$, $h^0_i\in \R^d$ on the nodes and  $g^0 = \frac{1}{n}\sum_{i=1}^n g^0_i$ on the server
  \STATE Initialize $h^0_{ij}\in \R^d$ on the nodes (only in \algname{DASHA-PP-FINITE-MVR})
  \FOR{$t = 0, 1, \dots, T - 1$}
  \STATE $x^{t+1} = x^t - \gamma g^t$ \alglinelabel{alg:main_algorithm:x_update} 
  \STATE Broadcast $x^{t+1}, x^{t}$ to all \textit{participating}\textsuperscript{\red (a)} nodes
  \FOR{$i = 1, \dots, n$ in parallel}
  \IF{$i^{\textnormal{th}} \textnormal{ node is \textit{participating}}$\textsuperscript{\red (a)}}
    \STATE 

  \begin{flalign*}
    \begin{rcases}
      k^{t+1}_i = \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b \left(h^t_i - \nabla f_i(x^{t})\right) \Bigg.
    \end{rcases} \textnormal{(\algname{DASHA-PP})} &&
  \end{flalign*}
  \begin{flalign*}
    \begin{rcases}
      \textnormal{Generate a random set $I^t_i$ of size $B$ from $[m]$ \textit{with replacement}} \\
      k^{t+1}_i = 
      \begin{cases}
        \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right),& \\ \qquad \textnormal{with probability $\probpage$ on all \textit{participating}\textsuperscript{\red (a)} nodes} \\
        \frac{1}{B}\sum_{j \in I^t_i}\left(\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})\right), & \\
        \qquad \textnormal{with probability $1 - \probpage$ on all \textit{participating}\textsuperscript{\red (a)} nodes} 
      \end{cases} \Bigg.
    \end{rcases} \textnormal{(\algname{DASHA-PP-PAGE})} &&
  \end{flalign*}
  \begin{flalign*}
    \begin{rcases}
      \textnormal{Generate a random set $I^t_i$ of size $B$ from $[m]$ \textit{without replacement}}\\
      k^{t+1}_{ij} = \begin{cases}
        \frac{m}{B}\left(\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t}) - b \left(h^t_{ij} - \nabla f_{ij}(x^{t})\right)\right), & j \in I^t_i  \\
        0, & j \not\in I^t_i
      \end{cases} \\
      h^{t+1}_{ij} = h^t_{ij} + \frac{1}{\probavailable} k^{t+1}_{ij} \\
      k^{t+1}_i = \frac{1}{m}\sum_{j=1}^m k^{t+1}_{ij} \\
    \end{rcases} \textnormal{(\algname{DASHA-PP-FINITE-MVR})} &&
  \end{flalign*} 
  \begin{flalign*}
    \begin{rcases}
      k^{t+1}_i = \frac{1}{B}\sum_{j=1}^B \nabla f_i(x^{t+1};\xi^{t+1}_{ij}) - \frac{1}{B}\sum_{j=1}^B \nabla f_i(x^{t};\xi^{t+1}_{ij}) \\
      \qquad\qquad - b \left(h^t_i - \frac{1}{B}\sum_{j=1}^B \nabla f_i(x^{t};\xi^{t+1}_{ij})\right) \Bigg. 
    \end{rcases} \textnormal{(\algname{DASHA-PP-MVR})}&&
  \end{flalign*}
      \STATE $h^{t+1}_i = h^t_i + \frac{1}{\probavailable}k^{t+1}_i$ 
      \STATE $m^{t+1}_i = \cC_i\Bigg(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\Bigg)$
      \STATE $g^{t+1}_i = g^{t}_i + m^{t+1}_i$
      \STATE Send $m^{t+1}_i$ to the server
  \ELSE
      \STATE $h^{t+1}_{ij} = h^{t}_{ij}$ (only in \algname{DASHA-PP-FINITE-MVR})
      \STATE $h^{t+1}_i = h^{t}_i$
      \STATE $m^{t+1}_i = 0$
      \STATE $g^{t+1}_i = g^{t}_i$
  \ENDIF
  \ENDFOR
  \STATE $g^{t+1} = g^t + \frac{1}{n} \sum_{i=1}^n m^{t+1}_i$
  \ENDFOR
  \STATE \textbf{Output:} $\hat{x}^T$ chosen uniformly at random from $\{x^t\}_{k=0}^{T-1}$ (or $x^T$ under the P\L-condition)
  \end{algorithmic}
  % {\red (a)}: 
\end{algorithm}
{\red (a)}: For the formal description see Section~\ref{sec:partial_participation}.
\end{minipage}

\section{Theorems}

We now present the convergence rates theorems of \algname{DASHA-PP} in different settings. We will compare the theorems with the results of \algname{DASHA}. For any setting, suppose that \algname{DASHA} converges to $\varepsilon$-solution after $T$ communication rounds. Then, ideally, we would expect the convergence of the new algorithms to $\varepsilon$-solution after up to $\nicefrac{T}{\probavailable}$ communication rounds due to the partial participation.

\subsection{Gradient setting}

\begin{restatable}{theorem}{CONVERGENCE}
  \label{theorem:gradient_oracle}
  Suppose that Assumptions \ref{ass:lower_bound}, \ref{ass:lipschitz_constant}, \ref{ass:nodes_lipschitz_constant}, \ref{ass:compressors} and \ref{ass:partial_participation} hold. Let us take $a = \frac{\probavailable}{2 \omega + 1} ,$ $b = \frac{\probavailable}{2 - \probavailable},$ $$\gamma \leq \left(L + \sqrt{\frac{48 \omega \left(2 \omega + 1\right)}{n \probavailable^2} + \frac{16}{n \probavailable^2}\left(1 - \frac{\probpairaa}{\probavailable}\right)}\widehat{L}\right)^{-1},$$ and $g^{0}_i = h^{0}_i = \nabla f_i(x^0)$ for all $i \in [n]$
  in Algorithm~\ref{alg:main_algorithm} \algname{(DASHA-PP)}, then
  \begin{align*}
      &\Exp{\norm{\nabla f(\widehat{x}^T)}^2} \leq \frac{1}{T}\Bigg[2 \left(f(x^0) - f^*\right)\left(L + \sqrt{\frac{48 \omega \left(2 \omega + 1\right)}{n \probavailable^2} + \frac{16}{n \probavailable^2}\left(1 - \frac{\probpairaa}{\probavailable}\right)} \widehat{L}\right)\Bigg].
  \end{align*}
\end{restatable}

Let us recall the convergence rate of \algname{DASHA} or \algname{MARINA}, the number of communication rounds to get $\varepsilon$-solution equals
$\cO\left(\frac{1}{\varepsilon}\left[L + \frac{\omega}{\sqrt{n}}\widehat{L}\right]\right),$ while the rate of \algname{DASHA-PP} equals $\cO\left(\frac{1}{\varepsilon}\left[L + \frac{\omega + 1}{\probavailable \sqrt{n}}\widehat{L}\right]\right)$. Up to Lipschitz constants factors, we get the degeneration up to $\nicefrac{1}{\probavailable}$ due to the  partial participation.

\subsection{Finite-sum setting}

\label{sec:finite_sum_setting}

\begin{restatable}{theorem}{CONVERGENCEPAGE}
  \label{theorem:page}
  Suppose that Assumptions \ref{ass:lower_bound}, \ref{ass:lipschitz_constant}, \ref{ass:nodes_lipschitz_constant}, \ref{ass:max_lipschitz_constant}, \ref{ass:compressors}, and \ref{ass:partial_participation} hold. Let us take $a = \frac{\probavailable}{2 \omega + 1} ,$ $b = \frac{\probpage \probavailable}{2 - \probavailable},$ probability $\probpage \in (0, 1]$,
  $$\gamma \leq \left(L + \sqrt{\frac{48 \omega (2 \omega + 1)}{n \probavailable^2} \left(\widehat{L}^2 + \frac{(1 - \probpage)L_{\max}^2}{B}\right) + \frac{16}{n \probavailable^2 \probpage} \left(\left(1 - \frac{\probpairaa}{\probavailable}\right)\widehat{L}^2 + \frac{(1 - \probpage)L_{\max}^2}{B}\right)}\right)^{-1}$$
  and $g^{0}_i = h^{0}_i = \nabla f_i(x^0)$ for all $i \in [n]$ in Algorithm~\ref{alg:main_algorithm} \algname{(DASHA-PP-PAGE)}
  then
  \begin{align*}
    &\Exp{\norm{\nabla f(\widehat{x}^T)}^2} \leq \frac{1}{T}\vast[2 \left(f(x^0) - f^*\right) \times \\
    & \left(L + \sqrt{\frac{48 \omega (2 \omega + 1)}{n \probavailable^2} \left(\widehat{L}^2 + \frac{(1 - \probpage)L_{\max}^2}{B}\right) + \frac{16}{n \probavailable^2 \probpage} \left(\left(1 - \frac{\probpairaa}{\probavailable}\right)\widehat{L}^2 + \frac{(1 - \probpage)L_{\max}^2}{B}\right)}\right)\vast].
  \end{align*}
\end{restatable}

% Let us simplify the statement of Theorem~\ref{theorem:page} by choosing particular parameters.
We now choose $\probpage$ to balance heavy full gradient and light mini-batch calculations.
\begin{restatable}{corollary}{COROLLARYPAGE}
    \label{cor:mini_batch_oracle}
Let the assumptions from Theorem~\ref{theorem:page} hold and $\probpage = \nicefrac{B}{(m + B)}.$ 
Then \algname{DASHA-PP-PAGE}
    needs 
    % \begin{align}
    %   \label{eq:rate_dasha_pp_page}
    %   \cO\left(\frac{1}{\varepsilon}\left[L + \frac{1}{\probavailable}\left(\frac{\omega}{\sqrt{n}} + \sqrt{\frac{m}{n B}}\right)\widehat{L} + \frac{1}{\probavailable}\left(\frac{\omega}{\sqrt{n}} + \sqrt{\frac{m}{n B}}\right)\frac{L_{\max}}{\sqrt{B}}\right]\right)
    % \end{align}
    \begin{align}
      \label{eq:rate_dasha_pp_page}
      \cO\left(\frac{1}{\varepsilon}\left[L + \frac{\omega}{\probavailable\sqrt{n}}\left(\widehat{L} + \frac{L_{\max}}{\sqrt{B}}\right) + \frac{1}{\probavailable}\sqrt{\frac{m}{n}}\left(\frac{\widehat{L}}{\sqrt{B}} + \frac{L_{\max}}{B}\right)\right]\right)
    \end{align}
    communication rounds to get an $\varepsilon$-solution and the expected \# of gradient calculations per node equals $\cO\left(m + B T\right).$
\end{restatable}
\alexander{TODO: Prove it!}

The convergence rate the rate of the current state-of-the-art method \algname{DASHA-PAGE} without partial participation equals
$\cO\left(\frac{1}{\varepsilon}\left[L + \frac{\omega}{\sqrt{n}}\left(\widehat{L} + \frac{L_{\max}}{\sqrt{B}}\right) + \sqrt{\frac{m}{n}}\frac{L_{\max}}{B}\right]\right).$ Let us closer compare it with \eqref{eq:rate_dasha_pp_page}. As expected, we see that the second term w.r.t. $\omega$ degenerates up to $\nicefrac{1}{\probavailable}$. Surprisingly, the third term w.r.t. $\sqrt{\nicefrac{m}{n}}$ can degenerate up to $\nicefrac{\sqrt{B}}{\probavailable}$ when $\widehat{L} \approx L_{\max}.$ Hence, in order to keep degeneration up to $\nicefrac{1}{\probavailable},$ one should take the batch size $B = \cO\left(\nicefrac{L_{\max}^2}{\widehat{L}^2}\right).$ This interesting effect we analyze separately in Section~\ref{sec:partial_participation_sampling}.

It is left to provide the convergence rate of \algname{DASHA-PP-FINITE-MVR}. The conclusions would be the same.
\begin{restatable}{theorem}{CONVERGENCEFINITEMVR}
  \label{theorem:finitemvr}
  Suppose that Assumptions \ref{ass:lower_bound}, \ref{ass:lipschitz_constant}, \ref{ass:nodes_lipschitz_constant}, \ref{ass:max_lipschitz_constant}, \ref{ass:compressors}, and \ref{ass:partial_participation} hold. Let us take $a = \frac{\probavailable}{2 \omega + 1} ,$ $b = \frac{\frac{\probavailable B}{m}}{2 - \frac{\probavailable B}{m}},$
  $$\gamma \leq \left(L + \sqrt{\frac{148 \omega (2 \omega + 1)}{n \probavailable^2} \left(\widehat{L}^2 + \frac{L_{\max}^2}{B}\right) + \frac{72 m}{n \probavailable^2 B}\left(\left(1 - \frac{\probpairaa}{\probavailable}\right)\widehat{L}^2 + \frac{L_{\max}^2}{B}\right)}\right)^{-1},$$
  $g^{0}_i = h^{0}_i = \nabla f_i(x^0)$ for all $i \in [n]$ and $h^{0}_{ij} = \nabla f_{ij}(x^0)$ for all $i \in [n], j \in [m]$ in Algorithm~\ref{alg:main_algorithm} \algname{(DASHA-PP-FINITE-MVR)}
  then
  \begin{align*}
    &\Exp{\norm{\nabla f(\widehat{x}^T)}^2} \leq \frac{1}{T}\vast[2 \left(f(x^0) - f^*\right) \times \\
    & \left(L + \sqrt{\frac{148 \omega (2 \omega + 1)}{n \probavailable^2} \left(\widehat{L}^2 + \frac{L_{\max}^2}{B}\right) + \frac{72 m}{n \probavailable^2 B}\left(\left(1 - \frac{\probpairaa}{\probavailable}\right)\widehat{L}^2 + \frac{L_{\max}^2}{B}\right)}\right)\vast].
  \end{align*}
\end{restatable}

\subsection{Stochastic setting}

\label{sec:stochastic_setting}

We define $h^t \eqdef \frac{1}{n}\sum_{i=1}^n h^t_i$.

\begin{restatable}{theorem}{CONVERGENCEMVR}
  \label{theorem:stochastic}
  Suppose that Assumptions \ref{ass:lower_bound}, \ref{ass:lipschitz_constant}, \ref{ass:nodes_lipschitz_constant}, \ref{ass:stochastic_unbiased_and_variance_bounded}, \ref{ass:mean_square_smoothness}, \ref{ass:compressors} and \ref{ass:partial_participation} hold. Let us take $a = \frac{\probavailable}{2\omega + 1}$, $b~\in~\left(0, \frac{\probavailable}{2 - \probavailable}\right]$, 
  $$\gamma \leq \left(L + \sqrt{\frac{48 \omega (2 \omega + 1)}{n \probavailable^2} \left(\widehat{L}^2 + \frac{(1 - b)^2 L_{\sigma}^2}{B}\right) + \frac{12}{n \probavailable b}\left(\left(1 - \frac{\probpairaa}{\probavailable}\right) \widehat{L}^2 + \frac{(1 - b)^2 L_{\sigma}^2}{B}\right)}\right)^{-1},$$
  and $g^{0}_i = h^{0}_i$ for all $i \in [n]$
  in Algorithm~\ref{alg:main_algorithm} \algname{(DASHA-PP-MVR)}.
  Then 
  \begin{align*}
    &\Exp{\norm{\nabla f(\widehat{x}^T)}^2} \leq \frac{1}{T}\vast[2 \left(f(x^0) - f^*\right) \\
    &\times \left(L + \sqrt{\frac{48 \omega (2 \omega + 1)}{n \probavailable^2} \left(\widehat{L}^2 + \frac{(1 - b)^2 L_{\sigma}^2}{B}\right) + \frac{12}{n \probavailable b}\left(\left(1 - \frac{\probpairaa}{\probavailable}\right) \widehat{L}^2 + \frac{(1 - b)^2 L_{\sigma}^2}{B} \right)}\right)\\
    &+ \frac{2}{b} \norm{h^{0} - \nabla f(x^{0})}^2 + \left(\frac{32 b \omega (2 \omega + 1)}{n \probavailable^2} + \frac{4 \left(1 - \frac{\probpairaa}{\probavailable}\right)}{n \probavailable}\right)\left(\frac{1}{n}\sum_{i=1}^n\norm{h^{0}_i - \nabla f_i(x^{0})}^2\right)\vast] \\
    &+ \left(\frac{48 b^2 \omega (2 \omega + 1)}{\probavailable^2} + \frac{12 b}{\probavailable}\right) \frac{\sigma^2}{n B}.
\end{align*}
\end{restatable}

In the next corollary, we choose momentum $b$ and initialize vectors $h^{0}_i$ to get $\varepsilon$-solution.

\begin{restatable}{corollary}{COROLLARYSTOCHASTIC}
  \label{cor:stochastic}
  Suppose that assumptions from Theorem~\ref{theorem:stochastic} hold, momentum $b = \Theta\left(\min \left\{\ \frac{\probavailable}{\omega}\sqrt{\frac{n \varepsilon B}{\sigma^2}}, \frac{\probavailable n \varepsilon B}{\sigma^2}\right\}\right),$ 
  and $h^{0}_i = \frac{1}{B_{\textnormal{init}}} \sum_{k = 1}^{B_{\textnormal{init}}} \nabla f_i(x^0; \xi^0_{ik})$ for all $i \in [n],$ and batch size $B_{\textnormal{init}} = \Theta\left(\nicefrac{B}{b}\right),$ then Algorithm~\ref{alg:main_algorithm} \algname{(DASHA-PP-MVR)} needs
  $$\cO\left(\frac{1}{\varepsilon}\left[L + \frac{\omega}{\probavailable\sqrt{n}}\left(\widehat{L} + \frac{L_{\sigma}}{\sqrt{B}}\right) + \frac{\sigma}{\probavailable \sqrt{n \varepsilon}}\left(\frac{\widehat{L}}{\sqrt{B}} + \frac{L_\sigma}{B}\right)\right] + \frac{\sigma^2}{\probavailable n \varepsilon B}\right)$$
  communication rounds to get an $\varepsilon$-solution and the number of stochastic gradient calculations per node equals $\cO(B_{\textnormal{init}} + BT).$
\end{restatable}

\alexander{TODO: Prove it!}

The convergence rate of the \algname{DASHA-SYNC-MVR}, the state-of-the-art method without partial participation, equals $\cO\left(\frac{1}{\varepsilon}\left[L + \frac{\omega}{\sqrt{n}}\left(\widehat{L} + \frac{L_{\sigma}}{\sqrt{B}}\right) + \frac{\sigma}{\sqrt{n \varepsilon}}\frac{L_\sigma}{B}\right] + \frac{\sigma^2}{\probavailable n \varepsilon B}\right).$ Similar to Section~\ref{sec:finite_sum_setting}, we see that in the regimes when $\widehat{L} \approx L_{\max}$ the third term w.r.t. $\nicefrac{1}{\varepsilon^{3/2}}$ can degenerate up to $\nicefrac{\sqrt{B}}{\probavailable}.$ However, if we take $B = \cO\left(\nicefrac{L_{\sigma}^2}{\widehat{L}^2}\right),$ then the degeneration of the third term will be up to $\nicefrac{1}{\probavailable}.$ This effect we analyze in Section~\ref{sec:partial_participation_sampling}.

Another important difference is batch size $B_{\textnormal{init}}.$ In \algname{DASHA-SYNC-MVR}, batch size $B_{\textnormal{init}} = \Theta\left(\max\left\{\frac{\sigma^2}{n \varepsilon}, B \omega\right\}\right).$ The same as \algname{DASHA-MVR}, method \algname{DASHA-PP-MVR} does not send full vectors and gets suboptimal initial batch size $B_{\textnormal{init}} = \Theta\left(\max\left\{\frac{\sigma^2}{\probavailable n \varepsilon}, \frac{B \omega}{\probavailable} \sqrt{\frac{\sigma^2}{n \varepsilon B}}\right\}\right).$ In the regimes when $\varepsilon$ is small and the first terms dominate in maximums, the degeneration of the batch size $B_{\textnormal{init}}$ is up to $\nicefrac{1}{\probavailable}.$ However, the degeneration can be higher in other regimes due to the additional multiplicative term $\sqrt{\frac{\sigma^2}{n \varepsilon B}}.$
We believe that this is the price for not sending the full vectors and no synchronization in the stochastic setting and should be investigated further.

\section{The problem of estimating the mean in partial participation}
\label{sec:partial_participation_sampling}

% In Sections~\ref{sec:finite_sum_setting} and \ref{sec:stochastic_setting}, when we compare 
Let us consider the task of estimating the mean of vectors in the distributed setting. Suppose that we have $n$ nodes, and each of them contains $m$ vectors $\{x_{ij}\}_{j=1}^m$, where $x_{ij} \in \R^d$ for all $i \in [n], j \in [m].$ First, let us consider that each node samples a mini-batch $I^i$ of size $B$ with replacement and sends it to the server. Then the server calculates the mean of the mini-batches from nodes. One can easily show that the variance of the estimator is
\begin{align}
  \label{eq:partial_participation_sampling:all_nodes}
  \Exp{\norm{\frac{1}{n B}\sum_{i=1}^n \sum_{j \in I^i} x_{ij} - \frac{1}{n m}\sum_{i=1}^n \sum_{j=1}^m x_{ij}}^2} = \frac{1}{n B} \frac{1}{n m} \sum_{i=1}^n \sum_{j=1}^m \norm{x_{ij} - \frac{1}{m}\sum_{j=1}^m x_{ij}}^2.
\end{align}
Next, we consider the same task in the partial participation setting, i.e., we sample a random set $S \subset [n]$ of $s \in [n]$ nodes without replacement and receive the mini-batches only from sampled nodes. Such sampling of nodes satisfy Assumption~\ref{ass:partial_participation} with $\probavailable = \frac{s}{n}$ and $\probavailable = \frac{s (s-1)}{n (n-1)}$. In this case, the variance of the estimator is (see Lemma~\ref{lemma:sampling} with $r_i = 0$ and $s_i = \sum_{j \in I^i} x_{ij}$)
\begin{align}
  \Exp{\norm{\frac{1}{s B}\sum_{i \in S} \sum_{j \in I^i} x_{ij} - \frac{1}{n m}\sum_{i=1}^n \sum_{j=1}^m x_{ij}}^2} &= \frac{1}{s B}\underbrace{\frac{1}{n m} \sum_{i=1}^n \sum_{j=1}^m \norm{x_{ij} - \frac{1}{m}\sum_{j=1}^m x_{ij}}^2}_{\mathcal{L}_{\max}^2} \\
  &+\frac{n - s}{s (n - 1)} \underbrace{\frac{1}{n} \sum_{i=1}^n \norm{\frac{1}{m}\sum_{j=1}^m x_{ij} - \frac{1}{n m}\sum_{i=1}^n \sum_{j=1}^m x_{ij}}^2}_{\widehat{\mathcal{L}}^2} \label{eq:partial_participation_sampling:s_nodes}.
\end{align}
Let us assume that $s \leq \nicefrac{n}{2}.$ Note that \eqref{eq:partial_participation_sampling:all_nodes} scales with any $B \geq 1,$ while \eqref{eq:partial_participation_sampling:s_nodes} only scales when $B = \cO\left(\nicefrac{\mathcal{L}_{\max}^2}{\widehat{\mathcal{L}}^2}\right).$ We provide this example to explain why the only choice of $B = \cO\left(\nicefrac{L_{\max}^2}{\widehat{L}^2}\right)$ and $B = \cO\left(\nicefrac{L_{\sigma}^2}{\widehat{L}^2}\right)$ in \algname{DASHA-PP-PAGE} and \algname{DASHA-PP-MVR}, accordingly, guarantees the degeneration up to $\nicefrac{1}{\probavailable}.$
% And taking batch size $B$ larger than 

\section{Experiments}

\newpage
\appendix
\tableofcontents

\section{Auxiliary facts}
We list auxiliary facts that we use in our proofs:
\begin{enumerate}
    \item 
        For all $x, y \in \R^d,$ we have
        \begin{align}
            \norm{x + y}^2 \leq 2\norm{x}^2 + 2\norm{y}^2
            \label{auxiliary:jensen_inequality}
        \end{align}
    \item
        Let us take a \textit{random vector} $\xi \in \R^d$, then
        \begin{align}
            \Exp{\norm{\xi}^2} = \Exp{\norm{\xi - \Exp{\xi}}^2} + \norm{\Exp{\xi}}^2.
            \label{auxiliary:variance_decomposition}
        \end{align}
\end{enumerate}

\subsection{Sampling lemma}
This section provides a lemma that we regularly use in our proofs, and it is useful for samplings that satisfy Assumption~\ref{ass:partial_participation}.
\begin{lemma}
  \label{lemma:sampling}
  Suppose that a set $S$ is a random subset of a set $[n]$ such that
  \begin{enumerate}
    \Item \begin{align*}\Prob\left(i \in S\right) = \probavailable, \quad \forall i \in [n],\end{align*}
    \Item \begin{align*}\Prob\left(i \in S, j \in S\right) = \probpairaa, \quad \forall i \neq j \in [n],\end{align*}
    \Item \begin{align*}
      \probpairaa \leq \probavailable^2,
    \end{align*}
  \end{enumerate}
  where $\probavailable \in (0, 1]$ and $\probpairaa \in [0, 1].$ Let us take random \textit{independent} vectors $s_i \in \R^d$ for all $i \in [n]$, nonrandom vector $r_i \in \R^d$ for all $i \in [n],$ and random vectors
  \begin{align*}
    v_i = \begin{cases}
      r_i + \frac{1}{\probavailable} s_i, i \in S, \\
      r_i, i \not\in S,
    \end{cases}
  \end{align*}
  then
  \begin{align*}
    &\Exp{\norm{\frac{1}{n}\sum_{i=1}^n v_i - \Exp{\frac{1}{n}\sum_{i=1}^n v_i}}^2} \\
    &= \frac{1}{n^2 \probavailable}\sum_{i=1}^n\Exp{\norm{s_i - \Exp{s_i}}^2} +\frac{\probavailable - \probpairaa}{n^2 \probavailable^2}\sum_{i=1}^n\norm{\Exp{s_i}}^2 + \frac{\probpairaa - \probavailable^2}{\probavailable^2}\norm{\frac{1}{n}\sum_{i=1}^n\Exp{s_i}}\\
    &\leq \frac{1}{n^2 \probavailable}\sum_{i=1}^n\Exp{\norm{s_i - \Exp{s_i}}^2} +\frac{\probavailable - \probpairaa}{n^2 \probavailable^2}\sum_{i=1}^n\norm{\Exp{s_i}}^2.
  \end{align*}
\end{lemma}

\begin{proof}
  Let us define additional constants $\probpairan$ and $\probpairnn$, such that
  \begin{enumerate}
    \Item \begin{align*}\Prob\left(i \in S, j \not\in S\right) = \probpairan, \quad \forall i \neq j \in [n],\end{align*}
    \Item \begin{align*}\Prob\left(i \not\in S, j \not\in S\right) = \probpairnn, \quad \forall i \neq j \in [n].\end{align*}
  \end{enumerate}
  Note, that 
  \begin{align}
    \label{auxiliary_facts_partial_participation:one}
    \probpairan = \probpairaa - \probavailable
  \end{align}
  and 
  \begin{align}
    \label{auxiliary_facts_partial_participation:two}
    \probpairnn = 1 - \probpairaa - 2 \probpairan.
  \end{align}
  Using the law of total expectation and 
  \begin{align*}
    \Exp{v_i} = \probavailable \left(r_i + \Exp{\frac{1}{\probavailable} s_i}\right) + (1 - \probavailable) r_i = r_i + \Exp{s_i},
  \end{align*}
  we have
  \begin{align*}
    &\Exp{\norm{\frac{1}{n}\sum_{i=1}^n v_i - \Exp{\frac{1}{n}\sum_{i=1}^n v_i}}^2} \\
    &=\frac{1}{n^2}\sum_{i=1}^n\Exp{\norm{v_i - \left(r_i + \Exp{s_i}\right)}^2} \\
    &\quad +\frac{1}{n^2}\sum_{i\neq j}^n\Exp{\inp{v_i - \left(r_i + \Exp{s_i}\right)}{v_j - \left(r_j + \Exp{s_j}\right)}} \\
    &=\frac{\probavailable}{n^2}\sum_{i=1}^n\Exp{\norm{r_i + \frac{1}{\probavailable} s_i - \left(r_i + \Exp{s_i}\right)}^2} \\
    &\quad +\frac{1 - \probavailable}{n^2}\sum_{i=1}^n\norm{r_i - \left(r_i + \Exp{s_i}\right)}^2 \\
    &\quad +\frac{\probpairaa}{n^2}\sum_{i\neq j}^n\Exp{\inp{r_i + \frac{1}{\probavailable} s_i - \left(r_i + \Exp{s_i}\right)}{r_j + \frac{1}{\probavailable} s_j - \left(r_j + \Exp{s_j}\right)}} \\
    &\quad +\frac{2 \probpairan}{n^2}\sum_{i\neq j}^n\Exp{\inp{r_i + \frac{1}{\probavailable} s_i - \left(r_i + \Exp{s_i}\right)}{r_j - \left(r_j + \Exp{s_j}\right)}} \\
    &\quad +\frac{\probpairnn}{n^2}\sum_{i\neq j}^n\inp{r_i - \left(r_i + \Exp{s_i}\right)}{r_j - \left(r_j + \Exp{s_j}\right)}.
  \end{align*}
  From the independence of random vectors $s_i$, we obtain
  \begin{align*}
    &\Exp{\norm{\frac{1}{n}\sum_{i=1}^n v_i - \Exp{\frac{1}{n}\sum_{i=1}^n v_i}}^2} \\
    &=\frac{\probavailable}{n^2}\sum_{i=1}^n\Exp{\norm{\frac{1}{\probavailable} s_i - \Exp{s_i}}^2} \\
    &\quad +\frac{1 - \probavailable}{n^2}\sum_{i=1}^n\norm{\Exp{s_i}}^2 \\
    &\quad +\frac{\probpairaa (1 - \probavailable)^2}{n^2 \probavailable^2}\sum_{i\neq j}^n\inp{\Exp{s_i}}{\Exp{s_j}} \\
    &\quad +\frac{2 \probpairan (\probavailable - 1)}{n^2 \probavailable}\sum_{i\neq j}^n\inp{\Exp{s_i}}{\Exp{s_j}} \\
    &\quad +\frac{\probpairnn}{n^2}\sum_{i\neq j}^n\inp{\Exp{s_i}}{\Exp{s_j}}.
  \end{align*}
  Using \eqref{auxiliary_facts_partial_participation:one} and \eqref{auxiliary_facts_partial_participation:two}, we have
  \begin{align*}
    &\Exp{\norm{\frac{1}{n}\sum_{i=1}^n v_i - \Exp{\frac{1}{n}\sum_{i=1}^n v_i}}^2} \\
    &=\frac{\probavailable}{n^2}\sum_{i=1}^n\Exp{\norm{\frac{1}{\probavailable} s_i - \Exp{s_i}}^2} \\
    &\quad +\frac{1 - \probavailable}{n^2}\sum_{i=1}^n\norm{\Exp{s_i}}^2 \\
    &\quad +\frac{\probpairaa - \probavailable^2}{n^2 \probavailable^2}\sum_{i\neq j}^n\inp{\Exp{s_i}}{\Exp{s_j}} \\
    &\overset{\eqref{auxiliary:variance_decomposition}}{=}\frac{1}{n^2 \probavailable}\sum_{i=1}^n\Exp{\norm{s_i - \Exp{s_i}}^2} \\
    &\quad +\frac{1 - \probavailable}{n^2 \probavailable}\sum_{i=1}^n\norm{\Exp{s_i}}^2 \\
    &\quad +\frac{\probpairaa - \probavailable^2}{n^2 \probavailable^2}\sum_{i\neq j}^n\inp{\Exp{s_i}}{\Exp{s_j}} \\
    &=\frac{1}{n^2 \probavailable}\sum_{i=1}^n\Exp{\norm{s_i - \Exp{s_i}}^2} \\
    &\quad +\frac{\probavailable - \probpairaa}{n^2 \probavailable^2}\sum_{i=1}^n\norm{\Exp{s_i}}^2 \\
    &\quad +\frac{\probpairaa - \probavailable^2}{\probavailable^2}\norm{\frac{1}{n}\sum_{i=1}^n\Exp{s_i}}.
  \end{align*}
  Finally, using that $\probpairaa \leq \probavailable^2$, we have
  \begin{align*}
    &\Exp{\norm{\frac{1}{n}\sum_{i=1}^n v_i - \Exp{\frac{1}{n}\sum_{i=1}^n v_i}}^2} \\
    &\leq\frac{1}{n^2 \probavailable}\sum_{i=1}^n\Exp{\norm{s_i - \Exp{s_i}}^2} +\frac{\probavailable - \probpairaa}{n^2 \probavailable^2}\sum_{i=1}^n\norm{\Exp{s_i}}^2.
  \end{align*}
\end{proof}

\section{Proofs of theorems}

There are three different sources of randomness in Algorithm~\ref{alg:main_algorithm}: the first one from vectors $\{k_i^{t+1}\}_{i=1}^n$, the second one from compressors $\{\cC_i\}_{i=1}^n$, and the third one from availability of nodes. We define $\ExpSub{k}{\cdot}$, $\ExpSub{\cC}{\cdot}$ and $\ExpSub{\probavailable}{\cdot}$ to be conditional expectations w.r.t.\,$\{k_i^{t+1}\}_{i=1}^n$, $\{\cC_i\}_{i=1}^n, $ and availability, accordingly, conditioned on all previous randomness. Moreover, we define $\ExpSub{t+1}{\cdot}$ to be a conditional expectation w.r.t. all randomness in iteration $t+1$ conditioned on all previous randomness. Note, that $\ExpSub{t+1}{\cdot} = \ExpSub{k}{\ExpSub{\cC}{\ExpSub{\probavailable}{\cdot}}}.$

In the case of \algname{DASHA-PP-PAGE}, there are two different sources of randomness from $\{k_i^{t+1}\}_{i=1}^n$. We define $\ExpSub{\probpage}{\cdot}$ and $\ExpSub{B}{\cdot}$ to be conditional expectations w.r.t.\, the probabilistic switching and mini-batch indices $I_{i}^t$, accordingly, conditioned on all previous randomness. Note, that $\ExpSub{t+1}{\cdot} = \ExpSub{B}{\ExpSub{\cC}{\ExpSub{\probavailable}{\ExpSub{\probpage}{\cdot}}}}$ and $\ExpSub{t+1}{\cdot} = \ExpSub{B}{\ExpSub{\probpage}{\ExpSub{\cC}{\ExpSub{\probavailable}{\cdot}}}}.$

\subsection{Standard lemmas in the nonconvex setting}

We start the proof of theorems by providing standard lemmas from the nonconvex optimization.

\begin{lemma}
  \label{lemma:page_lemma}
  Suppose that Assumption~\ref{ass:lipschitz_constant} holds and let $x^{t+1} = x^{t} - \gamma g^{t}$. Then for any $g^{t} \in \R^d$ and $\gamma > 0$, we have
  \begin{eqnarray}
    \label{eq:page_lemma}
    f(x^{t + 1}) \leq f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
    \norm{x^{t+1} - x^t}^2 + \frac{\gamma}{2}\norm{g^{t} - \nabla f(x^t)}^2.
  \end{eqnarray}
\end{lemma}

The proof of Lemma \ref{lemma:page_lemma} is provided in \cite{PAGE}.

\begin{lemma}
  \label{lemma:good_recursion}
  Suppose that Assumption \ref{ass:lower_bound} holds and
  \begin{align*}
      \Exp{f(x^{t+1})} + \gamma \Psi^{t+1} \leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} + \gamma \Psi^{t} + \gamma C,
  \end{align*}
  where $\Psi^{t}$ is a sequence of numbers, $\Psi^{t} \geq 0$ for all $t \in [T]$, constant $C \geq 0$, and constant $\gamma > 0.$ Then 
  \begin{align}
      \label{eq:good_recursion}
      \Exp{\norm{\nabla f(\widehat{x}^T)}^2} \leq \frac{2 \left(f(x^0) - f^*\right)}{\gamma T} + \frac{2\Psi^{0}}{T} + 2 C,
  \end{align}
  where a point $\widehat{x}^T$ is chosen uniformly from a set of points $\{x^t\}_{t=0}^{T-1}.$
\end{lemma}

\begin{proof}
  By unrolling \eqref{eq:good_recursion} for $t$ from $0$ to $T - 1$, we obtain
  \begin{align*}
      \frac{\gamma}{2}\sum_{t = 0}^{T - 1}\Exp{\norm{\nabla f(x^t)}^2} + \Exp{f(x^{T})} + \gamma \Psi^{T} \leq f(x^0) + \gamma \Psi^{0} + \gamma T C.
  \end{align*}
  We subtract $f^*$, divide inequality by $\frac{\gamma T}{2},$ and take into account that $f(x) \geq f^*$ for all $x \in \R$, and $\Psi^{t} \geq 0$ for all $t \in [T],$ to get the following inequality:
  \begin{align*}
      \frac{1}{T}\sum_{t = 0}^{T - 1}\Exp{\norm{\nabla f(x^t)}^2} \leq \frac{2 \left(f(x^0) - f^*\right)}{\gamma T} + \frac{2\Psi^{0}}{T} + 2 C.
  \end{align*}
  It is left to consider the choice of a point $\widehat{x}^T$ to complete the proof of the lemma.
\end{proof}

\begin{lemma}
  \label{lemma:gamma}
  If $0 < \gamma \leq (L + \sqrt{A})^{-1},$ $L > 0$, and $A \geq 0,$ then $$\frac{1}{2\gamma} - \frac{L}{2} - \frac{\gamma A}{2} \geq 0.$$
\end{lemma}
The lemma can be easily checked with the direct calculation.

\subsection{Generic lemmas}
\begin{lemma}
  Suppose that Assumptions~\ref{ass:compressors} and \ref{ass:partial_participation} hold and let us consider sequences $g^{t+1}_i$, $h^{t+1}_i,$ and $k^{t+1}_i$ from Algorithm~\ref{alg:main_algorithm}, then
  \begin{align}
      \label{eq:compressor_global_error}
      &\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1} - h^{t+1}}^2}} \nonumber \\
      &\leq \frac{2 \omega}{n^2 \probavailable}\sum_{i=1}^n\norm{k^{t+1}_i}^2 +\frac{a^2 (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n^2 \probavailable^2}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2 + (1 - a)^2\norm{g^{t} - h^{t}}^2,
  \end{align}
  and
  \begin{align}
      \label{eq:compressor_local_error}
      &\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1}_i - h^{t+1}_i}^2}} \nonumber \\
      &\leq \frac{2 \omega}{\probavailable}\norm{k^{t+1}_i}^2 + \left(\frac{a^2(2\omega + 1 - \probavailable)}{\probavailable} + (1 - a)^2\right)\norm{g^{t}_i - h^{t}_i}^2\quad \forall i \in [n].
  \end{align}
\end{lemma}
\begin{proof}
  First, we estimate $\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1} - h^{t+1}}^2}}$:
  \begin{align*}
      &\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1} - h^{t+1}}^2}} \\
      &=\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1} - h^{t+1} - \ExpSub{\cC}{\ExpSub{\probavailable}{g^{t+1} - h^{t+1}}}}^2}} + \norm{\ExpSub{\cC}{\ExpSub{\probavailable}{g^{t+1} - h^{t+1}}}}^2,
  \end{align*}
  where we used \eqref{auxiliary:variance_decomposition}.
  Due to Assumption~\ref{ass:partial_participation}, we have
  \begin{align*}
      &\ExpSub{\cC}{\ExpSub{\probavailable}{g^{t+1}_i}} \\
      &=\probavailable \ExpSub{\cC}{g^{t}_i + \cC_i\Bigg(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\Bigg)} + (1 - \probavailable) g^{t}_i \\
      &=g^{t}_i  + \probavailable\ExpSub{\cC}{\cC_i\Bigg(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\Bigg)} \\
      &=g^{t}_i  + k^{t+1}_i - a \left(g^{t}_i - h^{t}_i\right), \\
  \end{align*}
  and 
  \begin{align*}
      &\ExpSub{\cC}{\ExpSub{\probavailable}{h^{t+1}_i}} = \probavailable \ExpSub{\cC}{h^t_i + \frac{1}{\probavailable}k^{t+1}_i} + (1 - \probavailable) h^{t}_i = h^{t}_i + k^{t+1}_i. \\
  \end{align*}
  Thus, we can get
  \begin{align*}
      &\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1} - h^{t+1}}^2}} \\
      &=\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1} - h^{t+1} - \ExpSub{\cC}{\ExpSub{\probavailable}{g^{t+1} - h^{t+1}}}}^2}} + (1 - a)^2\norm{g^{t} - h^{t}}^2.
  \end{align*}
  Due to the independence of comcpressors, we can use Lemma~\ref{lemma:sampling} with $r_i = g^{t}_i - h^{t}_i$ and $s_i = \probavailable\cC_i\Bigg(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\Bigg) - k^{t+1}_i,$ and obtain
  \begin{align*}
    &\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1} - h^{t+1}}^2}} \\
    &\leq \frac{1}{n^2 \probavailable}\sum_{i=1}^n\ExpSub{\cC}{\norm{\probavailable\cC_i\Bigg(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\Bigg) - k^{t+1}_i - \ExpSub{\cC}{\probavailable\cC_i\Bigg(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\Bigg) - k^{t+1}_i}}^2} \\
    &\quad +\frac{\probavailable - \probpairaa}{n^2 \probavailable^2}\sum_{i=1}^n\norm{\ExpSub{\cC}{\probavailable\cC_i\Bigg(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\Bigg) - k^{t+1}_i}}^2 \\
    &\quad + (1 - a)^2\norm{g^{t} - h^{t}}^2 \\
    &= \frac{\probavailable}{n^2}\sum_{i=1}^n\ExpSub{\cC}{\norm{\cC_i\Bigg(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\Bigg) - \Bigg(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\Bigg)}^2} \\
    &\quad +\frac{a^2 \left(\probavailable - \probpairaa\right)}{n^2 \probavailable^2}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2 + (1 - a)^2\norm{g^{t} - h^{t}}^2.
  \end{align*}
  From Assumption~\ref{ass:compressors}, we have
  \begin{align*}
    &\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1} - h^{t+1}}^2}} \\
    &\leq \frac{\omega \probavailable}{n^2}\sum_{i=1}^n\norm{\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)}^2 +\frac{a^2 \left(\probavailable - \probpairaa\right)}{n^2 \probavailable^2}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2 + (1 - a)^2\norm{g^{t} - h^{t}}^2 \\
    &= \frac{\omega}{n^2 \probavailable}\sum_{i=1}^n\norm{k^{t+1}_i - a \left(g^{t}_i - h^{t}_i\right)}^2 +\frac{a^2 \left(\probavailable - \probpairaa\right)}{n^2 \probavailable^2}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2 + (1 - a)^2\norm{g^{t} - h^{t}}^2 \\
    &\overset{\eqref{auxiliary:jensen_inequality}}{\leq} \frac{2 \omega}{n^2 \probavailable}\sum_{i=1}^n\norm{k^{t+1}_i}^2 +\frac{a^2 \left((2\omega + 1)\probavailable - \probpairaa\right)}{n^2 \probavailable^2}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2 + (1 - a)^2\norm{g^{t} - h^{t}}^2.
  \end{align*}
  The second inequality can be proved almost in the same way:
  \begin{align*}
    &\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1}_i - h^{t+1}_i}^2}} \\
    &=\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1}_i - h^{t+1}_i - \ExpSub{\cC}{\ExpSub{\probavailable}{g^{t+1}_i - h^{t+1}_i}}}^2}} + \norm{\ExpSub{\cC}{\ExpSub{\probavailable}{g^{t+1}_i - h^{t+1}_i}}}^2 \\
    &=\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1}_i - h^{t+1}_i - g^{t}_i + a \left(g^{t}_i - h^{t}_i\right) + h^{t}_i}^2}} + (1 - a)^2\norm{g^{t}_i - h^{t}_i}^2 \\
    &=\probavailable\ExpSub{\cC}{\norm{\cC_i\Bigg(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\Bigg) - \frac{1}{\probavailable}k^{t+1}_i + a \left(g^{t}_i - h^{t}_i\right)}^2} \\
    &\quad + a^2(1 - \probavailable)\norm{g^{t}_i - h^{t}_i}^2 + (1 - a)^2\norm{g^{t}_i - h^{t}_i}^2 \\
    &\overset{\eqref{auxiliary:variance_decomposition}}{=}\probavailable\ExpSub{\cC}{\norm{\cC_i\Bigg(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\Bigg) - \left(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\right)}^2} \\
    &\quad + a^2 \frac{(1 - \probavailable)^2}{\probavailable} \norm{g^{t}_i - h^{t}_i}^2 \\
    &\quad + a^2(1 - \probavailable)\norm{g^{t}_i - h^{t}_i}^2 + (1 - a)^2\norm{g^{t}_i - h^{t}_i}^2 \\
    &\leq \frac{\omega}{\probavailable}\norm{k^{t+1}_i - a \left(g^{t}_i - h^{t}_i\right)}^2 \\
    &\quad + \frac{a^2(1 - \probavailable)}{\probavailable} \norm{g^{t}_i - h^{t}_i}^2 + (1 - a)^2\norm{g^{t}_i - h^{t}_i}^2 \\
    &\overset{\eqref{auxiliary:jensen_inequality}}{\leq} \frac{2 \omega}{\probavailable}\norm{k^{t+1}_i}^2 + \frac{a^2(2\omega + 1 - \probavailable)}{\probavailable} \norm{g^{t}_i - h^{t}_i}^2 + (1 - a)^2\norm{g^{t}_i - h^{t}_i}^2.
  \end{align*}
\end{proof}

\begin{lemma}
  \label{lemma:main_lemma}
  Suppose that Assumptions \ref{ass:lipschitz_constant}, \ref{ass:compressors}, and \ref{ass:partial_participation} hold and let us take $a = \frac{\probavailable}{2 \omega + 1},$ then
  \begin{align*}
    &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
    &\leq \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
    \norm{x^{t+1} - x^t}^2 + \gamma \norm{h^{t} - \nabla f(x^t)}^2}\nonumber\\
    &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable}\Exp{\norm{g^{t} - h^t}^2}+ \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2}\Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2} + \frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \Exp{\frac{1}{n} \sum_{i=1}^n\norm{k^{t+1}_i}^2}.
  \end{align*}
\end{lemma}

\begin{proof}
  Due to Lemma \ref{lemma:page_lemma} and the update step from Line~\ref{alg:main_algorithm:x_update} in Algorithm~\ref{alg:main_algorithm}, we have
  \begin{align*}
    &\ExpSub{t+1}{f(x^{t + 1})} \nonumber\\
    &\leq \ExpSub{t+1}{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
      \norm{x^{t+1} - x^t}^2 + \frac{\gamma}{2}\norm{g^{t} - \nabla f(x^t)}^2} \nonumber \\
      &= \ExpSub{t+1}{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
      \norm{x^{t+1} - x^t}^2 + \frac{\gamma}{2}\norm{g^{t} - h^t + h^t - \nabla f(x^t)}^2} \nonumber \\
      &\overset{\eqref{auxiliary:variance_decomposition}}{\leq} \ExpSub{t+1}{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
      \norm{x^{t+1} - x^t}^2 + \gamma\left(\norm{g^{t} - h^t}^2 + \norm{h^t - \nabla f(x^t)}^2}\right). \nonumber \\
      \nonumber
  \end{align*}
  Let us fix some constants $\kappa, \eta \in [0,\infty)$ that we will define later. Combining the last inequality, bounds \eqref{eq:compressor_global_error}, \eqref{eq:compressor_local_error} and using the law of total expectation, we get
  \begin{align*}
      &\Exp{f(x^{t + 1})} \nonumber \\
      &\quad  + \kappa \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \eta \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2} \nonumber\\
      &=\Exp{\ExpSub{t+1}{f(x^{t + 1})}} \nonumber \\
      &\quad  + \kappa \Exp{\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1} - h^{t+1}}^2}}} + \eta \Exp{\ExpSub{\cC}{\ExpSub{\probavailable}{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}}} \nonumber\\
      &\leq \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
      \norm{x^{t+1} - x^t}^2 + \gamma\left(\norm{g^{t} - h^t}^2 + \norm{h^{t} - \nabla f(x^t)}^2\right)} \nonumber\\
      &\quad +\kappa \Exp{\frac{2 \omega}{n^2 \probavailable}\sum_{i=1}^n\norm{k^{t+1}_i}^2 +\frac{a^2 (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n^2 \probavailable^2}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2 + (1 - a)^2\norm{g^{t} - h^{t}}^2} \nonumber\\
      &\quad +\eta \Exp{\frac{2 \omega}{n \probavailable} \sum_{i=1}^n \norm{k^{t+1}_i}^2 + \left(\frac{a^2(2\omega + 1 - \probavailable)}{\probavailable} + (1 - a)^2\right)\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &= \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
      \norm{x^{t+1} - x^t}^2 + \gamma \norm{h^{t} - \nabla f(x^t)}^2}\nonumber\\
      &\quad + \left(\gamma + \kappa \left(1 - a\right)^2\right)\Exp{\norm{g^{t} - h^t}^2}\nonumber\\
      &\quad + \left(\frac{\kappa a^2 (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} + \eta\left(\frac{a^2(2\omega + 1 - \probavailable)}{\probavailable} + (1 - a)^2\right)\right)\Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2}\nonumber\\
      &\quad + \left(\frac{2 \kappa \omega}{n \probavailable} + \frac{2 \eta \omega}{\probavailable}\right)\Exp{\frac{1}{n} \sum_{i=1}^n\norm{k^{t+1}_i}^2}.
  \end{align*}
  Now, by taking $\kappa = \frac{\gamma}{a}$, we can see that $\gamma + \kappa \left(1 - a\right)^2 \leq \kappa, $ and thus
  \begin{align*}
      &\Exp{f(x^{t + 1})} \\
      &\quad  + \frac{\gamma}{a} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \eta \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\leq \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
      \norm{x^{t+1} - x^t}^2 + \gamma \norm{h^{t} - \nabla f(x^t)}^2}\nonumber\\
      &\quad + \frac{\gamma}{a}\Exp{\norm{g^{t} - h^t}^2}\nonumber\\
      &\quad + \left(\frac{\gamma a (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} + \eta\left(\frac{a^2(2\omega + 1 - \probavailable)}{\probavailable} + (1 - a)^2\right)\right)\Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2}\nonumber\\
      &\quad + \left(\frac{2 \gamma \omega}{a n \probavailable} + \frac{2 \eta \omega}{\probavailable}\right)\Exp{\frac{1}{n} \sum_{i=1}^n\norm{k^{t+1}_i}^2}.
  \end{align*}
  Next, by taking $\eta = \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2}$ and considering the choice of $a$, one can show that $\left(\frac{\gamma a (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} + \eta\left(\frac{a^2(2\omega + 1 - \probavailable)}{\probavailable} + (1 - a)^2\right)\right) \leq \eta.$ Thus

  \begin{align*}
    &\Exp{f(x^{t + 1})} \\
    &\quad  + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
    &\leq \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
    \norm{x^{t+1} - x^t}^2 + \gamma \norm{h^{t} - \nabla f(x^t)}^2}\nonumber\\
    &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable}\Exp{\norm{g^{t} - h^t}^2}+ \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2}\Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2}\nonumber\\
    &\quad + \left(\frac{2 \gamma (2 \omega + 1)\omega}{n \probavailable^2} + \frac{2 \gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa) \omega}{n \probavailable^3}\right)\Exp{\frac{1}{n} \sum_{i=1}^n\norm{k^{t+1}_i}^2}.
  \end{align*}
  Considering that $\probpairaa \geq 0,$ we can simplify the last term and get
  \begin{align*}
    &\Exp{f(x^{t + 1})} \\
    &\quad  + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
    &\leq \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
    \norm{x^{t+1} - x^t}^2 + \gamma \norm{h^{t} - \nabla f(x^t)}^2}\nonumber\\
    &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable}\Exp{\norm{g^{t} - h^t}^2}+ \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2}\Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2}\nonumber\\
    &\quad + \frac{4 \gamma (2 \omega + 1)\omega}{n \probavailable^2} \Exp{\frac{1}{n} \sum_{i=1}^n\norm{k^{t+1}_i}^2}.
  \end{align*}
\end{proof}

% In the following lemma, we provide a helpful observation about $k^{t+1}_i$.

% \begin{lemma}
%   \label{lemma:expectation_k_t}
%   Suppose that Assumptions \ref{}, \ref{} and \ref{} hold. For $k^{t+1}_i$ from Algorithm~\ref{alg:main_algorithm} we have
%   \begin{align*}
%       &\ExpSub{k}{k^{t+1}_i} = \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t})).
%   \end{align*}
% \end{lemma}

% \begin{proof}
%   Clearly, the equality holds for \algname{DASHA-PP}. Next, we show it for \algname{DASHA-PP-PAGE}:
%   \begin{align*}
%     &\ExpSub{k}{k^{t+1}_i} \\
%     &= \probpage \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right)\right) \\
%     &\quad + (1 - \probpage) \ExpSub{k}{\frac{1}{B}\sum_{j \in I^t_i}\left(\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})\right)} \\
%     &= \probpage \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right)\right) \\
%     &\quad + (1 - \probpage) \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right) \\
%     &= \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b \left(h^t_i - \nabla f_i(x^{t})\right).
% \end{align*}
% Finally, from the unbiasedness of stochastic gradients, the equality holds for \algname{DASHA-PP-MVR}.
% \end{proof}

\subsection{Proof for \algname{DASHA-PP}}

\begin{lemma}
  \label{lemma:gradient}
  Suppose that Assumptions~\ref{ass:nodes_lipschitz_constant} and \ref{ass:partial_participation} hold. For $h^{t+1}_i$ and $k^{t+1}_i$ from Algorithm~\ref{alg:main_algorithm} (\algname{DASHA-PP}) we have
  \begin{enumerate}
  \item
      \begin{align*}
          &\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} \\
          & \leq \frac{2\left(\probavailable - \probpairaa\right)\widehat{L}^2}{n \probavailable^2} \norm{x^{t+1} - x^{t}}^2 + \frac{2 b^2 \left(\probavailable - \probpairaa\right)}{n^2 \probavailable^2} \sum_{i=1}^n \norm{h^t_i - \nabla f_i(x^{t})}^2 + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2.
      \end{align*}
  \item
      \begin{align*}
          &\ExpSub{\probavailable}{\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2} \\
          & \leq \frac{2(1 - \probavailable)}{\probavailable} L^2_i \norm{x^{t+1} - x^{t}}^2 + \left(\frac{2 b^2 (1 - \probavailable)}{\probavailable} + (1 - b)^2\right) \norm{h^{t}_i - \nabla f_i(x^{t})}^2, \quad \forall i \in [n].
      \end{align*}
  \item
      \begin{align*}
        &\norm{k^{t+1}_i}^2 \leq 2L^2_i\norm{x^{t+1} - x^{t}}^2 + 2b^2 \norm{h^t_i - \nabla f_i(x^{t})}^2, \quad \forall i \in [n].
      \end{align*}
  \end{enumerate}
\end{lemma}

\begin{proof}
  First, let us proof the bound for $\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}}$:
  \begin{align*}
      &\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} \\
      &=\ExpSub{\probavailable}{\norm{h^{t+1} - \ExpSub{\probavailable}{h^{t+1}}}^2} + \norm{\ExpSub{\probavailable}{h^{t+1}} - \nabla f(x^{t+1})}^2.
  \end{align*}
  Using
  \begin{align*}
      \ExpSub{\probavailable}{h^{t+1}_i} = h^{t}_i + \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))
  \end{align*}
  and \eqref{auxiliary:variance_decomposition}, we have
  \begin{align*}
    &\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} \\
    &=\ExpSub{\probavailable}{\norm{h^{t+1} - \ExpSub{\probavailable}{h^{t+1}}}^2} + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2.
  \end{align*}
  We can use Lemma~\ref{lemma:sampling} with $r_i = h^{t}_i$ and $s_i = k^{t+1}_i$ to obtain
  \begin{align*}
    &\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} \\
    &\leq \frac{1}{n^2 \probavailable}\sum_{i=1}^n\norm{k^{t+1}_i - k^{t+1}_i}^2 +\frac{\probavailable - \probpairaa}{n^2 \probavailable^2}\sum_{i=1}^n\norm{k^{t+1}_i}^2 + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2\\
    &= \frac{\probavailable - \probpairaa}{n^2 \probavailable^2}\sum_{i=1}^n\norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b \left(h^t_i - \nabla f_i(x^{t})\right)}^2 + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2\\
    &\overset{\eqref{auxiliary:jensen_inequality}}{\leq} \frac{2\left(\probavailable - \probpairaa\right)}{n^2 \probavailable^2}\sum_{i=1}^n\norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})}^2 + \frac{2 b^2 \left(\probavailable - \probpairaa\right)}{n^2 \probavailable^2}\sum_{i=1}^n\norm{h^t_i - \nabla f_i(x^{t})}^2 + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2\\
    &\leq \frac{2\left(\probavailable - \probpairaa\right)\widehat{L}^2}{n \probavailable^2} \norm{x^{t+1} - x^{t}}^2 + \frac{2 b^2 \left(\probavailable - \probpairaa\right)}{n^2 \probavailable^2}\sum_{i=1}^n\norm{h^t_i - \nabla f_i(x^{t})}^2 + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2.
  \end{align*}
  In the last in inequality, we used Assumption~\ref{ass:nodes_lipschitz_constant}. Now, we prove the second inequality:
  \begin{align*}
    &\ExpSub{\probavailable}{\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2} \\
    &=\ExpSub{\probavailable}{\norm{h^{t+1}_i - \ExpSub{\probavailable}{h^{t+1}_i}}^2} + \norm{\ExpSub{\probavailable}{h^{t+1}_i  } - \nabla f_i(x^{t+1})}^2 \\
    &=\ExpSub{\probavailable}{\norm{h^{t+1}_i - \left(h^{t}_i + \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))\right)}^2} + (1 - b)^2 \norm{h^{t}_i - \nabla f_i(x^{t})}^2 \\
    &=\frac{(1 - \probavailable)^2}{\probavailable} \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad + (1 - \probavailable)\norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 + (1 - b)^2 \norm{h^{t}_i - \nabla f_i(x^{t})}^2 \\
    &=\frac{(1 - \probavailable)}{\probavailable} \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 + (1 - b)^2 \norm{h^{t}_i - \nabla f_i(x^{t})}^2 \\
    &\leq \frac{2(1 - \probavailable)}{\probavailable} L^2_i \norm{x^{t+1} - x^{t}}^2 + \left(\frac{2 b^2 (1 - \probavailable)}{\probavailable} + (1 - b)^2\right) \norm{h^{t}_i - \nabla f_i(x^{t})}^2.
  \end{align*}
  Finally, the third inequality of the theorem follows from \eqref{auxiliary:jensen_inequality} and Assumption~\ref{ass:nodes_lipschitz_constant}.
\end{proof}

\CONVERGENCE*

\begin{proof}
  Let us fix constants $\nu, \rho \in [0,\infty)$ that we will define later. Considering Lemma~\ref{lemma:main_lemma}, Lemma~\ref{lemma:gradient}, and the law of total expectation, we obtain
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \nu \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \rho \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &=\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \nu \Exp{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}} + \rho \Exp{\ExpSub{\probavailable}{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}}\\
      &\leq \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
      \norm{x^{t+1} - x^t}^2 + \gamma \norm{h^{t} - \nabla f(x^t)}^2}\nonumber\\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable}\Exp{\norm{g^{t} - h^t}^2}+ \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2}\Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2} \\
      &\quad + \frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \Exp{2\widehat{L}^2\norm{x^{t+1} - x^{t}}^2 + 2b^2 \frac{1}{n}\sum_{i=1}^n \norm{h^t_i - \nabla f_i(x^{t})}^2} \\
      &\quad + \nu \Exp{\frac{2\left(\probavailable - \probpairaa\right)\widehat{L}^2}{n \probavailable^2} \norm{x^{t+1} - x^{t}}^2 + \frac{2 b^2 \left(\probavailable - \probpairaa\right)}{n^2 \probavailable^2} \sum_{i=1}^n \norm{h^t_i - \nabla f_i(x^{t})}^2 + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2} \\
      &\quad + \rho \Exp{\frac{2(1 - \probavailable)}{\probavailable} \widehat{L}^2 \norm{x^{t+1} - x^{t}}^2 + \left(\frac{2 b^2 (1 - \probavailable)}{\probavailable} + (1 - b)^2\right) \frac{1}{n}\sum_{i=1}^n \norm{h^{t}_i - \nabla f_i(x^{t})}^2}.
    \end{align*}
    After rearranging the terms, we get
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \nu \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \rho \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} \\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &\quad - \left(\frac{1}{2\gamma} - \frac{L}{2} - \frac{8 \gamma \omega \left(2 \omega + 1\right) \widehat{L}^2}{n \probavailable^2} - \nu \frac{2\left(\probavailable - \probpairaa\right)\widehat{L}^2}{n \probavailable^2} - \rho \frac{2(1 - \probavailable) \widehat{L}^2}{\probavailable} \right) \Exp{\norm{x^{t+1} - x^t}^2} \\
      &\quad + \left(\gamma + \nu (1 - b)^2\right) \Exp{\norm{h^{t} - \nabla f(x^{t})}^2} \\
      &\quad + \left(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \nu \frac{2 b^2 \left(\probavailable - \probpairaa\right)}{n \probavailable^2} + \rho \left(\frac{2 b^2 (1 - \probavailable)}{\probavailable} + (1 - b)^2\right) \right)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2}.
    \end{align*}
    By taking $\nu = \frac{\gamma}{b},$ one can show that $\left(\gamma + \nu (1 - b)^2\right) \leq \nu,$ and
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \frac{\gamma}{b} \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \rho \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} \\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &\quad - \left(\frac{1}{2\gamma} - \frac{L}{2} - \frac{8 \gamma \omega \left(2 \omega + 1\right) \widehat{L}^2}{n \probavailable^2} - \frac{2\gamma \left(\probavailable - \probpairaa\right)\widehat{L}^2}{b n \probavailable^2} - \rho \frac{2(1 - \probavailable) \widehat{L}^2}{\probavailable} \right) \Exp{\norm{x^{t+1} - x^t}^2} \\
      &\quad + \frac{\gamma}{b} \Exp{\norm{h^{t} - \nabla f(x^{t})}^2} \\
      &\quad + \left(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma b \left(\probavailable - \probpairaa\right)}{n \probavailable^2} + \rho \left(\frac{2 b^2 (1 - \probavailable)}{\probavailable} + (1 - b)^2\right) \right)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2}.
    \end{align*}
    Note that $b = \frac{\probavailable}{2 - \probavailable},$ thus
    \begin{align*}
      &\left(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma b \left(\probavailable - \probpairaa\right)}{n \probavailable^2} + \rho \left(\frac{2 b^2 (1 - \probavailable)}{\probavailable} + (1 - b)^2\right) \right) \\
      &\leq \left(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma b \left(\probavailable - \probpairaa\right)}{n \probavailable^2} + \rho \left(1 - b\right) \right).
    \end{align*}
    And if we take $\rho = \frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2},$ then
    \begin{align*}
      \left(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma b \left(\probavailable - \probpairaa\right)}{n \probavailable^2} + \rho \left(1 - b\right) \right) \leq \rho,
    \end{align*}
    and 
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \frac{\gamma}{b} \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right) \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} \\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &\quad - \Bigg(\frac{1}{2\gamma} - \frac{L}{2} - \frac{8 \gamma \omega \left(2 \omega + 1\right) \widehat{L}^2}{n \probavailable^2} - \frac{2\gamma \left(\probavailable - \probpairaa\right)\widehat{L}^2}{b n \probavailable^2} \\
      &\quad\qquad - \frac{16 b \gamma \omega (2 \omega + 1) (1 - \probavailable) \widehat{L}^2}{n \probavailable^3} - \frac{4 \gamma \left(\probavailable - \probpairaa\right) (1 - \probavailable) \widehat{L}^2}{n \probavailable^3} \Bigg) \Exp{\norm{x^{t+1} - x^t}^2} \\
      &\quad + \frac{\gamma}{b} \Exp{\norm{h^{t} - \nabla f(x^{t})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2}.
    \end{align*}
    Let us simplify the last inequality. First, note that
    \begin{align*}
      &\frac{16 b \gamma \omega (2 \omega + 1) (1 - \probavailable) \widehat{L}^2}{n \probavailable^3} \leq \frac{16 \gamma \omega (2 \omega + 1) \widehat{L}^2}{n \probavailable^2},
    \end{align*}
    due to $b \leq \probavailable.$ Second,
    \begin{align*}
      \frac{2\gamma \left(\probavailable - \probpairaa\right)\widehat{L}^2}{b n \probavailable^2} \leq \frac{4\gamma \left(\probavailable - \probpairaa\right)\widehat{L}^2}{n \probavailable^3},
    \end{align*}
    due to $b \geq \frac{\probavailable}{2}.$ All in all, we have
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \frac{\gamma}{b} \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right) \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} \\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &\quad - \Bigg(\frac{1}{2\gamma} - \frac{L}{2} - \frac{24 \gamma \omega \left(2 \omega + 1\right) \widehat{L}^2}{n \probavailable^2} - \frac{8\gamma \left(\probavailable - \probpairaa\right)\widehat{L}^2}{n \probavailable^3} \Bigg) \Exp{\norm{x^{t+1} - x^t}^2} \\
      &\quad + \frac{\gamma}{b} \Exp{\norm{h^{t} - \nabla f(x^{t})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2}.
    \end{align*}
    Using Lemma~\ref{lemma:gamma} and the assumption about $\gamma,$ we get
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \frac{\gamma}{b} \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right) \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} \\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &\quad + \frac{\gamma}{b} \Exp{\norm{h^{t} - \nabla f(x^{t})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2}.
    \end{align*}
    It is left to apply Lemma~\ref{lemma:good_recursion} with 
    \begin{eqnarray*}
      \Psi^t &=& \frac{(2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{(\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
        &\quad +& \frac{1}{b} \Exp{\norm{h^{t} - \nabla f(x^{t})}^2} + \left(\frac{8 b \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2}
    \end{eqnarray*}
    to conclude the proof.
\end{proof}

\subsection{Proof for \algname{DASHA-PP-PAGE}}

Let us denote
\begin{align*}
    &k^{t+1}_{i, 1} \eqdef \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right), \\
    &k^{t+1}_{i, 2} \eqdef \frac{1}{B}\sum_{j \in I^t_i}\left(\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})\right), \\
    &h^{t+1}_{i,1} \eqdef \begin{cases}
        h^t_i + \frac{1}{\probavailable} k^{t+1}_{i, 1},& \textnormal{with probability $\probavailable$,} \\
        h^t_i, & \textnormal{with probability $1 - \probavailable$,} 
    \end{cases}  \\
    &h^{t+1}_{i,2} \eqdef \begin{cases}
        h^t_i + \frac{1}{\probavailable} k^{t+1}_{i, 2},& \textnormal{with probability $\probavailable$,} \\
        h^t_i, & \textnormal{with probability $1 - \probavailable$,}
    \end{cases}  \\
\end{align*}
$h^{t+1}_{1} \eqdef \frac{1}{n}\sum_{i=1}^n h^{t+1}_{i,1},$ and $h^{t+1}_{2} \eqdef \frac{1}{n}\sum_{i=1}^n h^{t+1}_{i,2}.$ Note, that
\begin{align*}
  &h^{t+1} = \begin{cases}
    h^{t+1}_{1},& \textnormal{with probability $\probpage$,} \\
    h^{t+1}_{2},& \textnormal{with probability $1 - \probpage$.} 
  \end{cases}
\end{align*}

\begin{lemma}
  \label{lemma:gradient_page}
  Suppose that Assumptions \ref{ass:nodes_lipschitz_constant}, \ref{ass:max_lipschitz_constant}, and \ref{ass:partial_participation} hold. For $h^{t+1}_i$ and $k^{t+1}_i$ from Algorithm~\ref{alg:main_algorithm} (\algname{DASHA-PP-PAGE}) we have
  \begin{enumerate}
  \item
      \begin{align*}
          &\ExpSub{B}{\ExpSub{\probavailable}{\ExpSub{\probpage}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}}} \\
          & \leq \left(\frac{2 \left(\probavailable - \probpairaa\right) \widehat{L}^2}{n \probavailable^2} + \frac{(1 - \probpage)L_{\max}^2}{n \probavailable B}\right) \norm{x^{t+1} - x^{t}}^2\\
          &\quad + \frac{2\left(\probavailable - \probpairaa\right) b^2}{n^2 \probavailable^2 \probpage}\sum_{i=1}^n\norm{ h^t_i - \nabla f_i(x^{t})}^2 + \left(\probpage\left(1 - \frac{b}{\probpage}\right)^2 + (1 - \probpage)\right)\norm{h^{t} - \nabla f(x^{t})}^2.
      \end{align*}
  \item
      \begin{align*}
          &\ExpSub{B}{\ExpSub{\probavailable}{\ExpSub{\probpage}{\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}}} \\
          & \leq \left(\frac{2\left(1 - \probavailable\right)L_i^2}{\probavailable} + \frac{(1 - \probpage)L_{\max}^2}{\probavailable B}\right) \norm{x^{t+1} - x^{t}}^2 \\
          &\quad +\left(\frac{2\left(1 - \probavailable\right)b^2}{\probavailable \probpage} + \probpage\left(1 - \frac{b}{\probpage}\right)^2 + (1 - \probpage)\right)\norm{h^{t}_i - \nabla f_i(x^{t})}^2, \quad \forall i \in [n].
      \end{align*}
  \item
      \begin{align*}
        &\ExpSub{B}{\ExpSub{\probpage}{\norm{k^{t+1}_i}^2}} \\
        &\leq \left(2 L_i^2 + \frac{(1 - \probpage)L_{\max}^2}{B}\right)\norm{x^{t+1} - x^{t}}^2 +  \frac{2b^2}{\probpage} \norm{h^t_i - \nabla f_i(x^{t})}^2, \quad \forall i \in [n].
      \end{align*}
  \end{enumerate}
\end{lemma}

\begin{proof}
  First, we prove the first inequality of the theorem:
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{\ExpSub{\probpage}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}}} \\
    &=\probpage\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{1} - \nabla f(x^{t+1})}^2}} + (1 - \probpage)\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{2} - \nabla f(x^{t+1})}^2}}.\\
  \end{align*}
  Using 
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{i,1}}} = \\
    &=\probavailable h^t_i +  \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right) + (1 - \probavailable) h^t_i \\
    &= h^t_i + \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right).
  \end{align*}
  and 
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{i,2}}} = \\
    &=\probavailable h^t_i +  \ExpSub{B}{\frac{1}{B}\sum_{j \in I^t_i}\left(\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})\right)} + (1 - \probavailable) h^t_i \\
    &= h^t_i + \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}),
  \end{align*}
  we obtain
  \begin{align}
    &\ExpSub{B}{\ExpSub{\probavailable}{\ExpSub{\probpage}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}}} \nonumber\\
    &\overset{\eqref{auxiliary:variance_decomposition}}{=}\probpage\ExpSub{\probavailable}{\norm{h^{t+1}_{1} - \ExpSub{\probavailable}{h^{t+1}_{1}}}^2} + (1 - \probpage)\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{2} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{2}}}}^2}} \nonumber\\
    &\quad +\probpage\norm{\ExpSub{\probavailable}{h^{t+1}_{1}} - \nabla f(x^{t+1})}^2 + (1 - \probpage)\norm{\ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{2}}} - \nabla f(x^{t+1})}^2 \nonumber \\
    &=\probpage\ExpSub{\probavailable}{\norm{h^{t+1}_{1} - \ExpSub{\probavailable}{h^{t+1}_{1}}}^2} + (1 - \probpage)\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{2} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{2}}}}^2}} \nonumber\\
    &\quad +\left(\probpage\left(1 - \frac{b}{\probpage}\right)^2 + (1 - \probpage)\right)\norm{h^{t} - \nabla f(x^{t})}^2. \label{eq:page_proof:orig}
  \end{align}
  Next, we consider $\ExpSub{\probavailable}{\norm{h^{t+1}_{1} - \ExpSub{\probavailable}{h^{t+1}_{1}}}^2}$. We can use Lemma~\ref{lemma:sampling} with $r_i = h^{t}_i$ and $s_i = k^{t+1}_{i,1}$ to obtain
  \begin{align*}
    &\ExpSub{\probavailable}{\norm{h^{t+1}_{1} - \ExpSub{\probavailable}{h^{t+1}_{1}}}^2}\\
    &\leq \frac{1}{n^2 \probavailable}\sum_{i=1}^n\norm{k^{t+1}_{i,1} - k^{t+1}_{i,1}}^2 +\frac{\probavailable - \probpairaa}{n^2 \probavailable^2}\sum_{i=1}^n\norm{k^{t+1}_{i,1}}^2 \\
    &= \frac{\probavailable - \probpairaa}{n^2 \probavailable^2}\sum_{i=1}^n\norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right)}^2 \\
    &\overset{\eqref{auxiliary:jensen_inequality}}{\leq} \frac{2\left(\probavailable - \probpairaa\right)}{n^2 \probavailable^2}\sum_{i=1}^n\norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})}^2 + \frac{2 \left(\probavailable - \probpairaa\right) b^2}{n^2 \probavailable^2 \probpage^2}\sum_{i=1}^n\norm{h^t_i - \nabla f_i(x^{t})}^2.
  \end{align*}
  From Assumption~\ref{ass:nodes_lipschitz_constant}, we have
  \begin{align}
    &\ExpSub{\probavailable}{\norm{h^{t+1}_{1} - \ExpSub{\probavailable}{h^{t+1}_{1}}}^2} \nonumber\\
    &\leq \frac{2\left(\probavailable - \probpairaa\right) \widehat{L}^2}{n \probavailable^2}\norm{x^{t+1} - x^{t}}^2 + \frac{2 \left(\probavailable - \probpairaa\right)b^2}{n^2 \probavailable^2 \probpage^2}\sum_{i=1}^n\norm{h^t_i - \nabla f_i(x^{t})}^2 \label{eq:page_proof:h_1}.
  \end{align}
  Now, we prove the bound for $\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{2} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{2}}}}^2}}.$
  Considering that mini-batches in the algorithm are independent, we can use Lemma~\ref{lemma:sampling} with $r_i = h^{t}_i$ and $s_i = k^{t+1}_{i,2}$ to obtain
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{2} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{2}}}}^2}}\\
    &\leq \frac{1}{n^2 \probavailable}\sum_{i=1}^n\ExpSub{B}{\norm{k^{t+1}_{i,2} - \ExpSub{B}{k^{t+1}_{i,2}}}^2} +\frac{\probavailable - \probpairaa}{n^2 \probavailable^2}\sum_{i=1}^n\norm{\ExpSub{B}{k^{t+1}_{i,2}}}^2 \\
    &= \frac{1}{n^2 \probavailable}\sum_{i=1}^n\ExpSub{B}{\norm{\frac{1}{B}\sum_{j \in I^t_i}\left(\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})\right) - \left(\nabla f_{i}(x^{t+1}) - \nabla f_{i}(x^{t})\right)}^2} \\
    &\quad +\frac{\probavailable - \probpairaa}{n^2 \probavailable^2}\sum_{i=1}^n\norm{\nabla f_{i}(x^{t+1}) - \nabla f_{i}(x^{t})}^2 \\
    &= \frac{1}{n^2 \probavailable B^2}\sum_{i=1}^n\ExpSub{B}{\sum_{j \in I^t_i}\norm{\left(\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})\right) - \left(\nabla f_{i}(x^{t+1}) - \nabla f_{i}(x^{t})\right)}^2} \\
    &\quad +\frac{\probavailable - \probpairaa}{n^2 \probavailable^2}\sum_{i=1}^n\norm{\nabla f_{i}(x^{t+1}) - \nabla f_{i}(x^{t})}^2 \\
    &= \frac{1}{n^2 \probavailable B m}\sum_{i=1}^n \sum_{j=1}^m \norm{\left(\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})\right) - \left(\nabla f_{i}(x^{t+1}) - \nabla f_{i}(x^{t})\right)}^2 \\
    &\quad +\frac{\probavailable - \probpairaa}{n^2 \probavailable^2}\sum_{i=1}^n\norm{\nabla f_{i}(x^{t+1}) - \nabla f_{i}(x^{t})}^2 \\
    &\leq \frac{1}{n^2 \probavailable B m}\sum_{i=1}^n \sum_{j=1}^m \norm{\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})}^2 +\frac{\probavailable - \probpairaa}{n^2 \probavailable^2}\sum_{i=1}^n\norm{\nabla f_{i}(x^{t+1}) - \nabla f_{i}(x^{t})}^2.
  \end{align*}
  Next, we use Assumptions \ref{ass:nodes_lipschitz_constant} and \ref{ass:max_lipschitz_constant} to get
  \begin{align}
    \ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{2} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{2}}}}^2}} \leq \left(\frac{L_{\max}^2}{n \probavailable B} +\frac{\left(\probavailable - \probpairaa\right) \widehat{L}^2}{n \probavailable^2}\right)\norm{x^{t+1} - x^{t}}^2. \label{eq:page_proof:h_2}
  \end{align}
  Applying \eqref{eq:page_proof:h_1} and \eqref{eq:page_proof:h_2} into \eqref{eq:page_proof:orig}, we get
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{\ExpSub{\probpage}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}}} \\
    &\leq\probpage\left(\frac{2 \left(\probavailable - \probpairaa\right) \widehat{L}^2}{n \probavailable^2} \norm{x^{t+1} - x^{t}}^2 + \frac{2\left(\probavailable - \probpairaa\right) b^2}{n^2 \probavailable^2 \probpage^2}\sum_{i=1}^n\norm{ h^t_i - \nabla f_i(x^{t})}^2\right) + \\
    &\quad + (1 - \probpage)\left(\frac{L_{\max}^2}{n \probavailable B} +\frac{\left(\probavailable - \probpairaa\right) \widehat{L}^2}{n \probavailable^2}\right)\norm{x^{t+1} - x^{t}}^2 \\
    &\quad +\left(\probpage\left(1 - \frac{b}{\probpage}\right)^2 + (1 - \probpage)\right)\norm{h^{t} - \nabla f(x^{t})}^2\\
    &\leq\left(\frac{2 \left(\probavailable - \probpairaa\right) \widehat{L}^2}{n \probavailable^2} + \frac{(1 - \probpage)L_{\max}^2}{n \probavailable B}\right) \norm{x^{t+1} - x^{t}}^2\\
    &\quad + \frac{2\left(\probavailable - \probpairaa\right) b^2}{n^2 \probavailable^2 \probpage}\sum_{i=1}^n\norm{ h^t_i - \nabla f_i(x^{t})}^2 + \left(\probpage\left(1 - \frac{b}{\probpage}\right)^2 + (1 - \probpage)\right)\norm{h^{t} - \nabla f(x^{t})}^2.
  \end{align*}
  The proof of the second inequality almost repeats the previous one:
  \begin{align}
    &\ExpSub{B}{\ExpSub{\probavailable}{\ExpSub{\probpage}{\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}}} \nonumber \\
    &=\probpage\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{i,1} - \nabla f_i(x^{t+1})}^2}} + (1 - \probpage)\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{i,2} - \nabla f_i(x^{t+1})}^2}} \nonumber\\
    &\overset{\eqref{auxiliary:variance_decomposition}}{=}\probpage\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{i,1} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{i,1}}}}^2}} + (1 - \probpage)\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{i,2} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{i,2}}}}^2}} \nonumber\\
    &\quad +\probpage\norm{\ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{i,1}}} - \nabla f_i(x^{t+1})}^2 + (1 - \probpage)\norm{\ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{i,2}}} - \nabla f_i(x^{t+1})}^2 \nonumber \\
    &=\probpage\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{i,1} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{i,1}}}}^2}} + (1 - \probpage)\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{i,2} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{i,2}}}}^2}} \nonumber\\
    &\quad +\left(\probpage\left(1 - \frac{b}{\probpage}\right)^2 + (1 - \probpage)\right)\norm{h^{t}_i - \nabla f_i(x^{t})}^2 \label{eq:page_proof:mini:orig}.
  \end{align}
  Let us consider $\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{i,1} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{i,1}}}}^2}}$:
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{i,1} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{i,1}}}}^2}}\\
    &=\ExpSub{\probavailable}{\norm{h^{t+1}_{i,1} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{i,1}}}}^2} \\
    &=\probavailable \norm{h^t_i + \frac{1}{\probavailable} k^{t+1}_{i, 1} - \left(h^t_i + \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right)\right)}^2 \\
    &\quad + (1 - \probavailable) \norm{h^t_i - \left(h^t_i + \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right)\right)}^2 \\
    &=\frac{(1 - \probavailable)^2}{\probavailable} \norm{h^t_i + \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right)}^2 \\
    &\quad + (1 - \probavailable) \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right)}^2 \\
    &=\frac{1 - \probavailable}{\probavailable} \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right)}^2.
  \end{align*}
  Considering \eqref{auxiliary:jensen_inequality} and Assumption~\ref{ass:nodes_lipschitz_constant}, we obtain
  \begin{align}
    &\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{i,1} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{i,1}}}}^2}} \nonumber\\
    &\leq \frac{2\left(1 - \probavailable\right)L_i^2}{\probavailable} \norm{x^{t+1} - x^{t}}^2 + \frac{2\left(1 - \probavailable\right)b^2}{\probavailable \probpage^2} \norm{h^t_i - \nabla f_i(x^{t})}^2 \label{eq:page_proof:mini:h_1}.
  \end{align}
  Next, we obtain the bound for $\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{i,2} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{i,2}}}}^2}}$:
  \begin{align}
    &\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{i,2} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{i,2}}}}^2}} \nonumber \\
    &= \probavailable \ExpSub{B}{\norm{h^t_i + \frac{1}{\probavailable} k^{t+1}_{i, 2} - \left(h^t_i + \nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}^2} \nonumber\\
    &\quad +(1 - \probavailable) \ExpSub{B}{\norm{h^{t}_{i} - \left(h^t_i + \nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}^2}\nonumber \\
    &= \probavailable \ExpSub{B}{\norm{\frac{1}{\probavailable} k^{t+1}_{i, 2} - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}^2}\nonumber \\
    &\quad +(1 - \probavailable) \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})}^2\nonumber \\
    &\overset{\eqref{auxiliary:variance_decomposition}}{=} \frac{1}{\probavailable} \ExpSub{B}{\norm{k^{t+1}_{i, 2} - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}^2} + \frac{(1 - \probavailable)^2}{\probavailable} \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})}^2\nonumber \\
    &\quad +(1 - \probavailable) \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})}^2 \nonumber \\
    &= \frac{1}{\probavailable} \ExpSub{B}{\norm{k^{t+1}_{i, 2} - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}^2} + \frac{1 - \probavailable}{\probavailable} \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})}^2 \nonumber \\
    &\leq \frac{1}{\probavailable} \ExpSub{B}{\norm{k^{t+1}_{i, 2} - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}^2} + \frac{\left(1 - \probavailable\right)L^2_i}{\probavailable} \norm{x^{t+1} - x^{t}}^2, \label{eq:page_proof:mini:h_2}
  \end{align}
  where we used Assumption~\ref{ass:nodes_lipschitz_constant}. By plugging \eqref{eq:page_proof:mini:h_1} and \eqref{eq:page_proof:mini:h_2} into \eqref{eq:page_proof:mini:orig}, we get
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{\ExpSub{\probpage}{\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}}} \nonumber \\
    &\leq\probpage\left(\frac{2\left(1 - \probavailable\right)L_i^2}{\probavailable} \norm{x^{t+1} - x^{t}}^2 + \frac{2\left(1 - \probavailable\right)b^2}{\probavailable \probpage^2} \norm{h^t_i - \nabla f_i(x^{t})}^2\right) \\
    &\quad + (1 - \probpage)\left(\frac{1}{\probavailable} \ExpSub{B}{\norm{k^{t+1}_{i, 2} - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}^2} + \frac{\left(1 - \probavailable\right)L^2_i}{\probavailable} \norm{x^{t+1} - x^{t}}^2\right) \\
    &\quad +\left(\probpage\left(1 - \frac{b}{\probpage}\right)^2 + (1 - \probpage)\right)\norm{h^{t}_i - \nabla f_i(x^{t})}^2 \\
    &\leq \frac{2\left(1 - \probavailable\right)L_i^2}{\probavailable} \norm{x^{t+1} - x^{t}}^2 + \frac{1 - \probpage}{\probavailable} \ExpSub{B}{\norm{k^{t+1}_{i, 2} - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}^2} \\
    &\quad +\left(\frac{2\left(1 - \probavailable\right)b^2}{\probavailable \probpage} + \probpage\left(1 - \frac{b}{\probpage}\right)^2 + (1 - \probpage)\right)\norm{h^{t}_i - \nabla f_i(x^{t})}^2.
  \end{align*}
  From the independence of elements in the mini-batch, we obtain
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{\ExpSub{\probpage}{\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}}} \nonumber \\
    &\leq \frac{2\left(1 - \probavailable\right)L_i^2}{\probavailable} \norm{x^{t+1} - x^{t}}^2 + \frac{1 - \probpage}{\probavailable} \ExpSub{B}{\norm{\frac{1}{B}\sum_{j \in I^t_i}\left(\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})\right) - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}^2} \\
    &\quad +\left(\frac{2\left(1 - \probavailable\right)b^2}{\probavailable \probpage} + \probpage\left(1 - \frac{b}{\probpage}\right)^2 + (1 - \probpage)\right)\norm{h^{t}_i - \nabla f_i(x^{t})}^2 \\
    &= \frac{2\left(1 - \probavailable\right)L_i^2}{\probavailable} \norm{x^{t+1} - x^{t}}^2 + \frac{1 - \probpage}{\probavailable B^2} \ExpSub{B}{\sum_{j \in I^t_i} \norm{\left(\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})\right) - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}^2} \\
    &\quad +\left(\frac{2\left(1 - \probavailable\right)b^2}{\probavailable \probpage} + \probpage\left(1 - \frac{b}{\probpage}\right)^2 + (1 - \probpage)\right)\norm{h^{t}_i - \nabla f_i(x^{t})}^2 \\
    &= \frac{2\left(1 - \probavailable\right)L_i^2}{\probavailable} \norm{x^{t+1} - x^{t}}^2 + \frac{1 - \probpage}{m \probavailable B} \sum_{j=1}^m \norm{\left(\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})\right) - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}^2 \\
    &\quad +\left(\frac{2\left(1 - \probavailable\right)b^2}{\probavailable \probpage} + \probpage\left(1 - \frac{b}{\probpage}\right)^2 + (1 - \probpage)\right)\norm{h^{t}_i - \nabla f_i(x^{t})}^2 \\
    &\leq \frac{2\left(1 - \probavailable\right)L_i^2}{\probavailable} \norm{x^{t+1} - x^{t}}^2 + \frac{1 - \probpage}{m \probavailable B} \sum_{j=1}^m \norm{\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})}^2 \\
    &\quad +\left(\frac{2\left(1 - \probavailable\right)b^2}{\probavailable \probpage} + \probpage\left(1 - \frac{b}{\probpage}\right)^2 + (1 - \probpage)\right)\norm{h^{t}_i - \nabla f_i(x^{t})}^2 \\
    &\leq \left(\frac{2\left(1 - \probavailable\right)L_i^2}{\probavailable} + \frac{(1 - \probpage)L_{\max}^2}{\probavailable B}\right) \norm{x^{t+1} - x^{t}}^2 \\
    &\quad +\left(\frac{2\left(1 - \probavailable\right)b^2}{\probavailable \probpage} + \probpage\left(1 - \frac{b}{\probpage}\right)^2 + (1 - \probpage)\right)\norm{h^{t}_i - \nabla f_i(x^{t})}^2, \\
  \end{align*}
  where we used Assumption~\ref{ass:max_lipschitz_constant}. Finally, we prove the last inequality:
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probpage}{\norm{k^{t+1}_i}^2}} \\
    &=\probpage \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right)}^2 \\
    &\quad + (1 - \probpage) \ExpSub{B}{\norm{\frac{1}{B}\sum_{j \in I^t_i}\left(\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})\right)}^2} \\
    &\overset{\eqref{auxiliary:variance_decomposition}}{=}\probpage \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right)}^2 \\
    &\quad + (1 - \probpage) \ExpSub{B}{\norm{\frac{1}{B}\sum_{j \in I^t_i}\left(\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})\right) - \left(\nabla f_{i}(x^{t+1}) - \nabla f_{i}(x^{t})\right)}^2} \\
    &\quad + (1 - \probpage) \norm{\nabla f_{i}(x^{t+1}) - \nabla f_{i}(x^{t})}^2\\
    &\overset{\eqref{auxiliary:jensen_inequality}}{\leq}2 \probpage \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})}^2 +  \frac{2b^2}{\probpage} \norm{h^t_i - \nabla f_i(x^{t})}^2 \\
    &\quad + (1 - \probpage) \ExpSub{B}{\norm{\frac{1}{B}\sum_{j \in I^t_i}\left(\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})\right) - \left(\nabla f_{i}(x^{t+1}) - \nabla f_{i}(x^{t})\right)}^2} \\
    &\quad + (1 - \probpage) \norm{\nabla f_{i}(x^{t+1}) - \nabla f_{i}(x^{t})}^2\\
    &\leq2 \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})}^2 +  \frac{2b^2}{\probpage} \norm{h^t_i - \nabla f_i(x^{t})}^2 \\
    &\quad + (1 - \probpage) \ExpSub{B}{\norm{\frac{1}{B}\sum_{j \in I^t_i}\left(\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})\right) - \left(\nabla f_{i}(x^{t+1}) - \nabla f_{i}(x^{t})\right)}^2}.
  \end{align*}
  Using the independence of elements in the mini-batch, we have
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probpage}{\norm{k^{t+1}_i}^2}} \\
    &\leq 2 \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})}^2 +  \frac{2b^2}{\probpage} \norm{h^t_i - \nabla f_i(x^{t})}^2 \\
    &\quad + \frac{1 - \probpage}{B^2} \ExpSub{B}{\sum_{j \in I^t_i}\norm{\left(\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})\right) - \left(\nabla f_{i}(x^{t+1}) - \nabla f_{i}(x^{t})\right)}^2} \\ 
    &= 2 \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})}^2 +  \frac{2b^2}{\probpage} \norm{h^t_i - \nabla f_i(x^{t})}^2 \\
    &\quad + \frac{1 - \probpage}{B m} \sum_{j=1}^m \norm{\left(\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})\right) - \left(\nabla f_{i}(x^{t+1}) - \nabla f_{i}(x^{t})\right)}^2 \\ 
    &\leq 2 \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})}^2 +  \frac{2b^2}{\probpage} \norm{h^t_i - \nabla f_i(x^{t})}^2 \\
    &\quad + \frac{1 - \probpage}{B m} \sum_{j=1}^m \norm{\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})}^2 \\.
  \end{align*}
  It it left to consider Assumptions~\ref{ass:nodes_lipschitz_constant} and \ref{ass:max_lipschitz_constant} to get
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probpage}{\norm{k^{t+1}_i}^2}} \\
    &\leq \left(2 L_i^2 + \frac{(1 - \probpage)L_{\max}^2}{B}\right)\norm{x^{t+1} - x^{t}}^2 +  \frac{2b^2}{\probpage} \norm{h^t_i - \nabla f_i(x^{t})}^2.
  \end{align*}
\end{proof}

\CONVERGENCEPAGE*

\begin{proof}
  Let us fix constants $\nu, \rho \in [0,\infty)$ that we will define later. Considering Lemma~\ref{lemma:main_lemma}, Lemma~\ref{lemma:gradient_page}, and the law of total expectation, we obtain
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \nu \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \rho \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\leq \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
      \norm{x^{t+1} - x^t}^2 + \gamma \norm{h^{t} - \nabla f(x^t)}^2}\nonumber\\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable}\Exp{\norm{g^{t} - h^t}^2}+ \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2}\Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2} \\
      &\quad + \frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \Exp{\frac{1}{n} \sum_{i=1}^n\norm{k^{t+1}_i}^2} \\
      &\quad  + \nu \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \rho \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &= \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
      \norm{x^{t+1} - x^t}^2 + \gamma \norm{h^{t} - \nabla f(x^t)}^2}\nonumber\\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable}\Exp{\norm{g^{t} - h^t}^2}+ \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2}\Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2} \\
      &\quad + \frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \Exp{\ExpSub{B}{\ExpSub{\probpage}{\frac{1}{n} \sum_{i=1}^n\norm{k^{t+1}_i}^2}}} \\
      &\quad  + \nu \Exp{\ExpSub{B}{\ExpSub{\probavailable}{\ExpSub{\probpage}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}}}} \\
      &\quad + \rho \Exp{\ExpSub{B}{\ExpSub{\probavailable}{\ExpSub{\probpage}{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}}}}\\
      &\leq \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
      \norm{x^{t+1} - x^t}^2 + \gamma \norm{h^{t} - \nabla f(x^t)}^2}\nonumber\\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable}\Exp{\norm{g^{t} - h^t}^2}+ \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2}\Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2} \\
      &\quad + \frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \Exp{\left(2 \widehat{L}^2 + \frac{(1 - \probpage)L_{\max}^2}{B}\right)\norm{x^{t+1} - x^{t}}^2 +  \frac{2b^2}{\probpage} \frac{1}{n}\sum_{i=1}^n \norm{h^t_i - \nabla f_i(x^{t})}^2} \\
      &\quad  + \nu {\rm E}\Bigg(\left(\frac{2 \left(\probavailable - \probpairaa\right) \widehat{L}^2}{n \probavailable^2} + \frac{(1 - \probpage)L_{\max}^2}{n \probavailable B}\right) \norm{x^{t+1} - x^{t}}^2\\
      &\qquad\quad + \frac{2\left(\probavailable - \probpairaa\right) b^2}{n^2 \probavailable^2 \probpage}\sum_{i=1}^n\norm{ h^t_i - \nabla f_i(x^{t})}^2 + \left(\probpage\left(1 - \frac{b}{\probpage}\right)^2 + (1 - \probpage)\right)\norm{h^{t} - \nabla f(x^{t})}^2\Bigg) \\
      &\quad + \rho {\rm E}\Bigg(\left(\frac{2\left(1 - \probavailable\right)\widehat{L}^2}{\probavailable} + \frac{(1 - \probpage)L_{\max}^2}{\probavailable B}\right) \norm{x^{t+1} - x^{t}}^2 \\
      &\qquad\quad +\left(\frac{2\left(1 - \probavailable\right)b^2}{\probavailable \probpage} + \probpage\left(1 - \frac{b}{\probpage}\right)^2 + (1 - \probpage)\right)\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2\Bigg)\\
    \end{align*}
    After rearranging the terms, we get
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \nu \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \rho \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} \\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &\quad - \Bigg(\frac{1}{2\gamma} - \frac{L}{2} - \frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \left(2 \widehat{L}^2 + \frac{(1 - \probpage)L_{\max}^2}{B}\right) \\
      &\qquad\quad - \nu\left(\frac{2 \left(\probavailable - \probpairaa\right) \widehat{L}^2}{n \probavailable^2} + \frac{(1 - \probpage)L_{\max}^2}{n \probavailable B}\right) - \rho \left(\frac{2\left(1 - \probavailable\right)\widehat{L}^2}{\probavailable} + \frac{(1 - \probpage)L_{\max}^2}{\probavailable B}\right)\Bigg) \Exp{\norm{x^{t+1} - x^t}^2} \\
      &\quad + \left(\gamma + \nu \left(\probpage\left(1 - \frac{b}{\probpage}\right)^2 + (1 - \probpage)\right)\right) \Exp{\norm{h^{t} - \nabla f(x^{t})}^2} \\
      &\quad + \Bigg(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2 \probpage} + \frac{2 \nu \left(\probavailable - \probpairaa\right) b^2}{n \probavailable^2 \probpage} \\
      &\qquad\quad+ \rho \left(\frac{2\left(1 - \probavailable\right)b^2}{\probavailable \probpage} + \probpage\left(1 - \frac{b}{\probpage}\right)^2 + (1 - \probpage)\right)\Bigg)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2}.
    \end{align*}
    Due to $b = \frac{\probpage \probavailable}{2 - \probavailable} \leq \probpage,$ one can show that $\left(\probpage\left(1 - \frac{b}{\probpage}\right)^2 + (1 - \probpage)\right) \leq 1 - b.$ 
    Thus, if we take $\nu = \frac{\gamma}{b},$ then
    $$\left(\gamma + \nu \left(\probpage\left(1 - \frac{b}{\probpage}\right)^2 + (1 - \probpage)\right)\right) \leq \gamma + \nu (1 - b) = \nu,$$ therefore
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \frac{\gamma}{b} \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \rho \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} \\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &\quad - \Bigg(\frac{1}{2\gamma} - \frac{L}{2} - \frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \left(2 \widehat{L}^2 + \frac{(1 - \probpage)L_{\max}^2}{B}\right) \\
      &\qquad\quad - \frac{\gamma}{b}\left(\frac{2 \left(\probavailable - \probpairaa\right) \widehat{L}^2}{n \probavailable^2} + \frac{(1 - \probpage)L_{\max}^2}{n \probavailable B}\right) - \rho \left(\frac{2\left(1 - \probavailable\right)\widehat{L}^2}{\probavailable} + \frac{(1 - \probpage)L_{\max}^2}{\probavailable B}\right)\Bigg) \Exp{\norm{x^{t+1} - x^t}^2} \\
      &\quad + \frac{\gamma}{b}\Exp{\norm{h^{t} - \nabla f(x^{t})}^2} \\
      &\quad + \Bigg(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2 \probpage} + \frac{2 \gamma \left(\probavailable - \probpairaa\right) b}{n \probavailable^2 \probpage} \\
      &\qquad\quad+ \rho \left(\frac{2\left(1 - \probavailable\right)b^2}{\probavailable \probpage} + \probpage\left(1 - \frac{b}{\probpage}\right)^2 + (1 - \probpage)\right)\Bigg)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2}.
    \end{align*}
    Next, with the choice of $b = \frac{\probpage \probavailable}{2 - \probavailable},$ we ensure that
    $$\left(\frac{2\left(1 - \probavailable\right)b^2}{\probavailable \probpage} + \probpage\left(1 - \frac{b}{\probpage}\right)^2 + (1 - \probpage)\right) \leq 1 - b.$$ If we take $\rho = \frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2 \probpage} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2 \probpage},$ then
    $$\Bigg(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2 \probpage} + \frac{2 \gamma \left(\probavailable - \probpairaa\right) b}{n \probavailable^2 \probpage}+ \rho \left(\frac{2\left(1 - \probavailable\right)b^2}{\probavailable \probpage} + \probpage\left(1 - \frac{b}{\probpage}\right)^2 + (1 - \probpage)\right)\Bigg) \leq \rho,$$ therefore
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \frac{\gamma}{b} \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2 \probpage} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2 \probpage}\right) \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} \\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &\quad - \Bigg(\frac{1}{2\gamma} - \frac{L}{2} - \frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \left(2 \widehat{L}^2 + \frac{(1 - \probpage)L_{\max}^2}{B}\right) \\
      &\qquad\quad - \frac{\gamma}{b n \probavailable}\left(2 \left(1 - \frac{\probpairaa}{\probavailable}\right) \widehat{L}^2 + \frac{(1 - \probpage)L_{\max}^2}{B}\right) \\
      &\qquad\quad- \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^3 \probpage} + \frac{2 \gamma \left(1 - \frac{\probpairaa}{\probavailable}\right)}{n \probavailable^2 \probpage}\right) \left(2\left(1 - \probavailable\right)\widehat{L}^2 + \frac{(1 - \probpage)L_{\max}^2}{B}\right)\Bigg) \Exp{\norm{x^{t+1} - x^t}^2} \\
      &\quad + \frac{\gamma}{b}\Exp{\norm{h^{t} - \nabla f(x^{t})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2 \probpage} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2 \probpage}\right)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2}.
    \end{align*}
    Let us simplify the inequality. First, due to $b \geq \frac{\probpage \probavailable}{2},$ we have
    $$\frac{\gamma}{b n \probavailable}\left(2 \left(1 - \frac{\probpairaa}{\probavailable}\right) \widehat{L}^2 + \frac{(1 - \probpage)L_{\max}^2}{B}\right) \leq \frac{4 \gamma}{n \probavailable^2 \probpage}\left(\left(1 - \frac{\probpairaa}{\probavailable}\right) \widehat{L}^2 + \frac{(1 - \probpage)L_{\max}^2}{B}\right).$$
    Second, due to $b \leq \probavailable \probpage$ and $\probpairaa \leq \probavailable^2$, we get
    \begin{align*}
      &\left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^3 \probpage} + \frac{2 \gamma \left(1 - \frac{\probpairaa}{\probavailable}\right)}{n \probavailable^2 \probpage}\right) \left(2\left(1 - \probavailable\right)\widehat{L}^2 + \frac{(1 - \probpage)L_{\max}^2}{B}\right) \\
      &\leq \left(\frac{8 \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(1 - \frac{\probpairaa}{\probavailable}\right)}{n \probavailable^2 \probpage}\right) \left(2\left(1 - \frac{\probpairaa}{\probavailable}\right)\widehat{L}^2 + \frac{(1 - \probpage)L_{\max}^2}{B}\right) \\
      &\leq \frac{16 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \left(\left(1 - \frac{\probpairaa}{\probavailable}\right)\widehat{L}^2 + \frac{(1 - \probpage)L_{\max}^2}{B}\right) \\
      &\quad + \frac{4 \gamma \left(1 - \frac{\probpairaa}{\probavailable}\right)}{n \probavailable^2 \probpage} \left(\left(1 - \frac{\probpairaa}{\probavailable}\right)\widehat{L}^2 + \frac{(1 - \probpage)L_{\max}^2}{B}\right) \\
      &\leq \frac{16 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \left(\widehat{L}^2 + \frac{(1 - \probpage)L_{\max}^2}{B}\right) \\
      &\quad + \frac{4 \gamma}{n \probavailable^2 \probpage} \left(\left(1 - \frac{\probpairaa}{\probavailable}\right)\widehat{L}^2 + \frac{(1 - \probpage)L_{\max}^2}{B}\right).
    \end{align*}
    Combining all bounds together, we obtain the following simplified inequality:
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \frac{\gamma}{b} \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2 \probpage} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2 \probpage}\right) \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} \\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &\quad - \Bigg(\frac{1}{2\gamma} - \frac{L}{2} - \frac{24 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \left(\widehat{L}^2 + \frac{(1 - \probpage)L_{\max}^2}{B}\right) \\
      &\qquad\quad - \frac{8 \gamma}{n \probavailable^2 \probpage} \left(\left(1 - \frac{\probpairaa}{\probavailable}\right)\widehat{L}^2 + \frac{(1 - \probpage)L_{\max}^2}{B}\right)\Bigg) \Exp{\norm{x^{t+1} - x^t}^2} \\
      &\quad + \frac{\gamma}{b}\Exp{\norm{h^{t} - \nabla f(x^{t})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2 \probpage} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2 \probpage}\right)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2}.
    \end{align*}
    Using Lemma~\ref{lemma:gamma} and the assumption about $\gamma,$ we get
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \frac{\gamma}{b} \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2 \probpage} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2 \probpage}\right) \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} \\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &\quad + \frac{\gamma}{b}\Exp{\norm{h^{t} - \nabla f(x^{t})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2 \probpage} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2 \probpage}\right)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2}.
    \end{align*}
    It is left to apply Lemma~\ref{lemma:good_recursion} with 
    \begin{eqnarray*}
      \Psi^t &=& \frac{(2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{(\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &\quad& + \frac{1}{b}\Exp{\norm{h^{t} - \nabla f(x^{t})}^2} + \left(\frac{8 b \omega (2 \omega + 1)}{n \probavailable^2 \probpage} + \frac{2 \left(\probavailable - \probpairaa\right)}{n \probavailable^2 \probpage}\right)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2}
    \end{eqnarray*}
    to conclude the proof.
  \end{proof}

\subsection{Proof for \algname{DASHA-PP-FINITE-MVR}}

\begin{lemma}
  \label{lemma:finite_mvr}
  Suppose that Assumptions \ref{ass:nodes_lipschitz_constant}, \ref{ass:max_lipschitz_constant}, and \ref{ass:partial_participation} hold. For $h^{t+1}_i$, $h^{t+1}_{ij}$ and $k^{t+1}_i$ from Algorithm~\ref{alg:main_algorithm} (\algname{DASHA-PP-FINITE-MVR}) we have
  \begin{enumerate}
  \item
      \begin{align*}
          &\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}} \\
          & \leq \left(\frac{2 L_{\max}^2}{n \probavailable B} + \frac{2 \left(\probavailable - \probpairaa\right) \widehat{L}^2}{n \probavailable^2}\right)\norm{x^{t+1} - x^{t}}^2  \\
          &\quad + \frac{2\left(\probavailable - \probpairaa\right)b^2}{n^2 \probavailable^2}\sum_{i=1}^n\norm{h^t_{i} - \nabla f_{i}(x^{t})}^2 + \frac{2b^2}{n^2 \probavailable B m}\sum_{i=1}^n\sum_{j=1}^m\norm{h^t_{ij} - \nabla f_{ij}(x^{t})}^2 \\
          &\quad + (1 - b)^2\norm{h^{t} - \nabla f(x^{t})}^2.
      \end{align*}
  \item
      \begin{align*}
          &\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}} \\
          & \leq \left(\frac{2 L_{\max}^2}{\probavailable B} +\frac{2(1 - \probavailable) L_i^2}{\probavailable}\right) \norm{x^{t+1} - x^{t}}^2 \\
          &\quad + \frac{2 b^2}{\probavailable B m} \sum_{j=1}^m\norm{h^t_{ij} - \nabla f_{ij}(x^{t})}^2 +\left(\frac{2 \left(1 - \probavailable\right) b^2}{\probavailable} + (1 - b)^2\right)\norm{h^{t}_i - \nabla f_i(x^{t})}^2, \quad \forall i \in [n].
      \end{align*}
  \item
      \begin{align*}
          &\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{ij} - \nabla f_{ij}(x^{t+1})}^2}} \\
          & \leq \frac{2\left(1 - \frac{\probavailable B}{m}\right) L_{\max}^2}{\frac{\probavailable B}{m}} \norm{x^{t+1} - x^{t}}^2 \\
          &\quad + \left(\frac{2\left(1 - \frac{\probavailable B}{m}\right) b^2}{\frac{\probavailable B}{m}} + (1 - b)^2\right) \norm{h^t_{ij} - \nabla f_{ij}(x^{t})}^2, \quad \forall i \in [n], \forall j \in [m].
      \end{align*}
  \item
      \begin{align*}
        &\ExpSub{B}{\norm{k^{t+1}_i}^2} \\
        &\leq \left(\frac{2 L_{\max}^2}{B} + 2 L_i^2\right)\norm{x^{t+1} - x^{t}}^2 \\
        &\quad + \frac{2 b^2}{B m}\sum_{j=1}^m\norm{h^t_{ij} - \nabla f_{ij}(x^{t})}^2 + 2 b^2 \norm{h^t_i - \nabla f_i(x^{t})}^2, \quad \forall i \in [n].
      \end{align*}
  \end{enumerate}
\end{lemma}

\begin{proof}
  We start by proving the first inequality. Note that
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_i}} \\
    & =\probavailable \left(h^t_i + \frac{1}{\probavailable}\ExpSub{B}{k^{t+1}_i}\right) + (1 - \probavailable) h^t_i \\
    & =h^t_i + \frac{1}{m}\sum_{j=1}^m \frac{B}{m} \cdot \frac{m}{B}\left(\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t}) - b \left(h^t_{ij} - \nabla f_{ij}(x^{t})\right)\right) + \left(1 - \frac{B}{m}\right) \cdot 0 \\
    & =\nabla f_{i}(x^{t+1}) + (1 - b) \left(h^t_{i} - \nabla f_{i}(x^{t})\right),
  \end{align*}
  thus
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}} \\
    &\overset{\eqref{auxiliary:variance_decomposition}}{=}\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}}}}^2}} + (1 - b)^2\norm{h^{t} - \nabla f(x^{t})}^2.
  \end{align*}
  We can use Lemma~\ref{lemma:sampling} with $r_i = h^{t}_i$ and $s_i = k^{t+1}_i$ to obtain
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}} \\
    &\leq \frac{1}{n^2 \probavailable}\sum_{i=1}^n\ExpSub{B}{\norm{k^{t+1}_i - \ExpSub{B}{k^{t+1}_i}}^2} +\frac{\probavailable - \probpairaa}{n^2 \probavailable^2}\sum_{i=1}^n\norm{\ExpSub{B}{k^{t+1}_i}}^2 \\
    &\quad + (1 - b)^2\norm{h^{t} - \nabla f(x^{t})}^2\\
    &= \frac{1}{n^2 \probavailable}\sum_{i=1}^n\ExpSub{B}{\norm{\frac{1}{m}\sum_{j=1}^m k^{t+1}_{ij} - \left(\nabla f_{i}(x^{t+1}) - \nabla f_{i}(x^{t}) - b \left(h^t_{i} - \nabla f_{i}(x^{t})\right)\right)}^2} \\
    &\quad +\frac{\probavailable - \probpairaa}{n^2 \probavailable^2}\sum_{i=1}^n\norm{\nabla f_{i}(x^{t+1}) - \nabla f_{i}(x^{t}) - b \left(h^t_{i} - \nabla f_{i}(x^{t})\right)}^2 \\
    &\quad + (1 - b)^2\norm{h^{t} - \nabla f(x^{t})}^2.
  \end{align*}
  Next, we again use Lemma~\ref{lemma:sampling} with $r_i = 0,$ $s_i = \nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t}) - b \left(h^t_{ij} - \nabla f_{ij}(x^{t})\right), $ $\probavailable = \frac{B}{m},$ and $\probpairaa = \frac{B(B-1)}{m(m-1)}$:
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}} \\
    &\leq \frac{1}{n^2 \probavailable}\sum_{i=1}^n\left(\frac{m - B}{B m (m - 1)}\sum_{j=1}^m\norm{\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t}) - b \left(h^t_{ij} - \nabla f_{ij}(x^{t})\right)}^2\right) \\
    &\quad +\frac{\probavailable - \probpairaa}{n^2 \probavailable^2}\sum_{i=1}^n\norm{\nabla f_{i}(x^{t+1}) - \nabla f_{i}(x^{t}) - b \left(h^t_{i} - \nabla f_{i}(x^{t})\right)}^2 \\
    &\quad + (1 - b)^2\norm{h^{t} - \nabla f(x^{t})}^2\\
    &\leq \frac{1}{n^2 \probavailable B m}\sum_{i=1}^n\sum_{j=1}^m\norm{\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t}) - b \left(h^t_{ij} - \nabla f_{ij}(x^{t})\right)}^2 \\
    &\quad +\frac{\probavailable - \probpairaa}{n^2 \probavailable^2}\sum_{i=1}^n\norm{\nabla f_{i}(x^{t+1}) - \nabla f_{i}(x^{t}) - b \left(h^t_{i} - \nabla f_{i}(x^{t})\right)}^2 \\
    &\quad + (1 - b)^2\norm{h^{t} - \nabla f(x^{t})}^2\\
    &\overset{\eqref{auxiliary:jensen_inequality}}{\leq} \frac{2}{n^2 \probavailable B m}\sum_{i=1}^n\sum_{j=1}^m\norm{\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})}^2 + \frac{2b^2}{n^2 \probavailable B m}\sum_{i=1}^n\sum_{j=1}^m\norm{h^t_{ij} - \nabla f_{ij}(x^{t})}^2 \\
    &\quad +\frac{2 \left(\probavailable - \probpairaa\right)}{n^2 \probavailable^2}\sum_{i=1}^n\norm{\nabla f_{i}(x^{t+1}) - \nabla f_{i}(x^{t})}^2 + \frac{2\left(\probavailable - \probpairaa\right)b^2}{n^2 \probavailable^2}\sum_{i=1}^n\norm{h^t_{i} - \nabla f_{i}(x^{t})}^2 \\
    &\quad + (1 - b)^2\norm{h^{t} - \nabla f(x^{t})}^2.
  \end{align*}
  Due to Assumptions \ref{ass:nodes_lipschitz_constant} and \ref{ass:max_lipschitz_constant}, we have
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}} \\
    &\leq \left(\frac{2 L_{\max}^2}{n \probavailable B} + \frac{2 \left(\probavailable - \probpairaa\right) \widehat{L}^2}{n \probavailable^2}\right)\norm{x^{t+1} - x^{t}}^2  \\
    &\quad + \frac{2\left(\probavailable - \probpairaa\right)b^2}{n^2 \probavailable^2}\sum_{i=1}^n\norm{h^t_{i} - \nabla f_{i}(x^{t})}^2 + \frac{2b^2}{n^2 \probavailable B m}\sum_{i=1}^n\sum_{j=1}^m\norm{h^t_{ij} - \nabla f_{ij}(x^{t})}^2 \\
    &\quad + (1 - b)^2\norm{h^{t} - \nabla f(x^{t})}^2.
  \end{align*}
  Let us get the bound for the second inequality:
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}} \\
    &\overset{\eqref{auxiliary:variance_decomposition}}{=}\ExpSub{B}{\ExpSub{\probavailable}{ \norm{h^{t+1}_i - \left(\nabla f_i(x^{t+1}) + (1 - b)(h^t_i - \nabla f_i(x^{t}))\right)}^2}} \\
    &\quad +(1 - b)^2\norm{h^{t}_i - \nabla f_i(x^{t})}^2 \\
    &=\probavailable\ExpSub{B}{\norm{h^{t}_i + \frac{1}{\probavailable}k^{t+1}_i - \left(\nabla f_i(x^{t+1}) + (1 - b)(h^t_i - \nabla f_i(x^{t}))\right)}^2} \\
    &\quad +(1 - \probavailable)\norm{h^{t}_i - \left(\nabla f_i(x^{t+1}) + (1 - b)(h^t_i - \nabla f_i(x^{t}))\right)}^2 \\
    &\quad +(1 - b)^2\norm{h^{t}_i - \nabla f_i(x^{t})}^2 \\
    &\overset{\eqref{auxiliary:variance_decomposition}}{=}\frac{1}{\probavailable} \ExpSub{B}{\norm{k^{t+1}_i - \ExpSub{B}{k^{t+1}_i}}^2} \\
    &\quad +\frac{1 - \probavailable}{\probavailable} \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad +(1 - b)^2\norm{h^{t}_i - \nabla f_i(x^{t})}^2.
  \end{align*}
  Let us use Lemma~\ref{lemma:sampling} with $r_i = 0,$ $s_i = \nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t}) - b \left(h^t_{ij} - \nabla f_{ij}(x^{t})\right), $ $\probavailable = \frac{B}{m},$ and $\probpairaa = \frac{B(B-1)}{m(m-1)}$:
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}} \\
    &\leq\frac{1}{\probavailable} \left(\frac{m - B}{B m (m - 1)}\sum_{j=1}^m\norm{\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t}) - b \left(h^t_{ij} - \nabla f_{ij}(x^{t})\right)}^2\right) \\
    &\quad +\frac{1 - \probavailable}{\probavailable} \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad +(1 - b)^2\norm{h^{t}_i - \nabla f_i(x^{t})}^2 \\
    &\leq\frac{1}{\probavailable B m} \sum_{j=1}^m\norm{\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t}) - b \left(h^t_{ij} - \nabla f_{ij}(x^{t})\right)}^2 \\
    &\quad +\frac{1 - \probavailable}{\probavailable} \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad +(1 - b)^2\norm{h^{t}_i - \nabla f_i(x^{t})}^2 \\
    &\overset{\eqref{auxiliary:jensen_inequality}}{\leq}\frac{2}{\probavailable B m} \sum_{j=1}^m\norm{\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})}^2 +\frac{2(1 - \probavailable)}{\probavailable} \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})}^2 \\
    &\quad + \frac{2 b^2}{\probavailable B m} \sum_{j=1}^m\norm{h^t_{ij} - \nabla f_{ij}(x^{t})}^2 +\left(\frac{2 \left(1 - \probavailable\right) b^2}{\probavailable} + (1 - b)^2\right)\norm{h^{t}_i - \nabla f_i(x^{t})}^2 \\
    &\leq\left(\frac{2 L_{\max}^2}{\probavailable B} +\frac{2(1 - \probavailable) L_i^2}{\probavailable}\right) \norm{x^{t+1} - x^{t}}^2 \\
    &\quad + \frac{2 b^2}{\probavailable B m} \sum_{j=1}^m\norm{h^t_{ij} - \nabla f_{ij}(x^{t})}^2 +\left(\frac{2 \left(1 - \probavailable\right) b^2}{\probavailable} + (1 - b)^2\right)\norm{h^{t}_i - \nabla f_i(x^{t})}^2,
  \end{align*}
  where we used Assumptions \ref{ass:nodes_lipschitz_constant} and \ref{ass:max_lipschitz_constant}. We continue the proof by considering $\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{ij} - \nabla f_{ij}(x^{t+1})}^2}}$:
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{ij} - \nabla f_{ij}(x^{t+1})}^2}} \\
    &\overset{\eqref{auxiliary:variance_decomposition}}{=}\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{ij} - \left(\nabla f_{ij}(x^{t+1}) + (1 - b)(h^t_{ij} - \nabla f_{ij}(x^{t}))\right)}^2}} \\
    &\quad +(1 - b)^2\norm{h^{t}_{ij} - \nabla f_{ij}(x^{t})}^2 \\
    &=\frac{\probavailable B}{m} \ExpSub{B}{\norm{h^{t}_{ij} + \frac{m}{B\probavailable}\left(\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t}) - b \left(h^t_{ij} - \nabla f_{ij}(x^{t})\right)\right) - \left(\nabla f_{ij}(x^{t+1}) + (1 - b)(h^t_{ij} - \nabla f_{ij}(x^{t}))\right)}^2} \\
    &\quad + \left(1 - \frac{\probavailable B}{m}\right) \norm{h^{t}_{ij} - \left(\nabla f_{ij}(x^{t+1}) + (1 - b)(h^t_{ij} - \nabla f_{ij}(x^{t}))\right)}^2 \\
    &\quad +(1 - b)^2\norm{h^{t}_{ij} - \nabla f_{ij}(x^{t})}^2 \\
    &=\frac{\left(1 - \frac{\probavailable B}{m}\right)^2}{\frac{\probavailable B}{m}}\norm{\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t}) - b(h^t_{ij} - \nabla f_{ij}(x^{t}))}^2 \\
    &\quad + \left(1 - \frac{\probavailable B}{m}\right) \norm{\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t}) - b(h^t_{ij} - \nabla f_{ij}(x^{t}))}^2 \\
    &\quad +(1 - b)^2\norm{h^{t}_{ij} - \nabla f_{ij}(x^{t})}^2 \\
    &= \frac{\left(1 - \frac{\probavailable B}{m}\right)}{\frac{\probavailable B}{m}} \norm{\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t}) - b(h^t_{ij} - \nabla f_{ij}(x^{t}))}^2 \\
    &\quad +(1 - b)^2\norm{h^{t}_{ij} - \nabla f_{ij}(x^{t})}^2 \\
    &\overset{\eqref{auxiliary:jensen_inequality}}{\leq} \frac{2\left(1 - \frac{\probavailable B}{m}\right)}{\frac{\probavailable B}{m}} \norm{\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})}^2 + \left(\frac{2\left(1 - \frac{\probavailable B}{m}\right) b^2}{\frac{\probavailable B}{m}} + (1 - b)^2\right) \norm{h^t_{ij} - \nabla f_{ij}(x^{t})}^2. \\
  \end{align*}
  It is left to consider Assumption \ref{ass:max_lipschitz_constant}:
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{ij} - \nabla f_{ij}(x^{t+1})}^2}} \\
    &\leq \frac{2\left(1 - \frac{\probavailable B}{m}\right) L_{\max}^2}{\frac{\probavailable B}{m}} \norm{x^{t+1} - x^{t}}^2 + \left(\frac{2\left(1 - \frac{\probavailable B}{m}\right) b^2}{\frac{\probavailable B}{m}} + (1 - b)^2\right) \norm{h^t_{ij} - \nabla f_{ij}(x^{t})}^2. \\
  \end{align*}
  Finally, we obtain the bound for the last inequality of the lemma:
  \begin{align*}
    &\ExpSub{B}{\norm{k^{t+1}_i}^2}\\
    &\overset{\eqref{auxiliary:variance_decomposition}}{=}\ExpSub{B}{\norm{k^{t+1}_i - \ExpSub{B}{k^{t+1}_i}}^2}\\
    &\quad + \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2.
  \end{align*}
  Using the same reasoning with Lemma~\ref{lemma:sampling} as before, we get
  \begin{align*}
    &\ExpSub{B}{\norm{k^{t+1}_i}^2}\\
    &\leq\frac{m - B}{B m (m - 1)}\sum_{j=1}^m\norm{\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t}) - b \left(h^t_{ij} - \nabla f_{ij}(x^{t})\right)}^2\\
    &\quad + \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\leq\frac{1}{B m}\sum_{j=1}^m\norm{\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t}) - b \left(h^t_{ij} - \nabla f_{ij}(x^{t})\right)}^2\\
    &\quad + \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\overset{\eqref{auxiliary:jensen_inequality}}{\leq}\frac{2}{B m}\sum_{j=1}^m\norm{\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})}^2 + 2 \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})}^2\\
    &\quad + \frac{2 b^2}{B m}\sum_{j=1}^m\norm{h^t_{ij} - \nabla f_{ij}(x^{t})}^2 + 2 b^2 \norm{h^t_i - \nabla f_i(x^{t})}^2 \\
    &\leq\left(\frac{2 L_{\max}^2}{B} + 2 L_i^2\right)\norm{x^{t+1} - x^{t}}^2 \\
    &\quad + \frac{2 b^2}{B m}\sum_{j=1}^m\norm{h^t_{ij} - \nabla f_{ij}(x^{t})}^2 + 2 b^2 \norm{h^t_i - \nabla f_i(x^{t})}^2,
  \end{align*}
  where we used Assumptions \ref{ass:nodes_lipschitz_constant} and \ref{ass:max_lipschitz_constant}.
\end{proof}

\CONVERGENCEFINITEMVR*

\begin{proof}
  Let us fix constants $\nu, \rho, \delta \in [0,\infty)$ that we will define later. Considering Lemma~\ref{lemma:main_lemma}, Lemma~\ref{lemma:finite_mvr}, and the law of total expectation, we obtain
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \nu \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \rho \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\quad + \delta \Exp{\frac{1}{nm}\sum_{i=1}^n\sum_{j=1}^m\norm{h^{t+1}_{ij} - \nabla f_{ij}(x^{t+1})}^2} \\
      &\leq \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
      \norm{x^{t+1} - x^t}^2 + \gamma \norm{h^{t} - \nabla f(x^t)}^2}\nonumber\\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable}\Exp{\norm{g^{t} - h^t}^2}+ \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2}\Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2} \\
      &\quad + \frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \Exp{\frac{1}{n} \sum_{i=1}^n\norm{k^{t+1}_i}^2} \\
      &\quad  + \nu \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \rho \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\quad + \delta \Exp{\frac{1}{nm}\sum_{i=1}^n\sum_{j=1}^m\norm{h^{t+1}_{ij} - \nabla f_{ij}(x^{t+1})}^2} \\
      &= \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
      \norm{x^{t+1} - x^t}^2 + \gamma \norm{h^{t} - \nabla f(x^t)}^2}\nonumber\\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable}\Exp{\norm{g^{t} - h^t}^2}+ \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2}\Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2} \\
      &\quad + \frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \Exp{\ExpSub{B}{\frac{1}{n} \sum_{i=1}^n\norm{k^{t+1}_i}^2}} \\
      &\quad  + \nu \Exp{\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}}} \\
      &\quad + \rho \Exp{\ExpSub{B}{\ExpSub{\probavailable}{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}}}\\
      &\quad + \delta \Exp{\ExpSub{B}{\ExpSub{\probavailable}{\frac{1}{nm}\sum_{i=1}^n\sum_{j=1}^m\norm{h^{t+1}_{ij} - \nabla f_{ij}(x^{t+1})}^2}}} \\
      &\leq \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
      \norm{x^{t+1} - x^t}^2 + \gamma \norm{h^{t} - \nabla f(x^t)}^2}\nonumber\\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable}\Exp{\norm{g^{t} - h^t}^2}+ \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2}\Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2} \\
      &\quad + \frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \Exp{\left(\frac{2 L_{\max}^2}{B} + 2 \widehat{L}^2\right)\norm{x^{t+1} - x^{t}}^2 + \frac{2 b^2}{B m n}\sum_{i=1}^n \sum_{j=1}^m\norm{h^t_{ij} - \nabla f_{ij}(x^{t})}^2 + \frac{2 b^2}{n} \sum_{i=1}^n \norm{h^t_i - \nabla f_i(x^{t})}^2} \\
      &\quad  + \nu {\rm E}\Bigg(\left(\frac{2 L_{\max}^2}{n \probavailable B} + \frac{2 \left(\probavailable - \probpairaa\right) \widehat{L}^2}{n \probavailable^2}\right)\norm{x^{t+1} - x^{t}}^2  \\
      &\qquad\quad + \frac{2\left(\probavailable - \probpairaa\right)b^2}{n^2 \probavailable^2}\sum_{i=1}^n\norm{h^t_{i} - \nabla f_{i}(x^{t})}^2 + \frac{2b^2}{n^2 \probavailable B m}\sum_{i=1}^n\sum_{j=1}^m\norm{h^t_{ij} - \nabla f_{ij}(x^{t})}^2\\
      &\qquad\quad + (1 - b)^2\norm{h^{t} - \nabla f(x^{t})}^2\Bigg) \\
      &\quad + \rho {\rm E}\Bigg(\left(\frac{2 L_{\max}^2}{\probavailable B} +\frac{2(1 - \probavailable) \widehat{L}^2}{\probavailable}\right) \norm{x^{t+1} - x^{t}}^2 \\
      &\qquad\quad + \frac{2 b^2}{\probavailable B n m} \sum_{i=1}^n \sum_{j=1}^m\norm{h^t_{ij} - \nabla f_{ij}(x^{t})}^2 +\left(\frac{2 \left(1 - \probavailable\right) b^2}{\probavailable} + (1 - b)^2\right) \frac{1}{n} \sum_{i=1}^n \norm{h^{t}_i - \nabla f_i(x^{t})}^2\Bigg)\\
      &\quad + \delta {\rm E}\Bigg(\frac{2\left(1 - \frac{\probavailable B}{m}\right) L_{\max}^2}{\frac{\probavailable B}{m}} \norm{x^{t+1} - x^{t}}^2 \\
      &\qquad\quad + \left(\frac{2\left(1 - \frac{\probavailable B}{m}\right) b^2}{\frac{\probavailable B}{m}} + (1 - b)^2\right) \frac{1}{nm} \sum_{i=1}^n \sum_{j=1}^m \norm{h^t_{ij} - \nabla f_{ij}(x^{t})}^2\Bigg).\\
    \end{align*}
    Due to $b = \frac{\frac{\probavailable B}{m}}{2 - \frac{\probavailable B}{m}} \leq \frac{\probavailable}{2 - \probavailable},$ we have 
    $$\left(\frac{2\left(1 - \frac{\probavailable B}{m}\right) b^2}{\frac{\probavailable B}{m}} + (1 - b)^2\right) \leq 1 - b$$
    and
    $$\left(\frac{2 \left(1 - \probavailable\right) b^2}{\probavailable} + (1 - b)^2\right) \leq 1 - b.$$
    Moreover, we consider that $1 - \frac{\probavailable B}{m} \leq 1,$ therefore
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \nu \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \rho \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\quad + \delta \Exp{\frac{1}{nm}\sum_{i=1}^n\sum_{j=1}^m\norm{h^{t+1}_{ij} - \nabla f_{ij}(x^{t+1})}^2} \\
      &\leq \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
      \norm{x^{t+1} - x^t}^2 + \gamma \norm{h^{t} - \nabla f(x^t)}^2}\nonumber\\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable}\Exp{\norm{g^{t} - h^t}^2}+ \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2}\Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2} \\
      &\quad + \frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \Exp{\left(\frac{2 L_{\max}^2}{B} + 2 \widehat{L}^2\right)\norm{x^{t+1} - x^{t}}^2 + \frac{2 b^2}{B m n}\sum_{i=1}^n \sum_{j=1}^m\norm{h^t_{ij} - \nabla f_{ij}(x^{t})}^2 + \frac{2 b^2}{n} \sum_{i=1}^n \norm{h^t_i - \nabla f_i(x^{t})}^2} \\
      &\quad  + \nu {\rm E}\Bigg(\left(\frac{2 L_{\max}^2}{n \probavailable B} + \frac{2 \left(\probavailable - \probpairaa\right) \widehat{L}^2}{n \probavailable^2}\right)\norm{x^{t+1} - x^{t}}^2  \\
      &\qquad\quad + \frac{2\left(\probavailable - \probpairaa\right)b^2}{n^2 \probavailable^2}\sum_{i=1}^n\norm{h^t_{i} - \nabla f_{i}(x^{t})}^2 + \frac{2b^2}{n^2 \probavailable B m}\sum_{i=1}^n\sum_{j=1}^m\norm{h^t_{ij} - \nabla f_{ij}(x^{t})}^2 \\
      &\qquad\quad + (1 - b)^2\norm{h^{t} - \nabla f(x^{t})}^2\Bigg) \\
      &\quad + \rho {\rm E}\Bigg(\left(\frac{2 L_{\max}^2}{\probavailable B} +\frac{2(1 - \probavailable) \widehat{L}^2}{\probavailable}\right) \norm{x^{t+1} - x^{t}}^2 \\
      &\qquad\quad + \frac{2 b^2}{\probavailable B n m} \sum_{i=1}^n \sum_{j=1}^m\norm{h^t_{ij} - \nabla f_{ij}(x^{t})}^2 +\left(1 - b\right) \frac{1}{n} \sum_{i=1}^n \norm{h^{t}_i - \nabla f_i(x^{t})}^2\Bigg)\\
      &\quad + \delta {\rm E}\Bigg(\frac{2 m L_{\max}^2}{\probavailable B} \norm{x^{t+1} - x^{t}}^2 + \left(1 - b\right) \frac{1}{nm} \sum_{i=1}^n \sum_{j=1}^m \norm{h^t_{ij} - \nabla f_{ij}(x^{t})}^2\Bigg).
    \end{align*}
    After rearranging the terms, we get
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \nu \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \rho \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\quad + \delta \Exp{\frac{1}{nm}\sum_{i=1}^n\sum_{j=1}^m\norm{h^{t+1}_{ij} - \nabla f_{ij}(x^{t+1})}^2} \\
      &\leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} \\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &\quad - \Bigg(\frac{1}{2\gamma} - \frac{L}{2} - \frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \left(\frac{2 L_{\max}^2}{B} + 2 \widehat{L}^2\right) \\
      &\qquad\quad - \nu\left(\frac{2 L_{\max}^2}{n \probavailable B} + \frac{2 \left(\probavailable - \probpairaa\right) \widehat{L}^2}{n \probavailable^2}\right) - \rho \left(\frac{2 L_{\max}^2}{\probavailable B} +\frac{2(1 - \probavailable) \widehat{L}^2}{\probavailable}\right) - \delta \frac{2 m L_{\max}^2}{\probavailable B} \Bigg) \Exp{\norm{x^{t+1} - x^t}^2} \\
      &\quad + \left(\gamma + \nu \left(1 - b\right)^2\right) \Exp{\norm{h^{t} - \nabla f(x^{t})}^2} \\
      &\quad + \Bigg(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \nu \left(\probavailable - \probpairaa\right) b^2}{n \probavailable^2} + \rho \left(1 - b\right)\Bigg)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2} \\
      &\quad + \Bigg(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2 B} + \frac{2 \nu b^2}{n \probavailable B} + \frac{2 \rho b^2}{\probavailable B} + \delta \left(1 - b\right)\Bigg)\Exp{\frac{1}{nm}\sum_{i=1}^n\sum_{j=1}^m\norm{h^{t}_{ij} - \nabla f_{ij}(x^{t})}^2}.
    \end{align*}
    Thus, if we take $\nu = \frac{\gamma}{b},$ then $\gamma + \nu \left(1 - b\right)^2 \leq \nu$ and
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \frac{\gamma}{b} \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \rho \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\quad + \delta \Exp{\frac{1}{nm}\sum_{i=1}^n\sum_{j=1}^m\norm{h^{t+1}_{ij} - \nabla f_{ij}(x^{t+1})}^2} \\
      &\leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} \\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &\quad - \Bigg(\frac{1}{2\gamma} - \frac{L}{2} - \frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \left(\frac{2 L_{\max}^2}{B} + 2 \widehat{L}^2\right) \\
      &\qquad\quad - \left(\frac{2 \gamma L_{\max}^2}{b n \probavailable B} + \frac{2 \gamma \left(\probavailable - \probpairaa\right) \widehat{L}^2}{b n \probavailable^2}\right) - \rho \left(\frac{2 L_{\max}^2}{\probavailable B} +\frac{2(1 - \probavailable) \widehat{L}^2}{\probavailable}\right) - \delta \frac{2 m L_{\max}^2}{\probavailable B} \Bigg) \Exp{\norm{x^{t+1} - x^t}^2} \\
      &\quad + \frac{\gamma}{b} \Exp{\norm{h^{t} - \nabla f(x^{t})}^2} \\
      &\quad + \Bigg(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right) b}{n \probavailable^2} + \rho \left(1 - b\right)\Bigg)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2} \\
      &\quad + \Bigg(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2 B} + \frac{2 \gamma b}{n \probavailable B} + \frac{2 \rho b^2}{\probavailable B} + \delta \left(1 - b\right)\Bigg)\Exp{\frac{1}{nm}\sum_{i=1}^n\sum_{j=1}^m\norm{h^{t}_{ij} - \nabla f_{ij}(x^{t})}^2}.
    \end{align*}
    Next, if we take $\rho = \frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2},$ then
    $$\Bigg(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right) b}{n \probavailable^2} + \rho \left(1 - b\right)\Bigg) = \rho,$$ therefore
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \frac{\gamma}{b} \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right) \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\quad + \delta \Exp{\frac{1}{nm}\sum_{i=1}^n\sum_{j=1}^m\norm{h^{t+1}_{ij} - \nabla f_{ij}(x^{t+1})}^2} \\
      &\leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} \\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &\quad - \Bigg(\frac{1}{2\gamma} - \frac{L}{2} - \frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \left(\frac{2 L_{\max}^2}{B} + 2 \widehat{L}^2\right) \\
      &\qquad\quad - \left(\frac{2 \gamma L_{\max}^2}{b n \probavailable B} + \frac{2 \gamma \left(\probavailable - \probpairaa\right) \widehat{L}^2}{b n \probavailable^2}\right) - \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right) \left(\frac{2 L_{\max}^2}{\probavailable B} +\frac{2(1 - \probavailable) \widehat{L}^2}{\probavailable}\right) \\
      &\qquad\quad - \delta \frac{2 m L_{\max}^2}{\probavailable B} \Bigg) \Exp{\norm{x^{t+1} - x^t}^2} \\
      &\quad + \frac{\gamma}{b} \Exp{\norm{h^{t} - \nabla f(x^{t})}^2} \\
      &\quad + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2} \\
      &\quad + \Bigg(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2 B} + \frac{2 \gamma b}{n \probavailable B} + \frac{16 b^3 \gamma \omega (2 \omega + 1)}{n \probavailable^3 B} + \frac{4 b^2 \gamma \left(\probavailable - \probpairaa\right)}{n B \probavailable^3} + \delta \left(1 - b\right)\Bigg)\Exp{\frac{1}{nm}\sum_{i=1}^n\sum_{j=1}^m\norm{h^{t}_{ij} - \nabla f_{ij}(x^{t})}^2}.
    \end{align*}
    Due to $b \leq \probavailable$ and $\frac{\probavailable - \probpairaa}{\probavailable} \leq 1,$ we have
    \begin{align*}
      &\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2 B} + \frac{2 \gamma b}{n \probavailable B} + \frac{16 b^3 \gamma \omega (2 \omega + 1)}{n \probavailable^3 B} + \frac{4 b^2 \gamma \left(\probavailable - \probpairaa\right)}{n B \probavailable^3} \\
      &\leq \frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2 B} + \frac{2 \gamma b}{n \probavailable B} + \frac{16 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2 B} + \frac{4 \gamma b}{n \probavailable B} \\
      &=\frac{24 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2 B} + \frac{6 \gamma b}{n \probavailable B}.
    \end{align*}
    Let us take $\delta = \frac{24 b \gamma \omega (2 \omega + 1)}{n \probavailable^2 B} + \frac{6 \gamma }{n \probavailable B}.$ Thus
    \begin{align*}
      \Bigg(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2 B} + \frac{2 \gamma b}{n \probavailable B} + \frac{16 b^3 \gamma \omega (2 \omega + 1)}{n \probavailable^3 B} + \frac{4 b^2 \gamma \left(\probavailable - \probpairaa\right)}{n B \probavailable^3} + \delta \left(1 - b\right)\Bigg) \leq \delta
    \end{align*}
    and
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \frac{\gamma}{b} \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right) \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\quad + \left(\frac{24 b \gamma \omega (2 \omega + 1)}{n \probavailable^2 B} + \frac{6 \gamma }{n \probavailable B}\right) \Exp{\frac{1}{nm}\sum_{i=1}^n\sum_{j=1}^m\norm{h^{t+1}_{ij} - \nabla f_{ij}(x^{t+1})}^2} \\
      &\leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} \\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &\quad - \Bigg(\frac{1}{2\gamma} - \frac{L}{2} - \frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \left(\frac{2 L_{\max}^2}{B} + 2 \widehat{L}^2\right) \\
      &\qquad\quad - \left(\frac{2 \gamma L_{\max}^2}{b n \probavailable B} + \frac{2 \gamma \left(\probavailable - \probpairaa\right) \widehat{L}^2}{b n \probavailable^2}\right) - \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right) \left(\frac{2 L_{\max}^2}{\probavailable B} +\frac{2(1 - \probavailable) \widehat{L}^2}{\probavailable}\right) \\
      &\qquad\quad - \left(\frac{24 b \gamma \omega (2 \omega + 1)}{n \probavailable^2 B} + \frac{6 \gamma }{n \probavailable B}\right) \frac{2 m L_{\max}^2}{\probavailable B} \Bigg) \Exp{\norm{x^{t+1} - x^t}^2} \\
      &\quad + \frac{\gamma}{b} \Exp{\norm{h^{t} - \nabla f(x^{t})}^2} \\
      &\quad + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2} \\
      &\quad + \left(\frac{24 b \gamma \omega (2 \omega + 1)}{n \probavailable^2 B} + \frac{6 \gamma }{n \probavailable B}\right)\Exp{\frac{1}{nm}\sum_{i=1}^n\sum_{j=1}^m\norm{h^{t}_{ij} - \nabla f_{ij}(x^{t})}^2}.
    \end{align*}

    Let us simplify the term near $\Exp{\norm{x^{t+1} - x^t}^2}.$ Due to $b \leq \probavailable$, $\frac{\probavailable - \probpairaa}{\probavailable} \leq 1,$ and $1 - \probavailable \leq 1,$ 
    we have 
    \begin{align*}
      &\frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \left(\frac{2 L_{\max}^2}{B} + 2 \widehat{L}^2\right) \\
      &\quad + \left(\frac{2 \gamma L_{\max}^2}{b n \probavailable B} + \frac{2 \gamma \left(\probavailable - \probpairaa\right) \widehat{L}^2}{b n \probavailable^2}\right) \\
      &\quad + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right) \left(\frac{2 L_{\max}^2}{\probavailable B} +\frac{2(1 - \probavailable) \widehat{L}^2}{\probavailable}\right) \\
      &\quad + \left(\frac{24 b \gamma \omega (2 \omega + 1)}{n \probavailable^2 B} + \frac{6 \gamma }{n \probavailable B}\right) \frac{2 m L_{\max}^2}{\probavailable B} \\
      &\leq \frac{12 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \left(\frac{2 L_{\max}^2}{B} + 2 \widehat{L}^2\right) \\
      &\quad + \left(\frac{6 \gamma L_{\max}^2}{b n \probavailable B} + \frac{6 \gamma \left(\probavailable - \probpairaa\right) \widehat{L}^2}{b n \probavailable^2}\right) \\
      &\quad + \left(\frac{24 b \gamma \omega (2 \omega + 1)}{n \probavailable^2 B} + \frac{6 \gamma }{n \probavailable B}\right) \frac{2 m L_{\max}^2}{\probavailable B}
    \end{align*}
    Considering that $b \leq \frac{\probavailable B}{m}$ and $b \geq \frac{\probavailable B}{2 m},$ we obtain
    \begin{align*}
      &\frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \left(\frac{2 L_{\max}^2}{B} + 2 \widehat{L}^2\right) \\
      &\quad + \left(\frac{2 \gamma L_{\max}^2}{b n \probavailable B} + \frac{2 \gamma \left(\probavailable - \probpairaa\right) \widehat{L}^2}{b n \probavailable^2}\right) \\
      &\quad + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right) \left(\frac{2 L_{\max}^2}{\probavailable B} +\frac{2(1 - \probavailable) \widehat{L}^2}{\probavailable}\right) \\
      &\quad + \left(\frac{24 b \gamma \omega (2 \omega + 1)}{n \probavailable^2 B} + \frac{6 \gamma }{n \probavailable B}\right) \frac{2 m L_{\max}^2}{\probavailable B} \\
      &\leq \frac{36 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \left(\frac{2 L_{\max}^2}{B} + 2 \widehat{L}^2\right) + \left(\frac{18 \gamma L_{\max}^2}{b n \probavailable B} + \frac{6 \gamma \left(\probavailable - \probpairaa\right) \widehat{L}^2}{b n \probavailable^2}\right) \\
      &\leq \frac{36 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \left(\frac{2 L_{\max}^2}{B} + 2 \widehat{L}^2\right) + \left(\frac{36 m \gamma L_{\max}^2}{n \probavailable^2 B^2} + \frac{12 m \gamma \left(\probavailable - \probpairaa\right) \widehat{L}^2}{B n \probavailable^3}\right).
    \end{align*}
    All in all, we have
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \frac{\gamma}{b} \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right) \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\quad + \left(\frac{24 b \gamma \omega (2 \omega + 1)}{n \probavailable^2 B} + \frac{6 \gamma }{n \probavailable B}\right) \Exp{\frac{1}{nm}\sum_{i=1}^n\sum_{j=1}^m\norm{h^{t+1}_{ij} - \nabla f_{ij}(x^{t+1})}^2} \\
      &\leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} \\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &\quad - \Bigg(\frac{1}{2\gamma} - \frac{L}{2} - \frac{36 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \left(\frac{2 L_{\max}^2}{B} + 2 \widehat{L}^2\right) - \left(\frac{36 m \gamma L_{\max}^2}{n \probavailable^2 B^2} + \frac{12 m \gamma \left(\probavailable - \probpairaa\right) \widehat{L}^2}{B n \probavailable^3}\right) \Bigg) \Exp{\norm{x^{t+1} - x^t}^2} \\
      &\quad + \frac{\gamma}{b} \Exp{\norm{h^{t} - \nabla f(x^{t})}^2} \\
      &\quad + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2} \\
      &\quad + \left(\frac{24 b \gamma \omega (2 \omega + 1)}{n \probavailable^2 B} + \frac{6 \gamma }{n \probavailable B}\right)\Exp{\frac{1}{nm}\sum_{i=1}^n\sum_{j=1}^m\norm{h^{t}_{ij} - \nabla f_{ij}(x^{t})}^2}.
    \end{align*}
    Using Lemma~\ref{lemma:gamma} and the assumption about $\gamma,$ we get
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \frac{\gamma}{b} \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right) \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\quad + \left(\frac{24 b \gamma \omega (2 \omega + 1)}{n \probavailable^2 B} + \frac{6 \gamma }{n \probavailable B}\right) \Exp{\frac{1}{nm}\sum_{i=1}^n\sum_{j=1}^m\norm{h^{t+1}_{ij} - \nabla f_{ij}(x^{t+1})}^2} \\
      &\leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} \\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &\quad + \frac{\gamma}{b} \Exp{\norm{h^{t} - \nabla f(x^{t})}^2} \\
      &\quad + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2} \\
      &\quad + \left(\frac{24 b \gamma \omega (2 \omega + 1)}{n \probavailable^2 B} + \frac{6 \gamma }{n \probavailable B}\right)\Exp{\frac{1}{nm}\sum_{i=1}^n\sum_{j=1}^m\norm{h^{t}_{ij} - \nabla f_{ij}(x^{t})}^2}.
    \end{align*}
    It is left to apply Lemma~\ref{lemma:good_recursion} with 
    \begin{eqnarray*}
      \Psi^t &=& \frac{1}{b} \Exp{\norm{h^{t} - \nabla f(x^{t})}^2} \\
      &\quad& + \left(\frac{8 b \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2} \\
      &\quad& + \left(\frac{24 b \omega (2 \omega + 1)}{n \probavailable^2 B} + \frac{6}{n \probavailable B}\right)\Exp{\frac{1}{nm}\sum_{i=1}^n\sum_{j=1}^m\norm{h^{t}_{ij} - \nabla f_{ij}(x^{t})}^2}
    \end{eqnarray*}
    to conclude the proof.
\end{proof}

\subsection{Proof for \algname{DASHA-PP-MVR}}

Let us denote $\nabla f_i(x^{t+1};\xi^{t+1}_i) \eqdef \frac{1}{B} \sum_{j=1}^B \nabla f_i(x^{t+1};\xi^{t+1}_{ij}).$

\begin{lemma}
  Suppose that Assumptions \ref{ass:nodes_lipschitz_constant}, \ref{ass:stochastic_unbiased_and_variance_bounded}, \ref{ass:mean_square_smoothness} and \ref{ass:partial_participation} hold. For $h^{t+1}_i$ and $k^{t+1}_i$ from Algorithm~\ref{alg:main_algorithm} (\algname{DASHA-PP-MVR}) we have
  \begin{enumerate}
  \item
      \begin{align*}
          &\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}} \\
          & \leq \frac{2 b^2 \sigma^2}{n \probavailable B} + \left(\frac{2 (1 - b)^2 L_{\sigma}^2}{n \probavailable B} + \frac{2\left(\probavailable - \probpairaa\right) \widehat{L}^2}{n \probavailable^2} \right) \norm{x^{t+1} - x^{t}}^2\\
          &\quad + \frac{2 \left(\probavailable - \probpairaa\right) b^2}{n^2 \probavailable^2} \sum_{i=1}^n \norm{h^t_i - \nabla f_i(x^{t})}^2 + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2.
      \end{align*}
  \item
      \begin{align*}
          &\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}} \\
          & \leq \frac{2 b^2 \sigma^2}{\probavailable B}  + \left(\frac{2 (1 - b)^2 L_{\sigma}^2}{\probavailable B} + \frac{2(1 - \probavailable) L_i^2}{\probavailable}\right)\norm{x^{t+1} - x^{t}}^2 \\
          &\quad + \left(\frac{2 (1 - \probavailable) b^2}{\probavailable} + (1 - b)^2\right)\norm{h^t_i - \nabla f_i(x^{t})}^2, \quad \forall i \in [n].
      \end{align*}
  \item
      \begin{align*}
        &\ExpSub{k}{\norm{k^{t+1}_i}^2} \leq \frac{2 b^2 \sigma^2}{B} + \left(\frac{2 (1 - b)^2 L_{\sigma}^2}{B} + 2 L_i^2\right)\norm{x^{t+1} - x^{t}}^2 + 2 b^2 \norm{h^t_i - \nabla f_i(x^{t})}^2, \quad \forall i \in [n].
      \end{align*}
  \end{enumerate}
\end{lemma}

\begin{proof}
  First, let us proof the bound for $\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}}$:
  \begin{align*}
      &\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}} \\
      &=\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1} - \ExpSub{k}{\ExpSub{\probavailable}{h^{t+1}}}}^2}} + \norm{\ExpSub{k}{\ExpSub{\probavailable}{h^{t+1}}} - \nabla f(x^{t+1})}^2.
  \end{align*}
  Using
  \begin{align*}
      \ExpSub{k}{\ExpSub{\probavailable}{h^{t+1}_i}} = h^{t}_i + \ExpSub{k}{k^{t+1}_i} = h^{t}_i + \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))
  \end{align*}
  and \eqref{auxiliary:variance_decomposition}, we have
  \begin{align*}
    &\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}} \\
    &=\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1} - \ExpSub{k}{\ExpSub{\probavailable}{h^{t+1}}}}^2}} + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2.
  \end{align*}
  We can use Lemma~\ref{lemma:sampling} with $r_i = h^{t}_i$ and $s_i = k^{t+1}_i$ to obtain
  \begin{align*}
    &\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}} \\
    &\leq \frac{1}{n^2 \probavailable}\sum_{i=1}^n\ExpSub{k}{\norm{k^{t+1}_i - \ExpSub{k}{k^{t+1}_i}}^2} +\frac{\probavailable - \probpairaa}{n^2 \probavailable^2}\sum_{i=1}^n\norm{\ExpSub{k}{k^{t+1}_i}}^2 + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2\\
    &= \frac{1}{n^2 \probavailable}\sum_{i=1}^n\ExpSub{k}{\norm{\nabla f_i(x^{t+1};\xi^{t+1}_i) - \nabla f_i(x^{t};\xi^{t+1}_i) - b \left(h^t_i - \nabla f_i(x^{t};\xi^{t+1}_i)\right) \right.\right.\\
    &\left.\left. \quad- \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b \left(h^t_i - \nabla f_i(x^{t})\right)\right)}^2} \\
    &\quad +\frac{\probavailable - \probpairaa}{n^2 \probavailable^2}\sum_{i=1}^n\norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b \left(h^t_i - \nabla f_i(x^{t})\right)}^2 \\
    &\quad + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2 \\
    &\overset{\eqref{auxiliary:jensen_inequality}}{\leq} \frac{2}{n^2 \probavailable}\sum_{i=1}^n \ExpSub{k}{\norm{b \left(\nabla f_i(x^{t+1};\xi^{t+1}_i) - \nabla f_i(x^{t+1})\right)}^2} \\
    & \quad + \frac{2}{n^2 \probavailable}\sum_{i=1}^n \ExpSub{k}{\norm{(1 - b)\left(\nabla f_i(x^{t+1};\xi^{t+1}_i) - \nabla f_i(x^{t};\xi^{t+1}_i) - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)\right)}^2} \\
    &\quad + \frac{\probavailable - \probpairaa}{n^2 \probavailable^2} \sum_{i=1}^n \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2 \\
    &= \frac{2 b^2}{n^2 \probavailable}\sum_{i=1}^n \ExpSub{k}{\norm{\nabla f_i(x^{t+1};\xi^{t+1}_i) - \nabla f_i(x^{t+1})}^2} \\
    & \quad + \frac{2 (1 - b)^2}{n^2 \probavailable}\sum_{i=1}^n \ExpSub{k}{\norm{\nabla f_i(x^{t+1};\xi^{t+1}_i) - \nabla f_i(x^{t};\xi^{t+1}_i) - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}^2} \\
    &\quad + \frac{\probavailable - \probpairaa}{n^2 \probavailable^2} \sum_{i=1}^n \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2. \\
    &= \frac{2 b^2}{n^2 \probavailable B^2}\sum_{i=1}^n \sum_{j=1}^B \ExpSub{k}{\norm{\nabla f_i(x^{t+1};\xi^{t+1}_{ij}) - \nabla f_i(x^{t+1})}^2} \\
    & \quad + \frac{2 (1 - b)^2}{n^2 \probavailable}\sum_{i=1}^n \ExpSub{k}{\norm{\nabla f_i(x^{t+1};\xi^{t+1}_i) - \nabla f_i(x^{t};\xi^{t+1}_i) - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}^2} \\
    &\quad + \frac{\probavailable - \probpairaa}{n^2 \probavailable^2} \sum_{i=1}^n \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2.
  \end{align*}
  In the last equality, we use the independence of elements in the mini-batches. Due to Assumption~\ref{ass:stochastic_unbiased_and_variance_bounded}, we get
  \begin{align*}
    &\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}} \\
    &\leq \frac{2 b^2 \sigma^2}{n \probavailable B}\\
    & \quad + \frac{2 (1 - b)^2}{n^2 \probavailable}\sum_{i=1}^n \ExpSub{k}{\norm{\nabla f_i(x^{t+1};\xi^{t+1}_i) - \nabla f_i(x^{t};\xi^{t+1}_i) - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}^2} \\
    &\quad + \frac{\probavailable - \probpairaa}{n^2 \probavailable^2} \sum_{i=1}^n \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2 \\
    &\overset{\eqref{auxiliary:jensen_inequality}}{\leq} \frac{2 b^2 \sigma^2}{n \probavailable B}\\
    & \quad + \frac{2 (1 - b)^2}{n^2 \probavailable}\sum_{i=1}^n \ExpSub{k}{\norm{\nabla f_i(x^{t+1};\xi^{t+1}_i) - \nabla f_i(x^{t};\xi^{t+1}_i) - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}^2} \\
    &\quad + \frac{2\left(\probavailable - \probpairaa\right)}{n^2 \probavailable^2} \sum_{i=1}^n \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})}^2 + \frac{2 \left(\probavailable - \probpairaa\right) b^2}{n^2 \probavailable^2} \sum_{i=1}^n \norm{h^t_i - \nabla f_i(x^{t})}^2 \\
    &\quad + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2. \\
    &= \frac{2 b^2 \sigma^2}{n \probavailable B}\\
    & \quad + \frac{2 (1 - b)^2}{n^2 \probavailable B^2}\sum_{i=1}^n \sum_{j=1}^B \ExpSub{k}{\norm{\nabla f_i(x^{t+1};\xi^{t+1}_{ij}) - \nabla f_i(x^{t};\xi^{t+1}_{ij}) - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}^2} \\
    &\quad + \frac{2\left(\probavailable - \probpairaa\right)}{n^2 \probavailable^2} \sum_{i=1}^n \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})}^2 + \frac{2 \left(\probavailable - \probpairaa\right) b^2}{n^2 \probavailable^2} \sum_{i=1}^n \norm{h^t_i - \nabla f_i(x^{t})}^2 \\
    &\quad + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2, \\
  \end{align*}
  where we use the independence of elements in the mini-batches.
  Using Assumptions~\ref{ass:nodes_lipschitz_constant} and \ref{ass:mean_square_smoothness}, we obtain
  \begin{align*}
    &\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}} \\
    &\leq \frac{2 b^2 \sigma^2}{n \probavailable B} + \left(\frac{2 (1 - b)^2 L_{\sigma}^2}{n \probavailable B} + \frac{2\left(\probavailable - \probpairaa\right) \widehat{L}^2}{n \probavailable^2} \right) \norm{x^{t+1} - x^{t}}^2\\
    &\quad + \frac{2 \left(\probavailable - \probpairaa\right) b^2}{n^2 \probavailable^2} \sum_{i=1}^n \norm{h^t_i - \nabla f_i(x^{t})}^2 + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2.
  \end{align*}
  Now, we prove the second inequality:
  % \alexander{Alternative approach:}
  % \begin{align*}
  %   &\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}} \\
  %   &=\probavailable \ExpSub{k}{\norm{h^t_i + \frac{1}{\probavailable}k^{t+1}_i - \nabla f_i(x^{t+1})}^2} \\
  %   &\quad +(1 - \probavailable) \ExpSub{k}{\norm{h^t_i - \nabla f_i(x^{t+1})}^2} \\
  %   &=\probavailable \norm{h^t_i + \frac{1}{\probavailable}k^{t+1}_i - \nabla f_i(x^{t+1})}^2 \\
  %   &\quad +(1 - \probavailable) \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) + \nabla f_i(x^{t}) - h^t_i}^2 \\
  %   &\leq\probavailable \ExpSub{k}{\norm{h^t_i + \frac{1}{\probavailable}k^{t+1}_i - \nabla f_i(x^{t+1})}^2} \\
  %   &\quad +(1 - \probavailable) \ExpSub{k}{\norm{h^t_i - \nabla f_i(x^{t+1})}^2} \\
  %   &=\frac{1}{\probavailable} \ExpSub{k}{\norm{k^{t+1}_i - \ExpSub{k}{k^{t+1}_i}}^2} \\
  %   &\quad + \probavailable \ExpSub{k}{\norm{h^t_i + \frac{1}{\probavailable}\left( \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b \left(h^t_i - f_i(x^{t})\right)\right) - \nabla f_i(x^{t+1})}^2} \\
  %   &\quad +(1 - \probavailable) \ExpSub{k}{\norm{h^t_i - \nabla f_i(x^{t+1})}^2} \\
  %   &=\frac{1}{\probavailable} \ExpSub{k}{\norm{k^{t+1}_i - \ExpSub{k}{k^{t+1}_i}}^2} \\
  %   &\quad + \probavailable \norm{h^t_i + \frac{1}{\probavailable}\left( \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b \left(h^t_i - f_i(x^{t})\right)\right) - \nabla f_i(x^{t+1})}^2 \\
  %   &\quad +(1 - \probavailable) \ExpSub{k}{\norm{h^t_i - \nabla f_i(x^{t+1})}^2} \\
  %   &=\frac{1}{\probavailable} \ExpSub{k}{\norm{k^{t+1}_i - \ExpSub{k}{k^{t+1}_i}}^2} \\
  %   &\quad + \probavailable \norm{h^t_i + \frac{1}{\probavailable}\left( \nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right) - \nabla f_i(x^{t+1}) - \frac{b}{\probavailable} \left(h^t_i - f_i(x^{t})\right)}^2 \\
  %   &\quad +(1 - \probavailable) \ExpSub{k}{\norm{h^t_i - \nabla f_i(x^{t+1})}^2} \\
  %   &=\frac{1}{\probavailable} \ExpSub{k}{\norm{k^{t+1}_i - \ExpSub{k}{k^{t+1}_i}}^2} \\
  %   &\quad + \probavailable \norm{\left(\frac{1}{\probavailable} - 1\right)\left( \nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right) + \left(1 - \frac{b}{\probavailable}\right) \left(h^t_i - f_i(x^{t})\right)}^2 \\
  %   &\quad +(1 - \probavailable) \ExpSub{k}{\norm{h^t_i - \nabla f_i(x^{t+1})}^2} \\
  %   &=\frac{1}{\probavailable} \ExpSub{k}{\norm{\frac{1}{B}\sum_{j=1}^B \nabla f_i(x^{t+1};\xi^{t+1}_{ij}) - \frac{1}{B}\sum_{j=1}^B \nabla f_i(x^{t};\xi^{t+1}_{ij}) - b \left(h^t_i - \frac{1}{B}\sum_{j=1}^B \nabla f_i(x^{t};\xi^{t+1}_{ij})\right) - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b \left(h^t_i - \nabla f_i(x^{t})\right)\right)}^2} \\
  %   &\quad + \probavailable \norm{\left(\frac{1}{\probavailable} - 1\right)\left( \nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right) + \left(1 - \frac{b}{\probavailable}\right) \left(h^t_i - f_i(x^{t})\right)}^2 \\
  %   &\quad +(1 - \probavailable) \ExpSub{k}{\norm{h^t_i - \nabla f_i(x^{t+1})}^2} \\
  % \end{align*}
  % \alexander{Normal approach (It is better to understand the difference):}
  \begin{align*}
    &\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}} \\
    &=\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1}_i - \ExpSub{k}{\ExpSub{\probavailable}{h^{t+1}_i}}}^2}} \\
    &\quad + \norm{\ExpSub{k}{\ExpSub{\probavailable}{h^{t+1}_i}} - \nabla f_i(x^{t+1})}^2 \\
    &=\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1}_i - \left(h^{t}_i + \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))\right)}^2}} \\
    &\quad + \norm{h^{t}_i + \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t})) - \nabla f_i(x^{t+1})}^2 \\
    &=\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1}_i - \left(h^{t}_i + \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))\right)}^2}} \\
    &\quad + (1 - b)^2\norm{h^t_i - \nabla f_i(x^{t})}^2 \\
    &=\probavailable \ExpSub{k}{\norm{h^{t}_i + \frac{1}{\probavailable}k^{t+1}_i - \left(h^{t}_i + \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))\right)}^2} \\
    &\quad + (1 - \probavailable)\norm{h^{t}_i - \left(h^{t}_i + \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))\right)}^2 \\
    &\quad + (1 - b)^2\norm{h^t_i - \nabla f_i(x^{t})}^2 \\
    &=\probavailable \ExpSub{k}{\norm{\frac{1}{\probavailable}k^{t+1}_i - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))\right)}^2} \\
    &\quad + (1 - \probavailable)\norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad + (1 - b)^2\norm{h^t_i - \nabla f_i(x^{t})}^2 \\
    &\overset{\eqref{auxiliary:variance_decomposition}}{=}\frac{1}{\probavailable} \ExpSub{k}{\norm{k^{t+1}_i - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))\right)}^2} \\
    &\quad + \frac{(1 - \probavailable)^2}{\probavailable} \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad + (1 - \probavailable)\norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad + (1 - b)^2\norm{h^t_i - \nabla f_i(x^{t})}^2 \\
    &=\frac{1}{\probavailable} \ExpSub{k}{\norm{\nabla f_i(x^{t+1};\xi^{t+1}_{i}) - \nabla f_i(x^{t};\xi^{t+1}_{i}) - b \left(h^t_i - \nabla f_i(x^{t};\xi^{t+1}_{i})\right) - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))\right)}^2} \\
    &\quad + \frac{1 - \probavailable}{\probavailable} \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad + (1 - b)^2\norm{h^t_i - \nabla f_i(x^{t})}^2 \\
    &=\frac{1}{\probavailable} \ExpSub{k}{\norm{b \left(\nabla f_i(x^{t+1};\xi^{t+1}_{i}) - \nabla f_i(x^{t+1})\right) + (1 - b) \left(\nabla f_i(x^{t+1};\xi^{t+1}_{i}) - \nabla f_i(x^{t};\xi^{t+1}_{i}) - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)\right)}^2} \\
    &\quad + \frac{1 - \probavailable}{\probavailable} \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad + (1 - b)^2\norm{h^t_i - \nabla f_i(x^{t})}^2 \\
    &\overset{\eqref{auxiliary:jensen_inequality}}{\leq} \frac{2 b^2}{\probavailable} \ExpSub{k}{\norm{\nabla f_i(x^{t+1};\xi^{t+1}_{i}) - \nabla f_i(x^{t+1})}^2} \\
    &\quad + \frac{2 (1 - b)^2}{\probavailable} \ExpSub{k}{\norm{\nabla f_i(x^{t+1};\xi^{t+1}_{i}) - \nabla f_i(x^{t};\xi^{t+1}_{i}) - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}^2} \\
    &\quad + \frac{1 - \probavailable}{\probavailable} \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad + (1 - b)^2\norm{h^t_i - \nabla f_i(x^{t})}^2.
  \end{align*}
  Considering the independence of elements in the mini-batch, we obtain
  \begin{align*}
    &\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}} \\
    &= \frac{2 b^2}{\probavailable B^2} \sum_{j=1}^B \ExpSub{k}{\norm{\nabla f_i(x^{t+1};\xi^{t+1}_{ij}) - \nabla f_i(x^{t+1})}^2} \\
    &\quad + \frac{2 (1 - b)^2}{\probavailable B^2} \sum_{j=1}^B \ExpSub{k}{\norm{\nabla f_i(x^{t+1};\xi^{t+1}_{ij}) - \nabla f_i(x^{t};\xi^{t+1}_{ij}) - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}^2} \\
    &\quad + \frac{1 - \probavailable}{\probavailable} \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad + (1 - b)^2\norm{h^t_i - \nabla f_i(x^{t})}^2. \\
    &\overset{\eqref{auxiliary:jensen_inequality}}{\leq} \frac{2 b^2}{\probavailable B^2} \sum_{j=1}^B \ExpSub{k}{\norm{\nabla f_i(x^{t+1};\xi^{t+1}_{ij}) - \nabla f_i(x^{t+1})}^2} \\
    &\quad + \frac{2 (1 - b)^2}{\probavailable B^2} \sum_{j=1}^B \ExpSub{k}{\norm{\nabla f_i(x^{t+1};\xi^{t+1}_{ij}) - \nabla f_i(x^{t};\xi^{t+1}_{ij}) - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}^2} \\
    &\quad + \frac{2(1 - \probavailable)}{\probavailable} \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})}^2 + \left(\frac{2 (1 - \probavailable) b^2}{\probavailable} + (1 - b)^2\right)\norm{h^t_i - \nabla f_i(x^{t})}^2 \\
  \end{align*}
  Next, we use Assumptions~\ref{ass:nodes_lipschitz_constant}, \ref{ass:mean_square_smoothness}, \ref{ass:stochastic_unbiased_and_variance_bounded}, to get
  \begin{align*}
    &\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}} \\
    &\leq \frac{2 b^2 \sigma^2}{\probavailable B}  + \left(\frac{2 (1 - b)^2 L_{\sigma}^2}{\probavailable B} + \frac{2(1 - \probavailable) L_i^2}{\probavailable}\right)\norm{x^{t+1} - x^{t}}^2 \\
    &\quad + \left(\frac{2 (1 - \probavailable) b^2}{\probavailable} + (1 - b)^2\right)\norm{h^t_i - \nabla f_i(x^{t})}^2.\\
  \end{align*}
  It is left to prove the bound for $\ExpSub{k}{\norm{k^{t+1}_i}^2}$:
  \begin{align*}
    &\ExpSub{k}{\norm{k^{t+1}_i}^2} \\
    &= \ExpSub{k}{\norm{\nabla f_i(x^{t+1};\xi^{t+1}_{i}) - \nabla f_i(x^{t};\xi^{t+1}_{i}) - b \left(h^t_i - \nabla f_i(x^{t};\xi^{t+1}_{i})\right)}^2} \\
    &\overset{\eqref{auxiliary:variance_decomposition}}{=} \ExpSub{k}{\norm{\nabla f_i(x^{t+1};\xi^{t+1}_{i}) - \nabla f_i(x^{t};\xi^{t+1}_{i}) - b \left(h^t_i - \nabla f_i(x^{t};\xi^{t+1}_{i})\right) - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))\right)}^2} \\
    &\quad + \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &= \ExpSub{k}{\norm{b \left(\nabla f_i(x^{t+1};\xi^{t+1}_{i}) - \nabla f_i(x^{t+1})\right) + (1 - b) \left(\nabla f_i(x^{t+1};\xi^{t+1}_{i}) - \nabla f_i(x^{t};\xi^{t+1}_{i}) - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)\right)}^2} \\
    &\quad + \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\overset{\eqref{auxiliary:jensen_inequality}}{\leq} 2 b^2 \ExpSub{k}{\norm{\nabla f_i(x^{t+1};\xi^{t+1}_{i}) - \nabla f_i(x^{t+1})}^2} \\
    &\quad + 2 (1 - b)^2 \ExpSub{k}{\norm{\nabla f_i(x^{t+1};\xi^{t+1}_{i}) - \nabla f_i(x^{t};\xi^{t+1}_{i}) - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}^2} \\
    &\quad + 2 \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})}^2 + 2 b^2 \norm{h^t_i - \nabla f_i(x^{t})}^2.
  \end{align*}
  Using Assumptions~\ref{ass:nodes_lipschitz_constant}, \ref{ass:mean_square_smoothness}, \ref{ass:stochastic_unbiased_and_variance_bounded} and the independence of elements in the mini-batch, we get
  \begin{align*}
    &\ExpSub{k}{\norm{k^{t+1}_i}^2} \\
    &\leq \frac{2 b^2 \sigma^2}{B} + \left(\frac{2 (1 - b)^2 L_{\sigma}^2}{B} + 2 L_i^2\right)\norm{x^{t+1} - x^{t}}^2 + 2 b^2 \norm{h^t_i - \nabla f_i(x^{t})}^2.
  \end{align*}
\end{proof}

\CONVERGENCEMVR*

\begin{proof}
  Let us fix constants $\nu, \rho \in [0,\infty)$ that we will define later. Considering Lemma~\ref{lemma:main_lemma}, Lemma~\ref{lemma:gradient_page}, and the law of total expectation, we obtain
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \nu \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \rho \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\leq \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
      \norm{x^{t+1} - x^t}^2 + \gamma \norm{h^{t} - \nabla f(x^t)}^2}\nonumber\\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable}\Exp{\norm{g^{t} - h^t}^2}+ \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2}\Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2} \\
      &\quad + \frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \Exp{\frac{1}{n} \sum_{i=1}^n\norm{k^{t+1}_i}^2} \\
      &\quad  + \nu \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \rho \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &= \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
      \norm{x^{t+1} - x^t}^2 + \gamma \norm{h^{t} - \nabla f(x^t)}^2}\nonumber\\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable}\Exp{\norm{g^{t} - h^t}^2}+ \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2}\Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2} \\
      &\quad + \frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \Exp{\ExpSub{k}{\frac{1}{n} \sum_{i=1}^n\norm{k^{t+1}_i}^2}} \\
      &\quad  + \nu \Exp{\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}}} \\
      &\quad + \rho \Exp{\ExpSub{B}{\ExpSub{\probavailable}{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}}}\\
      &\leq \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
      \norm{x^{t+1} - x^t}^2 + \gamma \norm{h^{t} - \nabla f(x^t)}^2}\nonumber\\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable}\Exp{\norm{g^{t} - h^t}^2}+ \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2}\Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2} \\
      &\quad + \frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \Exp{\frac{2 b^2 \sigma^2}{B} + \left(\frac{2 (1 - b)^2 L_{\sigma}^2}{B} + 2 \widehat{L}^2\right)\norm{x^{t+1} - x^{t}}^2 + 2 b^2 \frac{1}{n} \sum_{i=1}^n \norm{h^t_i - \nabla f_i(x^{t})}^2} \\
      &\quad  + \nu {\rm E}\Bigg(\frac{2 b^2 \sigma^2}{n \probavailable B} + \left(\frac{2 (1 - b)^2 L_{\sigma}^2}{n \probavailable B} + \frac{2\left(\probavailable - \probpairaa\right) \widehat{L}^2}{n \probavailable^2} \right) \norm{x^{t+1} - x^{t}}^2\\
      &\qquad\quad + \frac{2 \left(\probavailable - \probpairaa\right) b^2}{n^2 \probavailable^2} \sum_{i=1}^n \norm{h^t_i - \nabla f_i(x^{t})}^2 + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2\Bigg) \\
      &\quad + \rho {\rm E}\Bigg(\frac{2 b^2 \sigma^2}{\probavailable B}  + \left(\frac{2 (1 - b)^2 L_{\sigma}^2}{\probavailable B} + \frac{2(1 - \probavailable) \widehat{L}^2}{\probavailable}\right)\norm{x^{t+1} - x^{t}}^2 \\
      &\qquad\quad + \left(\frac{2 (1 - \probavailable) b^2}{\probavailable} + (1 - b)^2\right) \frac{1}{n} \sum_{i=1}^n \norm{h^t_i - \nabla f_i(x^{t})}^2\Bigg).
    \end{align*}
    After rearranging the terms, we get
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \nu \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \rho \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} \\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &\quad - \Bigg(\frac{1}{2\gamma} - \frac{L}{2} - \frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \left(\frac{2 (1 - b)^2 L_{\sigma}^2}{B} + 2 \widehat{L}^2\right) \\
      &\qquad\quad - \nu\left(\frac{2 (1 - b)^2 L_{\sigma}^2}{n \probavailable B} + \frac{2\left(\probavailable - \probpairaa\right) \widehat{L}^2}{n \probavailable^2} \right) - \rho \left(\frac{2 (1 - b)^2 L_{\sigma}^2}{\probavailable B} + \frac{2(1 - \probavailable) \widehat{L}^2}{\probavailable}\right)\Bigg) \Exp{\norm{x^{t+1} - x^t}^2} \\
      &\quad + \left(\gamma + \nu \left(1 - b\right)^2\right) \Exp{\norm{h^{t} - \nabla f(x^{t})}^2} \\
      &\quad + \Bigg(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \nu \left(\probavailable - \probpairaa\right) b^2}{n \probavailable^2} + \rho \left(\frac{2 (1 - \probavailable) b^2}{\probavailable} + (1 - b)^2\right)\Bigg)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2} \\
      &\quad + \left(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \nu \frac{2 b^2}{n \probavailable} + \rho \frac{2 b^2}{\probavailable}\right) \frac{\sigma^2}{B}.
    \end{align*}
    By taking $\nu = \frac{\gamma}{b},$ one can show that $\left(\gamma + \nu (1 - b)^2\right) \leq \nu,$ and
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \frac{\gamma}{b} \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \rho \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} \\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &\quad - \Bigg(\frac{1}{2\gamma} - \frac{L}{2} - \frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \left(\frac{2 (1 - b)^2 L_{\sigma}^2}{B} + 2 \widehat{L}^2\right) \\
      &\qquad\quad - \frac{\gamma}{b}\left(\frac{2 (1 - b)^2 L_{\sigma}^2}{n \probavailable B} + \frac{2\left(\probavailable - \probpairaa\right) \widehat{L}^2}{n \probavailable^2} \right) - \rho \left(\frac{2 (1 - b)^2 L_{\sigma}^2}{\probavailable B} + \frac{2(1 - \probavailable) \widehat{L}^2}{\probavailable}\right)\Bigg) \Exp{\norm{x^{t+1} - x^t}^2} \\
      &\quad + \frac{\gamma}{b} \Exp{\norm{h^{t} - \nabla f(x^{t})}^2} \\
      &\quad + \Bigg(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right) b}{n \probavailable^2} + \rho \left(\frac{2 (1 - \probavailable) b^2}{\probavailable} + (1 - b)^2\right)\Bigg)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2} \\
      &\quad + \left(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma b}{n \probavailable} + \rho \frac{2 b^2}{\probavailable}\right) \frac{\sigma^2}{B}.
    \end{align*}
    Note that $b \leq \frac{\probavailable}{2 - \probavailable},$ thus
    \begin{align*}
      &\Bigg(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right) b}{n \probavailable^2} + \rho \left(\frac{2 (1 - \probavailable) b^2}{\probavailable} + (1 - b)^2\right)\Bigg) \\
      &\leq \Bigg(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right) b}{n \probavailable^2} + \rho \left(1 - b\right)\Bigg).
    \end{align*}
    And if we take $\rho = \frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2},$ then
    \begin{align*}
      \Bigg(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right) b}{n \probavailable^2} + \rho \left(1 - b\right)\Bigg) \leq \rho,
    \end{align*}
    and 
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \frac{\gamma}{b} \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right) \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} \\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &\quad - \Bigg(\frac{1}{2\gamma} - \frac{L}{2} - \frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \left(\frac{2 (1 - b)^2 L_{\sigma}^2}{B} + 2 \widehat{L}^2\right) \\
      &\qquad\quad - \frac{\gamma}{n \probavailable b}\left(\frac{2 (1 - b)^2 L_{\sigma}^2}{B} + 2\left(1 - \frac{\probpairaa}{\probavailable}\right) \widehat{L}^2 \right) \\
      &\qquad\quad - \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^3} + \frac{2 \gamma \left(1 - \frac{\probpairaa}{\probavailable}\right)}{n \probavailable^2}\right) \left(\frac{2 (1 - b)^2 L_{\sigma}^2}{B} + 2(1 - \probavailable) \widehat{L}^2\right)\Bigg) \Exp{\norm{x^{t+1} - x^t}^2} \\
      &\quad + \frac{\gamma}{b} \Exp{\norm{h^{t} - \nabla f(x^{t})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2} \\
      &\quad + \left(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma b}{n \probavailable} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right) \frac{2 b^2}{\probavailable}\right) \frac{\sigma^2}{B}.
    \end{align*}
    Let us simplify the inequality. First, due to $b \leq \probavailable$ and $\left(1 - \probavailable\right) \leq \left(1 - \frac{\probpairaa}{\probavailable}\right),$ we have
    \begin{align*}
      &\left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^3} + \frac{2 \gamma \left(1 - \frac{\probpairaa}{\probavailable}\right)}{n \probavailable^2}\right) \left(\frac{2 (1 - b)^2 L_{\sigma}^2}{B} + 2(1 - \probavailable) \widehat{L}^2\right) \\
      &=\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^3} \left(\frac{2 (1 - b)^2 L_{\sigma}^2}{B} + 2(1 - \probavailable) \widehat{L}^2\right) \\
      &\quad + \frac{2 \gamma \left(1 - \frac{\probpairaa}{\probavailable}\right)}{n \probavailable^2} \left(\frac{2 (1 - b)^2 L_{\sigma}^2}{B} + 2(1 - \probavailable) \widehat{L}^2\right) \\
      &\leq \frac{8 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \left(\frac{2 (1 - b)^2 L_{\sigma}^2}{B} + 2 \widehat{L}^2\right) \\
      &\quad + \frac{2 \gamma}{n \probavailable b} \left(\frac{2 (1 - b)^2 L_{\sigma}^2}{B} + 2\left(1 - \frac{\probpairaa}{\probavailable}\right) \widehat{L}^2\right),
    \end{align*}
    therefore
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \frac{\gamma}{b} \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right) \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} \\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &\quad - \Bigg(\frac{1}{2\gamma} - \frac{L}{2} - \frac{12 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \left(\frac{2 (1 - b)^2 L_{\sigma}^2}{B} + 2 \widehat{L}^2\right) \\
      &\qquad\quad - \frac{3 \gamma}{n \probavailable b}\left(\frac{2 (1 - b)^2 L_{\sigma}^2}{B} + 2\left(1 - \frac{\probpairaa}{\probavailable}\right) \widehat{L}^2 \right)\Bigg) \Exp{\norm{x^{t+1} - x^t}^2} \\
      &\quad + \frac{\gamma}{b} \Exp{\norm{h^{t} - \nabla f(x^{t})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2} \\
      &\quad + \left(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma b}{n \probavailable} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right) \frac{2 b^2}{\probavailable}\right) \frac{\sigma^2}{B} \\
      &= \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} \\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &\quad - \Bigg(\frac{1}{2\gamma} - \frac{L}{2} - \frac{24 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \left(\frac{(1 - b)^2 L_{\sigma}^2}{B} + \widehat{L}^2\right) \\
      &\qquad\quad - \frac{6 \gamma}{n \probavailable b}\left(\frac{(1 - b)^2 L_{\sigma}^2}{B} + \left(1 - \frac{\probpairaa}{\probavailable}\right) \widehat{L}^2 \right)\Bigg) \Exp{\norm{x^{t+1} - x^t}^2} \\
      &\quad + \frac{\gamma}{b} \Exp{\norm{h^{t} - \nabla f(x^{t})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2} \\
      &\quad + \left(\frac{8 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma b}{n \probavailable} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right) \frac{2 b^2}{\probavailable}\right) \frac{\sigma^2}{B}.
    \end{align*}
    Also, we can simplify the last term:
    \begin{align*}
      &\left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right) \frac{2 b^2}{\probavailable} \\
      &= \frac{16 b^3 \gamma \omega (2 \omega + 1)}{n \probavailable^3} + \frac{4 b^2 \gamma \left(1 - \frac{\probpairaa}{\probavailable}\right)}{n \probavailable^2} \\
      &\leq \frac{16 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{4 b \gamma}{n \probavailable},
    \end{align*}
    thus
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \frac{\gamma}{b} \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right) \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} \\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &\quad - \Bigg(\frac{1}{2\gamma} - \frac{L}{2} - \frac{24 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \left(\frac{(1 - b)^2 L_{\sigma}^2}{B} + \widehat{L}^2\right) \\
      &\qquad\quad - \frac{6 \gamma}{n \probavailable b}\left(\frac{(1 - b)^2 L_{\sigma}^2}{B} + \left(1 - \frac{\probpairaa}{\probavailable}\right) \widehat{L}^2 \right)\Bigg) \Exp{\norm{x^{t+1} - x^t}^2} \\
      &\quad + \frac{\gamma}{b} \Exp{\norm{h^{t} - \nabla f(x^{t})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2} \\
      &\quad + \left(\frac{24 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{6 \gamma b}{n \probavailable}\right) \frac{\sigma^2}{B}.
    \end{align*}
    Using Lemma~\ref{lemma:gamma} and the assumption about $\gamma,$ we get
    \begin{align*}
      &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\quad  + \frac{\gamma}{b} \Exp{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right) \Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}\\
      &\leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} \\
      &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &\quad + \frac{\gamma}{b} \Exp{\norm{h^{t} - \nabla f(x^{t})}^2} + \left(\frac{8 b \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \gamma \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2} \\
      &\quad + \left(\frac{24 b^2 \gamma \omega (2 \omega + 1)}{n \probavailable^2} + \frac{6 \gamma b}{n \probavailable}\right) \frac{\sigma^2}{B}.
    \end{align*}
    It is left to apply Lemma~\ref{lemma:good_recursion} with 
    \begin{eqnarray*}
      \Psi^t &=& \frac{(2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t} - h^{t}}^2} + \frac{(\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &+& \frac{1}{b} \Exp{\norm{h^{t} - \nabla f(x^{t})}^2} + \left(\frac{8 b \omega (2 \omega + 1)}{n \probavailable^2} + \frac{2 \left(\probavailable - \probpairaa\right)}{n \probavailable^2}\right)\Exp{\frac{1}{n}\sum_{i=1}^n\norm{h^{t}_i - \nabla f_i(x^{t})}^2}
    \end{eqnarray*}
    and $C = \left(\frac{24 b^2 \omega (2 \omega + 1)}{\probavailable^2} + \frac{6b}{\probavailable}\right) \frac{\sigma^2}{n B}$
    to conclude the proof.
  \end{proof}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section*{Checklist}

%%% BEGIN INSTRUCTIONS %%%
The checklist follows the references.  Please
read the checklist guidelines carefully for information on how to answer these
questions.  For each question, change the default \answerTODO{} to \answerYes{},
\answerNo{}, or \answerNA{}.  You are strongly encouraged to include a {\bf
justification to your answer}, either by referencing the appropriate section of
your paper or providing a brief inline description.  For example:
\begin{itemize}
  \item Did you include the license to the code and datasets? \answerYes{See Section~\ref{gen_inst}.}
  \item Did you include the license to the code and datasets? \answerNo{The code and the data are proprietary.}
  \item Did you include the license to the code and datasets? \answerNA{}
\end{itemize}
Please do not modify the questions and only use the provided macros for your
answers.  Note that the Checklist section does not count towards the page
limit.  In your paper, please delete this instructions block and only keep the
Checklist section heading above along with the questions/answers below.
%%% END INSTRUCTIONS %%%

\begin{enumerate}

\item For all authors...
\begin{enumerate}
  \item Do the main claims made in the abstract and introduction accurately reflect the paper's contributions and scope?
    \answerTODO{}
  \item Did you describe the limitations of your work?
    \answerTODO{}
  \item Did you discuss any potential negative societal impacts of your work?
    \answerTODO{}
  \item Have you read the ethics review guidelines and ensured that your paper conforms to them?
    \answerTODO{}
\end{enumerate}

\item If you are including theoretical results...
\begin{enumerate}
  \item Did you state the full set of assumptions of all theoretical results?
    \answerTODO{}
	\item Did you include complete proofs of all theoretical results?
    \answerTODO{}
\end{enumerate}

\item If you ran experiments...
\begin{enumerate}
  \item Did you include the code, data, and instructions needed to reproduce the main experimental results (either in the supplemental material or as a URL)?
    \answerTODO{}
  \item Did you specify all the training details (e.g., data splits, hyperparameters, how they were chosen)?
    \answerTODO{}
	\item Did you report error bars (e.g., with respect to the random seed after running experiments multiple times)?
    \answerTODO{}
	\item Did you include the total amount of compute and the type of resources used (e.g., type of GPUs, internal cluster, or cloud provider)?
    \answerTODO{}
\end{enumerate}

\item If you are using existing assets (e.g., code, data, models) or curating/releasing new assets...
\begin{enumerate}
  \item If your work uses existing assets, did you cite the creators?
    \answerTODO{}
  \item Did you mention the license of the assets?
    \answerTODO{}
  \item Did you include any new assets either in the supplemental material or as a URL?
    \answerTODO{}
  \item Did you discuss whether and how consent was obtained from people whose data you're using/curating?
    \answerTODO{}
  \item Did you discuss whether the data you are using/curating contains personally identifiable information or offensive content?
    \answerTODO{}
\end{enumerate}

\item If you used crowdsourcing or conducted research with human subjects...
\begin{enumerate}
  \item Did you include the full text of instructions given to participants and screenshots, if applicable?
    \answerTODO{}
  \item Did you describe any potential participant risks, with links to Institutional Review Board (IRB) approvals, if applicable?
    \answerTODO{}
  \item Did you include the estimated hourly wage paid to participants and the total amount spent on participant compensation?
    \answerTODO{}
\end{enumerate}

\end{enumerate}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\end{document}
