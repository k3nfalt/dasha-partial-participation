\documentclass{article}

% if you need to pass options to natbib, use, e.g.:
%     \PassOptionsToPackage{numbers, compress}{natbib}
% before loading neurips_2021

% ready for submission
\usepackage{neurips_2021}

% to compile a preprint version, e.g., for submission to arXiv, add add the
% [preprint] option:
%     \usepackage[preprint]{neurips_2021}

% to compile a camera-ready version, add the [final] option, e.g.:
%     \usepackage[final]{neurips_2021}

% to avoid loading the natbib package, add option nonatbib:
%    \usepackage[nonatbib]{neurips_2021}

\usepackage[utf8]{inputenc} % allow utf-8 input
\usepackage[T1]{fontenc}    % use 8-bit T1 fonts
\usepackage{hyperref}       % hyperlinks
\usepackage{url}            % simple URL typesetting
\usepackage{booktabs}       % professional-quality tables
\usepackage{amsfonts}       % blackboard math symbols
\usepackage{nicefrac}       % compact symbols for 1/2, etc.
\usepackage{microtype}      % microtypography
\usepackage{xcolor}         % colors

\include{macros}
\usepackage[textsize=tiny]{todonotes}

\newcommand{\alexander}[1]{\todo[inline]{\textbf{Alexander: }#1}}

\title{Formatting Instructions For NeurIPS 2021}

% The \author macro works with any number of authors. There are two commands
% used to separate the names and addresses of multiple authors: \And and \AND.
%
% Using \And between authors leaves it to LaTeX to determine where to break the
% lines. Using \AND forces a line break at that point. So, if LaTeX puts 3 of 4
% authors names on the first line, and the last on the second line, try using
% \AND instead of \And before the third author name.

\author{%
  Alexander Tyurin\\
  KAUST\\
  Saudi Arabia\\
  \texttt{alexandertiurin@gmail.com} \\
  \And
  Peter Richt\'{a}rik \\
  KAUST\\
  Saudi Arabia\\
  \texttt{richtarik@gmail.com} \\
}

\begin{document}

\maketitle

\begin{abstract}
  The abstract paragraph should be indented \nicefrac{1}{2}~inch (3~picas) on
  both the left- and right-hand margins. Use 10~point type, with a vertical
  spacing (leading) of 11~points.  The word \textbf{Abstract} must be centered,
  bold, and in point size 12. Two line spaces precede the abstract. The abstract
  must be limited to one paragraph.
\end{abstract}

\section{Introduction}

\section{Theorems}

\begin{restatable}{theorem}{CONVERGENCE}
  \label{theorem:gradient_oracle}
  Suppose that Assumptions \ref{ass:lower_bound}, \ref{ass:lipschitz_constant}, \ref{ass:nodes_lipschitz_constant} and \ref{ass:compressors} hold. Let us take $a = ,$ $$\gamma \leq \left(L + \sqrt{\frac{16 \omega \left(2 \omega + 1\right)}{n}} \widehat{L}\right)^{-1},$$ and $g^{0}_i = h^{0}_i = \nabla f_i(x^0)$ for all $i \in [n]$
  in Algorithm~\ref{alg:main_algorithm} \algname{DASHA}-\algname{PP}, then
  \begin{align*}
      &\Exp{\norm{\nabla f(\widehat{x}^T)}^2} \leq .
  \end{align*}
\end{restatable}

\newcommand*{\probavailable}{\ensuremath{p_{\textnormal{a}}}}
\newcommand*{\probpairaa}{\ensuremath{p_{\textnormal{aa}}}}
\newcommand*{\probpairan}{\ensuremath{p_{\textnormal{an}}}}
\newcommand*{\probpairnn}{\ensuremath{p_{\textnormal{nn}}}}

\newcommand*{\probpage}{\ensuremath{p_{\text{page}}}}

\section{Algorithm description}
\begin{algorithm}[h!]
  \caption{\algname{DASHA}-\algname{PP}}
  \label{alg:main_algorithm}
  \begin{algorithmic}[1]
  \STATE \textbf{Input:} starting point $x^0 \in \R^d$, stepsize $\gamma > 0$, momentum $a \in (0, 1]$, 
  momentum $b \in (0, 1]$, probability $\probavailable \in (0, 1]$ that a node is \textit{available}\footnote{}, 
  batch size $B$ (only in \algname{DASHA}-\algname{PP}-\algname{PAGE} and \algname{DASHA}-\algname{PP}-\algname{MVR}), 
  number of iterations $T \geq 1$
  \STATE Initialize $g^0_i\in \R^d$, $h^0_i\in \R^d$ on the nodes and  $g^0 = \frac{1}{n}\sum_{i=1}^n g^0_i$ on the server
  \FOR{$t = 0, 1, \dots, T - 1$}
  \STATE $x^{t+1} = x^t - \gamma g^t$ \alglinelabel{alg:main_algorithm:x_update} 
  \STATE Broadcast $x^{t+1}, x^{t}$ to all \textit{available}\footnote{} nodes
  \FOR{$i = 1, \dots, n$ in parallel}
  \IF{$i$ is \textit{available}\footnote{}}
      \STATE $k^{t+1}_i = 
      \begin{cases}
          \vspace{0.15cm}
          \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b \left(h^t_i - \nabla f_i(x^{t})\right) \\
          \vspace{0.15cm}
          \begin{cases}
              \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right),& \textnormal{with probability $\probpage$ on all \textit{available} nodes} \\
              \frac{1}{B}\sum_{j \in I^t_i}\left(\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})\right), & \textnormal{with probability $1 - \probpage$ on all \textit{available} nodes} 
          \end{cases}  \\
          \frac{1}{B}\sum_{j=1}^B \nabla f_i(x^{t+1};\xi^{t+1}_{ij}) - \frac{1}{B}\sum_{j=1}^B \nabla f_i(x^{t};\xi^{t+1}_{ij}) - b \left(h^t_i - \frac{1}{B}\sum_{j=1}^B \nabla f_i(x^{t};\xi^{t+1}_{ij})\right),
      \end{cases}$
      \STATE $h^{t+1}_i = h^t_i + \frac{1}{\probavailable}k^{t+1}_i$ 
      \STATE $m^{t+1}_i = \cC_i\Bigg(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\Bigg)$
      \STATE $g^{t+1}_i = g^{t}_i + m^{t+1}_i$
      \STATE Send $m^{t+1}_i$ to the server
  \ELSE
      \STATE $h^{t+1}_i = h^{t}_i$
      \STATE $m^{t+1}_i = 0$
      \STATE $g^{t+1}_i = g^{t}_i$
  \ENDIF
  \ENDFOR
  \STATE $g^{t+1} = g^t + \frac{1}{n} \sum_{i=1}^n m^{t+1}_i$
  \ENDFOR
  \STATE \textbf{Output:} $\hat{x}^T$ chosen uniformly at random from $\{x^t\}_{k=0}^{T-1}$ (or $x^T$ under the P\L-condition)
  \end{algorithmic}
\end{algorithm}

\newpage
\appendix

\section{Auxiliary facts}
We list auxiliary facts that we use in our proofs:
\begin{enumerate}
    \item 
        For all $x, y \in \R^d,$ we have
        \begin{align}
            \norm{x + y}^2 \leq 2\norm{x}^2 + 2\norm{y}^2
            \label{auxiliary:jensen_inequality}
        \end{align}
    \item
        Let us take a \textit{random vector} $\xi \in \R^d$, then
        \begin{align}
            \Exp{\norm{\xi}^2} = \Exp{\norm{\xi - \Exp{\xi}}^2} + \norm{\Exp{\xi}}^2.
            \label{auxiliary:variance_decomposition}
        \end{align}
\end{enumerate}

\section{Proofs of theorems}

There are three different sources of randomness in Algorithm~\ref{alg:main_algorithm}: the first one from vectors $\{k_i^{t+1}\}_{i=1}^n$, the second one from compressors $\{\cC_i\}_{i=1}^n$, and the third one from availability of nodes. We define $\ExpSub{k}{\cdot}$, $\ExpSub{\cC}{\cdot}$ and $\ExpSub{\probavailable}{\cdot}$ to be conditional expectations w.r.t.\,$\{k_i^{t+1}\}_{i=1}^n$, $\{\cC_i\}_{i=1}^n, $ and availability, accordingly, conditioned on all previous randomness. Moreover, we define $\ExpSub{t+1}{\cdot}$ to be a conditional expectation w.r.t. all randomness in iteration $t+1$ conditioned on all previous randomness. Note, that $\ExpSub{t+1}{\cdot} = \ExpSub{k}{\ExpSub{\cC}{\ExpSub{\probavailable}{\cdot}}}.$

In the case of \algname{DASHA}-\algname{PP}-\algname{PAGE}, there are two different sources of randomness from $\{k_i^{t+1}\}_{i=1}^n$. We define $\ExpSub{\probpage}{\cdot}$ and $\ExpSub{B}{\cdot}$ to be conditional expectations w.r.t.\, the probabilistic switching and mini-batch indices $I_{i}^t$, accordingly, conditioned on all previous randomness. Note, that $\ExpSub{t+1}{\cdot} = \ExpSub{B}{\ExpSub{\cC}{\ExpSub{\probavailable}{\ExpSub{\probpage}{\cdot}}}}$ and $\ExpSub{t+1}{\cdot} = \ExpSub{B}{\ExpSub{\probpage}{\ExpSub{\cC}{\ExpSub{\probavailable}{\cdot}}}}.$

\subsection{Standard lemmas in nonconvex setting}

We start the proof of theorems by providing standard lemmas from the nonconvex optimization.

\begin{lemma}
  \label{lemma:page_lemma}
  Suppose that Assumption~\ref{ass:lipschitz_constant} holds and let $x^{t+1} = x^{t} - \gamma g^{t}$. Then for any $g^{t} \in \R^d$ and $\gamma > 0$, we have
  \begin{eqnarray}
    \label{eq:page_lemma}
    f(x^{t + 1}) \leq f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
    \norm{x^{t+1} - x^t}^2 + \frac{\gamma}{2}\norm{g^{t} - \nabla f(x^t)}^2.
  \end{eqnarray}
\end{lemma}

The proof of Lemma \ref{lemma:page_lemma} is provided in \cite{PAGE}.

\begin{lemma}
  \label{lemma:good_recursion}
  Suppose that Assumption \ref{ass:lower_bound} holds and
  \begin{align*}
      \Exp{f(x^{t+1})} + \gamma \Psi^{t+1} \leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} + \gamma \Psi^{t} + \gamma C,
  \end{align*}
  where $\Psi^{t}$ is a sequence of numbers, $\Psi^{t} \geq 0$ for all $t \in [T]$, constant $C \geq 0$, and constant $\gamma > 0.$ Then 
  \begin{align}
      \label{eq:good_recursion}
      \Exp{\norm{\nabla f(\widehat{x}^T)}^2} \leq \frac{2 \left(f(x^0) - f^*\right)}{\gamma T} + \frac{2\Psi^{0}}{T} + 2 C,
  \end{align}
  where a point $\widehat{x}^T$ is chosen uniformly from a set of points $\{x^t\}_{t=0}^{T-1}.$
\end{lemma}

\begin{proof}
  By unrolling \eqref{eq:good_recursion} for $t$ from $0$ to $T - 1$, we obtain
  \begin{align*}
      \frac{\gamma}{2}\sum_{t = 0}^{T - 1}\Exp{\norm{\nabla f(x^t)}^2} + \Exp{f(x^{T})} + \gamma \Psi^{T} \leq f(x^0) + \gamma \Psi^{0} + \gamma T C.
  \end{align*}
  We subtract $f^*$, divide inequality by $\frac{\gamma T}{2},$ and take into account that $f(x) \geq f^*$ for all $x \in \R$, and $\Psi^{t} \geq 0$ for all $t \in [T],$ to get the following inequality:
  \begin{align*}
      \frac{1}{T}\sum_{t = 0}^{T - 1}\Exp{\norm{\nabla f(x^t)}^2} \leq \frac{2 \left(f(x^0) - f^*\right)}{\gamma T} + \frac{2\Psi^{0}}{T} + 2 C.
  \end{align*}
  It is left to consider the choice of a point $\widehat{x}^T$ to complete the proof of the lemma.
\end{proof}

\begin{lemma}
  Suppose that Assumption~\ref{ass:compressors} holds and let us consider sequences $g^{t+1}_i$, $h^{t+1}_i,$ and $k^{t+1}_i$ from Algorithm~\ref{alg:main_algorithm}, then
  \begin{align}
      \label{eq:compressor_global_error}
      &\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1} - h^{t+1}}^2}} \\
      &\leq \frac{2 \omega}{n^2 \probavailable}\sum_{i=1}^n\norm{k^{t+1}_i}^2 +\frac{a^2 (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n^2 \probavailable^2}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2 + (1 - a)^2\norm{g^{t} - h^{t}}^2,
  \end{align}
  and
  \begin{align}
      \label{eq:compressor_local_error}
      &\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1}_i - h^{t+1}_i}^2}} \nonumber \\
      &\leq \frac{2 \omega}{\probavailable}\norm{k^{t+1}_i}^2 + \left(\frac{a^2(2\omega + 1 - \probavailable)}{\probavailable} + (1 - a)^2\right)\norm{g^{t}_i - h^{t}_i}^2\quad \forall i \in [n].
  \end{align}
\end{lemma}
\begin{proof}
  First, we estimate $\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1} - h^{t+1}}^2}}$:
  \begin{align*}
      &\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1} - h^{t+1}}^2}} \\
      &=\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1} - h^{t+1} - \ExpSub{\cC}{\ExpSub{\probavailable}{g^{t+1} - h^{t+1}}}}^2}} + \norm{\ExpSub{\cC}{\ExpSub{\probavailable}{g^{t+1} - h^{t+1}}}}^2,
  \end{align*}
  where we used \eqref{auxiliary:variance_decomposition}.
  Using
  \begin{align*}
      &\ExpSub{\cC}{\ExpSub{\probavailable}{g^{t+1}_i}} \\
      &=\probavailable \ExpSub{\cC}{g^{t}_i + \cC_i\Bigg(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\Bigg)} + (1 - \probavailable) g^{t}_i \\
      &=g^{t}_i  + \probavailable\ExpSub{\cC}{\cC_i\Bigg(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\Bigg)} \\
      &=g^{t}_i  + k^{t+1}_i - a \left(g^{t}_i - h^{t}_i\right), \\
  \end{align*}
  and 
  \begin{align*}
      &\ExpSub{\cC}{\ExpSub{\probavailable}{h^{t+1}_i}} = \probavailable \ExpSub{\cC}{h^t_i + \frac{1}{\probavailable}k^{t+1}_i} + (1 - \probavailable) h^{t}_i = h^{t}_i + k^{t+1}_i, \\
  \end{align*}
  we can get
  \begin{align*}
      &\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1} - h^{t+1}}^2}} \\
      &=\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1} - h^{t+1} - \ExpSub{\cC}{\ExpSub{\probavailable}{g^{t+1} - h^{t+1}}}}^2}} + (1 - a)^2\norm{g^{t} - h^{t}}^2.
  \end{align*}
  Next, we have
  \begin{align*}
    &\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1} - h^{t+1}}^2}} \\
    &=\frac{1}{n^2}\sum_{i=1}^n\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1}_i - h^{t+1}_i - \ExpSub{\cC}{\ExpSub{\probavailable}{g^{t+1}_i - h^{t+1}_i}}}^2}} \\
    &\quad +\frac{1}{n^2}\sum_{i \neq j}^n\ExpSub{\cC}{\ExpSub{\probavailable}{\inp{g^{t+1}_i - h^{t+1}_i - \ExpSub{\cC}{\ExpSub{\probavailable}{g^{t+1}_i - h^{t+1}_i}}}{g^{t+1}_j - h^{t+1}_j - \ExpSub{\cC}{\ExpSub{\probavailable}{g^{t+1}_j - h^{t+1}_j}}}}} \\
    &\quad + (1 - a)^2\norm{g^{t} - h^{t}}^2\\
    &=\frac{1}{n^2}\sum_{i=1}^n\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1}_i - h^{t+1}_i - g^{t}_i + a \left(g^{t}_i - h^{t}_i\right) + h^{t}_i}^2}} \\
    &\quad +\frac{1}{n^2}\sum_{i \neq j}^n\ExpSub{\cC}{\ExpSub{\probavailable}{\inp{g^{t+1}_i - h^{t+1}_i - g^{t}_i + a \left(g^{t}_i - h^{t}_i\right) + h^{t}_i}{g^{t+1}_j - h^{t+1}_j - g^{t}_j + a \left(g^{t}_j - h^{t}_j\right) + h^{t}_j}}} \\
    &\quad + (1 - a)^2\norm{g^{t} - h^{t}}^2\\
    &=\frac{\probavailable}{n^2}\sum_{i=1}^n\ExpSub{\cC}{\norm{g^{t}_i + \cC_i\Bigg(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\Bigg) - h^{t}_i - \frac{1}{\probavailable}k^{t+1}_i - g^{t}_i + a \left(g^{t}_i - h^{t}_i\right) + h^{t}_i}^2} \\
    &\quad+ \frac{(1 - \probavailable)}{n^2}\sum_{i=1}^n\ExpSub{\cC}{\norm{g^{t}_i - h^{t}_i - g^{t}_i + a \left(g^{t}_i - h^{t}_i\right) + h^{t}_i}^2} \\
    &\quad +\frac{\probpairaa}{n^2}\sum_{i \neq j}^n{\rm E}_{\cC}\Bigg[\Bigg\langle g^{t}_i + \cC_i\Bigg(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\Bigg) - h^{t}_i - \frac{1}{\probavailable}k^{t+1}_i - g^{t}_i + a \left(g^{t}_i - h^{t}_i\right) + h^{t}_i, \\
    &\qquad\qquad\qquad\qquad g^{t}_j + \cC_j\Bigg(\frac{1}{\probavailable}k^{t+1}_j - \frac{a}{\probavailable}\left(g^{t}_j - h^{t}_j\right)\Bigg) - h^{t}_j - \frac{1}{\probavailable}k^{t+1}_j - g^{t}_j + a \left(g^{t}_j - h^{t}_j\right) + h^{t}_j\Bigg\rangle\Bigg] \\
    &\quad +\frac{2\probpairan}{n^2}\sum_{i \neq j}^n{\rm E}_{\cC}\Bigg[\Bigg\langle g^{t}_i + \cC_i\Bigg(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\Bigg) - h^{t}_i - \frac{1}{\probavailable}k^{t+1}_i - g^{t}_i + a \left(g^{t}_i - h^{t}_i\right) + h^{t}_i,\\
    &\qquad\qquad\qquad\qquad g^{t}_j - h^{t}_j - g^{t}_j + a \left(g^{t}_j - h^{t}_j\right) + h^{t}_j\Bigg\rangle\Bigg] \\
    &\quad +\frac{\probpairnn}{n^2}\sum_{i \neq j}^n\ExpSub{\cC}{\inp{g^{t}_i - h^{t}_i - g^{t}_i + a \left(g^{t}_i - h^{t}_i\right) + h^{t}_i}{g^{t}_j - h^{t}_j - g^{t}_j + a \left(g^{t}_j - h^{t}_j\right) + h^{t}_j}} \\
    &\quad + (1 - a)^2\norm{g^{t} - h^{t}}^2.\\
  \end{align*}
  In the last equality, we use Assumption~\ref{ass:prob_sampling}. Using the independence of compressors, we get
  \begin{align*}
    &\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1} - h^{t+1}}^2}} \\
    &=\frac{\probavailable}{n^2}\sum_{i=1}^n\ExpSub{\cC}{\norm{\cC_i\Bigg(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\Bigg) - \frac{1}{\probavailable}k^{t+1}_i + a \left(g^{t}_i - h^{t}_i\right)}^2} \\
    &\quad+ \frac{a^2 (1 - \probavailable)}{n^2}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2 \\
    &\quad +\frac{a^2 \probpairaa (\probavailable - 1)^2}{n^2 \probavailable^2}\sum_{i \neq j}^n\inp{g^{t}_i - h^{t}}{g^{t}_j - h^{t}_j} \\
    &\quad +\frac{2a^2\probpairan (\probavailable - 1)}{n^2 \probavailable}\sum_{i \neq j}^n\inp{g^{t}_i - h^{t}_i}{g^{t}_j - h^{t}_j} \\
    &\quad +\frac{a^2 \probpairnn}{n^2}\sum_{i \neq j}^n\inp{g^{t}_i - h^{t}_i}{g^{t}_j - h^{t}_j} \\
    &\quad + (1 - a)^2\norm{g^{t} - h^{t}}^2.\\
  \end{align*}
  Using $\probpairaa + \probpairnn + 2\probpairan = 1$ and $\probavailable = \probpairaa + \probpairan,$ we have
  \begin{align*}
    &\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1} - h^{t+1}}^2}} \\
    &=\frac{\probavailable}{n^2}\sum_{i=1}^n\ExpSub{\cC}{\norm{\cC_i\Bigg(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\Bigg) - \frac{1}{\probavailable}k^{t+1}_i + a \left(g^{t}_i - h^{t}_i\right)}^2} \\
    &\quad+ \frac{a^2 (1 - \probavailable)}{n^2}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2 \\
    &\quad +\frac{a^2 (\probpairaa - \probavailable^2)}{n^2 \probavailable^2}\sum_{i \neq j}^n\inp{g^{t}_i - h^{t}}{g^{t}_j - h^{t}_j} \\
    &\quad + (1 - a)^2\norm{g^{t} - h^{t}}^2.\\
  \end{align*}
  Next, we get
  \begin{align*}
    &\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1} - h^{t+1}}^2}} \\
    &\overset{\eqref{auxiliary:variance_decomposition}}{=}\frac{\probavailable}{n^2}\sum_{i=1}^n\ExpSub{\cC}{\norm{\cC_i\Bigg(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\Bigg) - \left(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\right)}^2} \\
    &\quad +\frac{a^2 (1 - \probavailable)^2}{n^2 \probavailable}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2 \\
    &\quad+ \frac{a^2 (1 - \probavailable)}{n^2}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2 \\
    &\quad +\frac{a^2 (\probpairaa - \probavailable^2)}{n^2 \probavailable^2}\sum_{i \neq j}^n\inp{g^{t}_i - h^{t}}{g^{t}_j - h^{t}_j} \\
    &\quad + (1 - a)^2\norm{g^{t} - h^{t}}^2.\\
    &=\frac{\probavailable}{n^2}\sum_{i=1}^n\ExpSub{\cC}{\norm{\cC_i\Bigg(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\Bigg) - \left(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\right)}^2} \\
    &\quad +\frac{a^2 (1 - \probavailable)}{n^2 \probavailable}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2 \\
    &\quad +\frac{a^2 (\probpairaa - \probavailable^2)}{n^2 \probavailable^2}\sum_{i \neq j}^n\inp{g^{t}_i - h^{t}}{g^{t}_j - h^{t}_j} \\
    &\quad + (1 - a)^2\norm{g^{t} - h^{t}}^2.\\
  \end{align*}
  Using Assumption~\ref{} and \eqref{auxiliary:jensen_inequality}, we obtain
  \begin{align*}
    &\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1} - h^{t+1}}^2}} \\
    &\leq\frac{\omega}{n^2 \probavailable}\sum_{i=1}^n\norm{k^{t+1}_i - a \left(g^{t}_i - h^{t}_i\right)}^2 +\frac{a^2 (1 - \probavailable)}{n^2 \probavailable}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2 \\
    &\quad +\frac{a^2 (\probpairaa - \probavailable^2)}{n^2 \probavailable^2}\sum_{i \neq j}^n\inp{g^{t}_i - h^{t}}{g^{t}_j - h^{t}_j} + (1 - a)^2\norm{g^{t} - h^{t}}^2.\\
    &\leq\frac{2 \omega}{n^2 \probavailable}\sum_{i=1}^n\norm{k^{t+1}_i}^2 +\frac{a^2 (2 \omega + 1 - \probavailable)}{n^2 \probavailable}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2 \\
    &\quad +\frac{a^2 (\probpairaa - \probavailable^2)}{n^2 \probavailable^2}\sum_{i \neq j}^n\inp{g^{t}_i - h^{t}}{g^{t}_j - h^{t}_j} \\
    &\quad + (1 - a)^2\norm{g^{t} - h^{t}}^2.\\
    &=\frac{2 \omega}{n^2 \probavailable}\sum_{i=1}^n\norm{k^{t+1}_i}^2 +\frac{a^2 (2 \omega + 1 - \probavailable)}{n^2 \probavailable}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2 \\
    &\quad -\frac{a^2 (\probpairaa - \probavailable^2)}{n^2 \probavailable^2}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2 + \frac{a^2 (\probpairaa - \probavailable^2)}{\probavailable^2}\norm{g^{t} - h^{t}}^2 \\
    &\quad + (1 - a)^2\norm{g^{t} - h^{t}}^2.\\
    &=\frac{2 \omega}{n^2 \probavailable}\sum_{i=1}^n\norm{k^{t+1}_i}^2 +\frac{a^2 (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n^2 \probavailable^2}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2 \\
    &\quad + \frac{a^2 (\probpairaa - \probavailable^2)}{\probavailable^2}\norm{g^{t} - h^{t}}^2 \\
    &\quad + (1 - a)^2\norm{g^{t} - h^{t}}^2.\\
  \end{align*}
  It is left to consider \eqref{asdasd} to prove \eqref{eq:compressor_global_error}. The second inequality can be proved almost in the same way:
  \begin{align*}
    &\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1}_i - h^{t+1}_i}^2}} \\
    &=\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1}_i - h^{t+1}_i - \ExpSub{\cC}{\ExpSub{\probavailable}{g^{t+1}_i - h^{t+1}_i}}}^2}} + \norm{\ExpSub{\cC}{\ExpSub{\probavailable}{g^{t+1}_i - h^{t+1}_i}}}^2 \\
    &=\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1}_i - h^{t+1}_i - g^{t}_i + a \left(g^{t}_i - h^{t}_i\right) + h^{t}_i}^2}} + (1 - a)^2\norm{g^{t}_i - h^{t}_i}^2 \\
    &=\probavailable\ExpSub{\cC}{\norm{\cC_i\Bigg(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\Bigg) - \frac{1}{\probavailable}k^{t+1}_i + a \left(g^{t}_i - h^{t}_i\right)}^2} \\
    &\quad + a^2(1 - \probavailable)\norm{g^{t}_i - h^{t}_i}^2 + (1 - a)^2\norm{g^{t}_i - h^{t}_i}^2 \\
    &\overset{\eqref{auxiliary:variance_decomposition}}{=}\probavailable\ExpSub{\cC}{\norm{\cC_i\Bigg(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\Bigg) - \left(\frac{1}{\probavailable}k^{t+1}_i - \frac{a}{\probavailable} \left(g^{t}_i - h^{t}_i\right)\right)}^2} \\
    &\quad + a^2 \frac{(1 - \probavailable)^2}{\probavailable} \norm{g^{t}_i - h^{t}_i}^2 \\
    &\quad + a^2(1 - \probavailable)\norm{g^{t}_i - h^{t}_i}^2 + (1 - a)^2\norm{g^{t}_i - h^{t}_i}^2 \\
    &\leq \frac{\omega}{\probavailable}\norm{k^{t+1}_i - a \left(g^{t}_i - h^{t}_i\right)}^2 \\
    &\quad + \frac{a^2(1 - \probavailable)}{\probavailable} \norm{g^{t}_i - h^{t}_i}^2 + (1 - a)^2\norm{g^{t}_i - h^{t}_i}^2 \\
    &\overset{\eqref{auxiliary:jensen_inequality}}{\leq} \frac{2 \omega}{\probavailable}\norm{k^{t+1}_i}^2 + \frac{a^2(2\omega + 1 - \probavailable)}{\probavailable} \norm{g^{t}_i - h^{t}_i}^2 + (1 - a)^2\norm{g^{t}_i - h^{t}_i}^2.
  \end{align*}
\end{proof}

\begin{lemma}
  \label{lemma:main_lemma}
  Suppose that Assumptions \ref{ass:lipschitz_constant} and \ref{ass:compressors} hold and let us take $a = \frac{\probavailable}{2 \omega + 1},$ then
  \begin{align*}
    &\Exp{f(x^{t + 1})} + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
    &\leq \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
    \norm{x^{t+1} - x^t}^2 + \gamma \norm{h^{t} - \nabla f(x^t)}^2}\nonumber\\
    &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable}\Exp{\norm{g^{t} - h^t}^2}+ \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2}\Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2} + \frac{4 \gamma \omega (2 \omega + 1)}{n \probavailable^2} \Exp{\frac{1}{n} \sum_{i=1}^n\norm{k^{t+1}_i}^2}.
  \end{align*}
\end{lemma}

\begin{proof}
  Due to Lemma \ref{lemma:page_lemma} and the update step from Line~\ref{alg:main_algorithm:x_update} in Algorithm~\ref{alg:main_algorithm}, we have
  \begin{eqnarray}
      \Exp{f(x^{t + 1})} &\leq& \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
      \norm{x^{t+1} - x^t}^2 + \frac{\gamma}{2}\norm{g^{t} - \nabla f(x^t)}^2} \nonumber \\
      &=& \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
      \norm{x^{t+1} - x^t}^2 + \frac{\gamma}{2}\norm{g^{t} - h^t + h^t - \nabla f(x^t)}^2} \label{eq:page_lemma_decompose} \\
      &\overset{\eqref{auxiliary:variance_decomposition}}{\leq}& \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
      \norm{x^{t+1} - x^t}^2 + \gamma\left(\norm{g^{t} - h^t}^2 + \norm{h^t - \nabla f(x^t)}^2}\right). \nonumber \\
      \nonumber
  \end{eqnarray}
  Let us fix some constants $\kappa, \eta \in [0,\infty)$ that we will define later. Combining bounds \eqref{eq:page_lemma_decompose}, \eqref{eq:compressor_global_error}, \eqref{eq:compressor_local_error} and using the law of total expectation, we get
  \begin{align*}
      &\Exp{f(x^{t + 1})} \nonumber \\
      &\quad  + \kappa \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \eta \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2} \nonumber\\
      &=\Exp{\ExpSub{t+1}{f(x^{t + 1})}} \nonumber \\
      &\quad  + \kappa \Exp{\ExpSub{\cC}{\ExpSub{\probavailable}{\norm{g^{t+1} - h^{t+1}}^2}}} + \eta \Exp{\ExpSub{\cC}{\ExpSub{\probavailable}{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}}} \nonumber\\
      &\leq \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
      \norm{x^{t+1} - x^t}^2 + \gamma\left(\norm{g^{t} - h^t}^2 + \norm{h^{t} - \nabla f(x^t)}^2\right)} \nonumber\\
      &\quad +\kappa \Exp{\frac{2 \omega}{n^2 \probavailable}\sum_{i=1}^n\norm{k^{t+1}_i}^2 +\frac{a^2 (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n^2 \probavailable^2}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2 + (1 - a)^2\norm{g^{t} - h^{t}}^2} \nonumber\\
      &\quad +\eta \Exp{\frac{2 \omega}{n \probavailable} \sum_{i=1}^n \norm{k^{t+1}_i}^2 + \left(\frac{a^2(2\omega + 1 - \probavailable)}{\probavailable} + (1 - a)^2\right)\frac{1}{n}\sum_{i=1}^n\norm{g^{t}_i - h^{t}_i}^2} \\
      &= \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
      \norm{x^{t+1} - x^t}^2 + \gamma \norm{h^{t} - \nabla f(x^t)}^2}\nonumber\\
      &\quad + \left(\gamma + \kappa \left(1 - a\right)^2\right)\Exp{\norm{g^{t} - h^t}^2}\nonumber\\
      &\quad + \left(\frac{\kappa a^2 (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} + \eta\left(\frac{a^2(2\omega + 1 - \probavailable)}{\probavailable} + (1 - a)^2\right)\right)\Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2}\nonumber\\
      &\quad + \left(\frac{2 \kappa \omega}{n \probavailable} + \frac{2 \eta \omega}{\probavailable}\right)\Exp{\frac{1}{n} \sum_{i=1}^n\norm{k^{t+1}_i}^2}.
  \end{align*}
  Now, by taking $\kappa = \frac{\gamma}{a}$, we can see that $\gamma + \kappa \left(1 - a\right)^2 \leq \kappa, $ and thus
  \begin{align*}
      &\Exp{f(x^{t + 1})} \\
      &\quad  + \frac{\gamma}{a} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \eta \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
      &\leq \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
      \norm{x^{t+1} - x^t}^2 + \gamma \norm{h^{t} - \nabla f(x^t)}^2}\nonumber\\
      &\quad + \frac{\gamma}{a}\Exp{\norm{g^{t} - h^t}^2}\nonumber\\
      &\quad + \left(\frac{\gamma a (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} + \eta\left(\frac{a^2(2\omega + 1 - \probavailable)}{\probavailable} + (1 - a)^2\right)\right)\Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2}\nonumber\\
      &\quad + \left(\frac{2 \gamma \omega}{a n \probavailable} + \frac{2 \eta \omega}{\probavailable}\right)\Exp{\frac{1}{n} \sum_{i=1}^n\norm{k^{t+1}_i}^2}.
  \end{align*}
  Next, by taking $\eta = \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2}$ and considering the choice of $a$, one can show that $\left(\frac{\gamma a (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} + \eta\left(\frac{a^2(2\omega + 1 - \probavailable)}{\probavailable} + (1 - a)^2\right)\right) \leq \eta.$ Thus

  \begin{align*}
    &\Exp{f(x^{t + 1})} \\
    &\quad  + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
    &\leq \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
    \norm{x^{t+1} - x^t}^2 + \gamma \norm{h^{t} - \nabla f(x^t)}^2}\nonumber\\
    &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable}\Exp{\norm{g^{t} - h^t}^2}+ \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2}\Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2}\nonumber\\
    &\quad + \left(\frac{2 \gamma (2 \omega + 1)\omega}{n \probavailable^2} + \frac{2 \gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa) \omega}{n \probavailable^3}\right)\Exp{\frac{1}{n} \sum_{i=1}^n\norm{k^{t+1}_i}^2}.
  \end{align*}
  Considering that $\probpairaa \geq 0,$ we can simplify the last term and get
  \begin{align*}
    &\Exp{f(x^{t + 1})} \\
    &\quad  + \frac{\gamma (2 \omega + 1)}{\probavailable} \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
    &\leq \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
    \norm{x^{t+1} - x^t}^2 + \gamma \norm{h^{t} - \nabla f(x^t)}^2}\nonumber\\
    &\quad + \frac{\gamma (2 \omega + 1)}{\probavailable}\Exp{\norm{g^{t} - h^t}^2}+ \frac{\gamma (\left(2 \omega + 1\right)\probavailable - \probpairaa)}{n \probavailable^2}\Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2}\nonumber\\
    &\quad + \frac{4 \gamma (2 \omega + 1)\omega}{n \probavailable^2} \Exp{\frac{1}{n} \sum_{i=1}^n\norm{k^{t+1}_i}^2}.
  \end{align*}
\end{proof}

\begin{lemma}
  Suppose that Assumptions \ref{} hold. For $h^{t+1}_i$ from Algorithm~\ref{alg:main_algorithm} (\algname{DASHA}-\algname{PP}) we have
  \begin{enumerate}
  \item
      \begin{align*}
          &\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} \\
          & \leq \frac{2\left(\probavailable - \probpairaa\right)\widehat{L}^2}{n \probavailable^2} \norm{x^{t+1} - x^{t}}^2 + \frac{2 b^2 \left(\probavailable - \probpairaa\right)}{n^2 \probavailable^2} \sum_{i=1}^n \norm{h^t_i - \nabla f_i(x^{t})}^2 + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2.
      \end{align*}
  \item
      \begin{align*}
          &\ExpSub{\probavailable}{\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2} \\
          & \leq \frac{2(1 - \probavailable)}{\probavailable} L^2_i \norm{x^{t+1} - x^{t}}^2 + \left(\frac{2 b^2 (1 - \probavailable)}{\probavailable} + (1 - b)^2\right) \norm{h^{t}_i - \nabla f_i(x^{t})}^2, \quad \forall i \in [n].
      \end{align*}
  \item
      \begin{align*}
        &\norm{k^{t+1}_i}^2 \leq 2L^2_i\norm{x^{t+1} - x^{t}} + 2b^2 \norm{h^t_i - \nabla f_i(x^{t})}^2, \quad \forall i \in [n].
      \end{align*}
  \end{enumerate}
\end{lemma}

\begin{proof}
  First, let us proof the bound for $\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}}$:
  \begin{align*}
      &\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} \\
      &=\ExpSub{\probavailable}{\norm{h^{t+1} - \ExpSub{\probavailable}{h^{t+1}}}^2} + \norm{\ExpSub{\probavailable}{h^{t+1}} - \nabla f(x^{t+1})}^2.
  \end{align*}
  Using
  \begin{align*}
      \ExpSub{\probavailable}{h^{t+1}_i} = h^{t}_i + \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))
  \end{align*}
  and Assumption~\ref{ass:prob_sampling}, we have
  \begin{align*}
      &\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} \\
      &=\ExpSub{\probavailable}{\norm{h^{t+1} - \ExpSub{\probavailable}{h^{t+1}}}^2} + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2\\
      &=\frac{1}{n^2}\sum_{i=1}^n \ExpSub{\probavailable}{\norm{h^{t+1}_i - \ExpSub{\probavailable}{h^{t+1}_i}}^2} \\
      &\quad+ \frac{1}{n^2}\sum_{i\neq j}^n \ExpSub{\probavailable}{\inp{h^{t+1}_i - \ExpSub{\probavailable}{h^{t+1}_i}}{h^{t+1}_j - \ExpSub{\probavailable}{h^{t+1}_j}}} \\
      &\quad + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2 \\
      &=\frac{\probavailable}{n^2}\sum_{i=1}^n \norm{h^{t}_i + \frac{1}{\probavailable}k^{t+1}_i - h^{t}_i - \nabla f_i(x^{t+1}) + \nabla f_i(x^{t}) + b(h^t_i - \nabla f_i(x^{t}))}^2 \\
      &\quad + \frac{1 - \probavailable}{n^2}\sum_{i=1}^n \norm{h^{t}_i - h^{t}_i - \nabla f_i(x^{t+1}) + \nabla f_i(x^{t}) + b(h^t_i - \nabla f_i(x^{t}))}^2 \\
      &\quad +\frac{\probpairaa}{n^2}\sum_{i \neq j}^n{\rm E}_{k}\Bigg[\Bigg\langle h^{t}_i + \frac{1}{\probavailable}k^{t+1}_i - h^{t}_i - \nabla f_i(x^{t+1}) + \nabla f_i(x^{t}) + b(h^t_i - \nabla f_i(x^{t})), \\
      &\qquad\qquad\qquad\qquad h^{t}_j + \frac{1}{\probavailable}k^{t+1}_j - h^{t}_j - \nabla f_j(x^{t+1}) + \nabla f_j(x^{t}) + b(h^t_j - \nabla f_j(x^{t}))\Bigg\rangle\Bigg] \\
      &\quad +\frac{2\probpairan}{n^2}\sum_{i \neq j}^n{\rm E}_{k}\Bigg[\Bigg\langle h^{t}_i + \frac{1}{\probavailable}k^{t+1}_i - h^{t}_i - \nabla f_i(x^{t+1}) + \nabla f_i(x^{t}) + b(h^t_i - \nabla f_i(x^{t})),\\
      &\qquad\qquad\qquad\qquad h^{t}_j - h^{t}_j - \nabla f_j(x^{t+1}) + \nabla f_j(x^{t}) + b(h^t_j - \nabla f_j(x^{t}))\Bigg\rangle\Bigg] \\
      &\quad +\frac{\probpairnn}{n^2}\sum_{i \neq j}^n\Bigg\langle h^{t}_i - h^{t}_i - \nabla f_i(x^{t+1}) + \nabla f_i(x^{t}) + b(h^t_i - \nabla f_i(x^{t})), \\
      &\qquad\qquad\qquad\qquad h^{t}_j - h^{t}_j - \nabla f_j(x^{t+1}) + \nabla f_j(x^{t}) + b(h^t_j - \nabla f_j(x^{t}))\Bigg\rangle \\
      &\quad + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2.
  \end{align*}
  Using Assumption~\ref{ass:prob_sampling} and a direct calculation, we obtain
  \begin{align*}
    &\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2} \\
    &=\frac{(1 - \probavailable)^2}{n^2 \probavailable}\sum_{i=1}^n \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad + \frac{1 - \probavailable}{n^2}\sum_{i=1}^n \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad +\frac{\probpairaa(\probavailable - 1)^2}{n^2 \probavailable^2}\sum_{i \neq j}^n\Bigg\langle \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t})), \\
    &\qquad\qquad\qquad\qquad \nabla f_j(x^{t+1}) - \nabla f_j(x^{t}) - b(h^t_j - \nabla f_j(x^{t}))\Bigg\rangle \\
    &\quad +\frac{2\probpairan (\probavailable - 1)}{n^2 \probavailable}\sum_{i \neq j}^n\Bigg\langle \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t})),\\
    &\qquad\qquad\qquad\qquad \nabla f_j(x^{t+1}) - \nabla f_j(x^{t}) - b(h^t_j - \nabla f_j(x^{t}))\Bigg\rangle \\
    &\quad +\frac{\probpairnn}{n^2}\sum_{i \neq j}^n\Bigg\langle \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t})), \\
    &\qquad\qquad\qquad\qquad \nabla f_j(x^{t+1}) - \nabla f_j(x^{t}) - b(h^t_j - \nabla f_j(x^{t}))\Bigg\rangle \\
    &\quad + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2 \\
    &=\frac{1 - \probavailable}{n^2 \probavailable}\sum_{i=1}^n \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad +\frac{\probpairaa - \probavailable^2}{n^2 \probavailable^2}\sum_{i \neq j}^n\Bigg\langle \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t})), \\
    &\qquad\qquad\qquad\qquad \nabla f_j(x^{t+1}) - \nabla f_j(x^{t}) - b(h^t_j - \nabla f_j(x^{t}))\Bigg\rangle \\
    &\quad + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2. \\
  \end{align*}
  After rearranging the terms, we have
  \begin{align*}
    &\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}} \\
    &= \frac{\probavailable - \probpairaa}{n^2 \probavailable^2} \sum_{i=1}^n \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad + \frac{\probpairaa - \probavailable^2}{\probavailable^2} \norm{\nabla f(x^{t+1}) - \nabla f(x^{t}) - b(h^t - \nabla f(x^{t}))}^2 \\
    &\quad + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2. \\
    &\overset{\eqref{probaa_leq}}{\leq}\frac{\probavailable - \probpairaa}{n^2 \probavailable^2} \sum_{i=1}^n \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2. \\
    &\overset{\eqref{auxiliary:jensen_inequality}}{\leq}\frac{2\left(\probavailable - \probpairaa\right)}{n^2 \probavailable^2} \sum_{i=1}^n \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})}^2 + \frac{2 b^2 \left(\probavailable - \probpairaa\right)}{n^2 \probavailable^2} \sum_{i=1}^n \norm{h^t_i - \nabla f_i(x^{t})}^2 \\
    &\quad + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2. \\
    &\leq\frac{2\left(\probavailable - \probpairaa\right)\widehat{L}^2}{n \probavailable^2} \norm{x^{t+1} - x^{t}}^2 + \frac{2 b^2 \left(\probavailable - \probpairaa\right)}{n^2 \probavailable^2} \sum_{i=1}^n \norm{h^t_i - \nabla f_i(x^{t})}^2 \\
    &\quad + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2. \\
  \end{align*}
  In the last in inequality, we used Assumption~\ref{}. Using the same reasoning, we can prove the second inequality:
  \begin{align*}
    &\ExpSub{\probavailable}{\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2} \\
    &=\ExpSub{\probavailable}{\norm{h^{t+1}_i - \ExpSub{\probavailable}{h^{t+1}_i}}^2} + \norm{\ExpSub{\probavailable}{h^{t+1}_i  } - \nabla f_i(x^{t+1})}^2 \\
    &=\ExpSub{\probavailable}{\norm{h^{t+1}_i - \left(h^{t}_i + \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))\right)}^2} + (1 - b)^2 \norm{h^{t}_i - \nabla f_i(x^{t})}^2 \\
    &=\frac{(1 - \probavailable)^2}{\probavailable} \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad + (1 - \probavailable)\norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 + (1 - b)^2 \norm{h^{t}_i - \nabla f_i(x^{t})}^2 \\
    &=\frac{(1 - \probavailable)}{\probavailable} \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 + (1 - b)^2 \norm{h^{t}_i - \nabla f_i(x^{t})}^2 \\
    &\leq \frac{2(1 - \probavailable)}{\probavailable} L^2_i \norm{x^{t+1} - x^{t}}^2 + \left(\frac{2 b^2 (1 - \probavailable)}{\probavailable} + (1 - b)^2\right) \norm{h^{t}_i - \nabla f_i(x^{t})}^2.
  \end{align*}
  Finally, the third inequality of the theorem follows from \eqref{auxiliary:jensen_inequality} and Assumption~\ref{}.
\end{proof}



% \CONVERGENCE*

% \begin{proof}
%     Considering Lemma~\ref{lemma:main_lemma}, Lemma~\ref{lemma:gradient}, and the law of total expectation, we obtain
%     \begin{align*}
%         &\Exp{f(x^{t + 1})} + \gamma \left(2 \omega + 1\right) \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{2 \gamma \omega}{n} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
%         &\leq \Exp{f(x^t) - \frac{\gamma}{2}\norm{\nabla f(x^t)}^2 - \left(\frac{1}{2\gamma} - \frac{L}{2}\right)
%         \norm{x^{t+1} - x^t}^2}\\
%         &\quad + \gamma \left(2 \omega + 1\right) \Exp{\norm{g^{t} - h^t}^2} + \frac{2 \gamma \omega}{n} \Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2} + \frac{8 \gamma \omega \left(2 \omega + 1\right)}{n} \widehat{L}^2 \norm{x^{t+1} - x^t}^2 \\
%         &= \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} \\
%         &\quad + \gamma \left(2 \omega + 1\right) \Exp{\norm{g^{t} - h^t}^2} + \frac{2 \gamma \omega}{n} \Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2} \\
%         &\quad - \left(\frac{1}{2\gamma} - \frac{L}{2} - \frac{8 \gamma \omega \left(2 \omega + 1\right)}{n} \widehat{L}^2\right)\Exp{\norm{x^{t+1} - x^t}^2}.
%     \end{align*}
%     Using assumption about $\gamma,$ we can show that $\frac{1}{2\gamma} - \frac{L}{2} - \frac{8 \gamma \omega \left(2 \omega + 1\right)}{n} \widehat{L}^2 \geq 0$ (see Lemma~\ref{lemma:gamma}), thus
%     \begin{align*}
%         &\Exp{f(x^{t + 1})} + \gamma \left(2 \omega + 1\right) \Exp{\norm{g^{t+1} - h^{t+1}}^2} + \frac{2 \gamma \omega}{n} \Exp{\frac{1}{n}\sum_{i=1}^n\norm{g^{t+1}_i - h^{t+1}_i}^2}\\
%         &\leq \Exp{f(x^t)} - \frac{\gamma}{2}\Exp{\norm{\nabla f(x^t)}^2} + \gamma \left(2 \omega + 1\right) \Exp{\norm{g^{t} - h^t}^2} + \frac{2 \gamma \omega}{n} \Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2}.
%     \end{align*}
%     In the view of Lemma~\ref{lemma:good_recursion} with $\Psi^t = \left(2 \omega + 1\right) \Exp{\norm{g^{t} - h^t}^2} + \frac{2 \omega}{n} \Exp{\frac{1}{n} \sum_{i=1}^n\norm{g^t_i - h^{t}_i}^2}$ we can conclude the proof.
% \end{proof}

\begin{lemma}
  Suppose that Assumptions \ref{ass:nodes_lipschitz_constant}, \ref{ass:stochastic_unbiased_and_variance_bounded} and \ref{ass:mean_square_smoothness} hold. For $h^{t+1}_i$ from Algorithm~\ref{alg:main_algorithm} (\algname{DASHA}-\algname{PP}-\algname{MVR}) we have
  \begin{enumerate}
  \item
      \begin{align*}
          &\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}} \\
          & \leq .
      \end{align*}
  \item
      \begin{align*}
          &\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}} \\
          & \leq , \quad \forall i \in [n].
      \end{align*}
  \end{enumerate}
\end{lemma}

\begin{proof}
  First, let us proof the bound for $\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}}$:
  \begin{align*}
      &\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}} \\
      &=\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1} - \ExpSub{k}{\ExpSub{\probavailable}{h^{t+1}}}}^2}} + \norm{\ExpSub{k}{\ExpSub{\probavailable}{h^{t+1}}} - \nabla f(x^{t+1})}^2.
  \end{align*}
  Using
  \begin{align*}
      \ExpSub{k}{\ExpSub{\probavailable}{h^{t+1}_i}} = h^{t}_i + \ExpSub{k}{k^{t+1}_i} = h^{t}_i + \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))
  \end{align*}
  and Assumption~\ref{ass:prob_sampling}, we have
  \begin{align*}
      &\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}} \\
      &=\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1} - \ExpSub{k}{\ExpSub{\probavailable}{h^{t+1}}}}^2}} + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2\\
      &=\frac{1}{n^2}\sum_{i=1}^n \ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1}_i - \ExpSub{k}{\ExpSub{\probavailable}{h^{t+1}_i}}}^2}} \\
      &\quad+ \frac{1}{n^2}\sum_{i\neq j}^n \ExpSub{k}{\ExpSub{\probavailable}{\inp{h^{t+1}_i - \ExpSub{k}{\ExpSub{\probavailable}{h^{t+1}_i}}}{h^{t+1}_j - \ExpSub{k}{\ExpSub{\probavailable}{h^{t+1}_j}}}}} \\
      &\quad + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2 \\
      &=\frac{\probavailable}{n^2}\sum_{i=1}^n \ExpSub{k}{\norm{h^{t}_i + \frac{1}{\probavailable}k^{t+1}_i - h^{t}_i - \nabla f_i(x^{t+1}) + \nabla f_i(x^{t}) + b(h^t_i - \nabla f_i(x^{t}))}^2} \\
      &\quad + \frac{1 - \probavailable}{n^2}\sum_{i=1}^n \norm{h^{t}_i - h^{t}_i - \nabla f_i(x^{t+1}) + \nabla f_i(x^{t}) + b(h^t_i - \nabla f_i(x^{t}))}^2 \\
      &\quad +\frac{\probpairaa}{n^2}\sum_{i \neq j}^n{\rm E}_{k}\Bigg[\Bigg\langle h^{t}_i + \frac{1}{\probavailable}k^{t+1}_i - h^{t}_i - \nabla f_i(x^{t+1}) + \nabla f_i(x^{t}) + b(h^t_i - \nabla f_i(x^{t})), \\
      &\qquad\qquad\qquad\qquad h^{t}_j + \frac{1}{\probavailable}k^{t+1}_j - h^{t}_j - \nabla f_j(x^{t+1}) + \nabla f_j(x^{t}) + b(h^t_j - \nabla f_j(x^{t}))\Bigg\rangle\Bigg] \\
      &\quad +\frac{2\probpairan}{n^2}\sum_{i \neq j}^n{\rm E}_{k}\Bigg[\Bigg\langle h^{t}_i + \frac{1}{\probavailable}k^{t+1}_i - h^{t}_i - \nabla f_i(x^{t+1}) + \nabla f_i(x^{t}) + b(h^t_i - \nabla f_i(x^{t})),\\
      &\qquad\qquad\qquad\qquad h^{t}_j - h^{t}_j - \nabla f_j(x^{t+1}) + \nabla f_j(x^{t}) + b(h^t_j - \nabla f_j(x^{t}))\Bigg\rangle\Bigg] \\
      &\quad +\frac{\probpairnn}{n^2}\sum_{i \neq j}^n\Bigg\langle h^{t}_i - h^{t}_i - \nabla f_i(x^{t+1}) + \nabla f_i(x^{t}) + b(h^t_i - \nabla f_i(x^{t})), \\
      &\qquad\qquad\qquad\qquad h^{t}_j - h^{t}_j - \nabla f_j(x^{t+1}) + \nabla f_j(x^{t}) + b(h^t_j - \nabla f_j(x^{t}))\Bigg\rangle \\
      &\quad + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2.
  \end{align*}
  Next, from the independence of stochastic gradients and Assumption~\ref{ass:prob_sampling}, we obtain
  \begin{align*}
    &\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}} \\
    &=\frac{\probavailable}{n^2}\sum_{i=1}^n \ExpSub{k}{\norm{\frac{1}{\probavailable}k^{t+1}_i - \nabla f_i(x^{t+1}) + \nabla f_i(x^{t}) + b(h^t_i - \nabla f_i(x^{t}))}^2} \\
    &\quad + \frac{1 - \probavailable}{n^2}\sum_{i=1}^n \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad +\frac{\probpairaa(\probavailable - 1)^2}{n^2 \probavailable^2}\sum_{i \neq j}^n\Bigg\langle \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t})), \\
    &\qquad\qquad\qquad\qquad \nabla f_j(x^{t+1}) - \nabla f_j(x^{t}) - b(h^t_j - \nabla f_j(x^{t}))\Bigg\rangle \\
    &\quad +\frac{2\probpairan (\probavailable - 1)}{n^2 \probavailable}\sum_{i \neq j}^n\Bigg\langle \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t})),\\
    &\qquad\qquad\qquad\qquad \nabla f_j(x^{t+1}) - \nabla f_j(x^{t}) - b(h^t_j - \nabla f_j(x^{t}))\Bigg\rangle \\
    &\quad +\frac{\probpairnn}{n^2}\sum_{i \neq j}^n\Bigg\langle \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t})), \\
    &\qquad\qquad\qquad\qquad \nabla f_j(x^{t+1}) - \nabla f_j(x^{t}) - b(h^t_j - \nabla f_j(x^{t}))\Bigg\rangle \\
    &\quad + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2 \\
    &=\frac{\probavailable}{n^2}\sum_{i=1}^n \ExpSub{k}{\norm{\frac{1}{\probavailable}k^{t+1}_i - \nabla f_i(x^{t+1}) + \nabla f_i(x^{t}) + b(h^t_i - \nabla f_i(x^{t}))}^2} \\
    &\quad + \frac{1 - \probavailable}{n^2}\sum_{i=1}^n \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad +\frac{\probpairaa - \probavailable^2}{n^2 \probavailable^2}\sum_{i \neq j}^n\Bigg\langle \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t})), \\
    &\qquad\qquad\qquad\qquad \nabla f_j(x^{t+1}) - \nabla f_j(x^{t}) - b(h^t_j - \nabla f_j(x^{t}))\Bigg\rangle \\
    &\quad + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2 \\
    &\overset{\eqref{auxiliary:variance_decomposition}}{=}\frac{1}{n^2 \probavailable}\sum_{i=1}^n \ExpSub{k}{\norm{k^{t+1}_i - \ExpSub{k}{k^{t+1}_i}}^2} \\
    &\quad + \frac{(1 - \probavailable)^2}{n^2 \probavailable}\sum_{i=1}^n \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad + \frac{1 - \probavailable}{n^2}\sum_{i=1}^n \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad +\frac{\probpairaa - \probavailable^2}{n^2 \probavailable^2}\sum_{i \neq j}^n\Bigg\langle \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t})), \\
    &\qquad\qquad\qquad\qquad \nabla f_j(x^{t+1}) - \nabla f_j(x^{t}) - b(h^t_j - \nabla f_j(x^{t}))\Bigg\rangle \\
    &\quad + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2. \\
  \end{align*}
  After rearranging the terms, we have
  \begin{align*}
    &\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}} \\
    &=\frac{1}{n^2 \probavailable}\sum_{i=1}^n \ExpSub{k}{\norm{k^{t+1}_i - \ExpSub{k}{k^{t+1}_i}}^2} \\
    &\quad + \frac{1 - \probavailable}{n^2 \probavailable}\sum_{i=1}^n \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad +\frac{\probpairaa - \probavailable^2}{n^2 \probavailable^2}\sum_{i \neq j}^n\Bigg\langle \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t})), \\
    &\qquad\qquad\qquad\qquad \nabla f_j(x^{t+1}) - \nabla f_j(x^{t}) - b(h^t_j - \nabla f_j(x^{t}))\Bigg\rangle \\
    &\quad + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2. \\
    &=\frac{1}{n^2 \probavailable}\sum_{i=1}^n \ExpSub{k}{\norm{k^{t+1}_i - \ExpSub{k}{k^{t+1}_i}}^2} \\
    &\quad + \frac{1 - \probavailable}{n^2 \probavailable}\sum_{i=1}^n \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad - \frac{\probpairaa - \probavailable^2}{n^2 \probavailable^2} \sum_{i=1}^n \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad + \frac{\probpairaa - \probavailable^2}{\probavailable^2} \norm{\nabla f(x^{t+1}) - \nabla f(x^{t}) - b(h^t - \nabla f(x^{t}))}^2 \\
    &\quad + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2. \\
    &=\frac{1}{n^2 \probavailable}\sum_{i=1}^n \ExpSub{k}{\norm{k^{t+1}_i - \ExpSub{k}{k^{t+1}_i}}^2} \\
    &\quad + \frac{\probavailable - \probpairaa}{n^2 \probavailable^2} \sum_{i=1}^n \norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t}))}^2 \\
    &\quad + \frac{\probpairaa - \probavailable^2}{\probavailable^2} \norm{\nabla f(x^{t+1}) - \nabla f(x^{t}) - b(h^t - \nabla f(x^{t}))}^2 \\
    &\quad + \left(1 - b\right)^2 \norm{h^{t} - \nabla f(x^{t})}^2. \\
  \end{align*}
\end{proof}

In the following lemma, we provide a helpful observation about $k^{t+1}_i$.

\begin{lemma}
  \label{lemma:expectation_k_t}
  Suppose that Assumptions \ref{}, \ref{} and \ref{} hold. For $k^{t+1}_i$ from Algorithm~\ref{alg:main_algorithm} we have
  \begin{align*}
      &\ExpSub{k}{k^{t+1}_i} = \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b(h^t_i - \nabla f_i(x^{t})).
  \end{align*}
\end{lemma}

\begin{proof}
  Clearly, the equality holds for \algname{DASHA}-\algname{PP}. Next, we show it for \algname{DASHA}-\algname{PP}-\algname{PAGE}:
  \begin{align*}
    &\ExpSub{k}{k^{t+1}_i} \\
    &= \probpage \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right)\right) \\
    &\quad + (1 - \probpage) \ExpSub{k}{\frac{1}{B}\sum_{j \in I^t_i}\left(\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})\right)} \\
    &= \probpage \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right)\right) \\
    &\quad + (1 - \probpage) \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right) \\
    &= \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - b \left(h^t_i - \nabla f_i(x^{t})\right).
\end{align*}
Finally, from the unbiasedness of stochastic gradients, the equality holds for \algname{DASHA}-\algname{PP}-\algname{MVR}.
\end{proof}

\begin{lemma}
  Suppose that Assumptions \ref{} hold. For $h^{t+1}_i$ from Algorithm~\ref{alg:main_algorithm} (\algname{DASHA}-\algname{PP}-\algname{PAGE}) we have
  \begin{enumerate}
  \item
      \begin{align*}
          &\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}} \\
          & \leq .
      \end{align*}
  \item
      \begin{align*}
          &\ExpSub{k}{\ExpSub{\probavailable}{\norm{h^{t+1}_i - \nabla f_i(x^{t+1})}^2}} \\
          & \leq , \quad \forall i \in [n].
      \end{align*}
  \end{enumerate}
\end{lemma}

\begin{proof}
  Let us denote
  \begin{align*}
      &k^{t+1}_{i, 1} \eqdef \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right), \\
      &k^{t+1}_{i, 2} \eqdef \frac{1}{B}\sum_{j \in I^t_i}\left(\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})\right), \\
      &h^{t+1}_{i,1} \eqdef \begin{cases}
          h^t_i + \frac{1}{\probavailable} k^{t+1}_{i, 1},& \textnormal{with probability $\probavailable$,} \\
          h^t_i, & \textnormal{with probability $1 - \probavailable$,} 
      \end{cases}  \\
      &h^{t+1}_{i,2} \eqdef \begin{cases}
          h^t_i + \frac{1}{\probavailable} k^{t+1}_{i, 2},& \textnormal{with probability $\probavailable$,} \\
          h^t_i, & \textnormal{with probability $1 - \probavailable$,}
      \end{cases}  \\
  \end{align*}
  $h^{t+1}_{1} \eqdef \frac{1}{n}\sum_{i=1}^n h^{t+1}_{i,1},$ and $h^{t+1}_{2} \eqdef \frac{1}{n}\sum_{i=1}^n h^{t+1}_{i,2}.$ Note, that
  \begin{align*}
    &h^{t+1} = \begin{cases}
      h^{t+1}_{1},& \textnormal{with probability $\probpage$,} \\
      h^{t+1}_{2},& \textnormal{with probability $1 - \probpage$.} 
    \end{cases}
  \end{align*}
  Thus, we have
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{\ExpSub{\probpage}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}}} \\
    &=\probpage\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{1} - \nabla f(x^{t+1})}^2}} + (1 - \probpage)\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{2} - \nabla f(x^{t+1})}^2}}.\\
  \end{align*}
  Using 
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{i,1}}} = \\
    &=\probavailable h^t_i +  \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right) + (1 - \probavailable) h^t_i \\
    &= h^t_i + \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right).
  \end{align*}
  and 
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{i,2}}} = \\
    &=\probavailable h^t_i +  \ExpSub{B}{\frac{1}{B}\sum_{j \in I^t_i}\left(\nabla f_{ij}(x^{t+1}) - \nabla f_{ij}(x^{t})\right)} + (1 - \probavailable) h^t_i \\
    &= h^t_i + \nabla f_i(x^{t+1}) - \nabla f_i(x^{t}),
  \end{align*}
  we obtaine
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{\ExpSub{\probpage}{\norm{h^{t+1} - \nabla f(x^{t+1})}^2}}} \\
    &\overset{\eqref{auxiliary:variance_decomposition}}{=}\probpage\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{1} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{1}}}}^2}} + (1 - \probpage)\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{2} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{2}}}}^2}} \\
    &\quad +\probpage\norm{\ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{1}}} - \nabla f(x^{t+1})}^2 + (1 - \probpage)\norm{\ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{2}}} - \nabla f(x^{t+1})}^2 \\
    &=\probpage\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{1} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{1}}}}^2}} + (1 - \probpage)\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{2} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{2}}}}^2}} \\
    &\quad +\left(\probpage\left(1 - \frac{b}{\probpage}\right)^2 + (1 - \probpage)\right)\norm{h^{t} - \nabla f(x^{t})}^2.
  \end{align*}
  Next, we consider $\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{1} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{1}}}}^2}}$:
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{1} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{1}}}}^2}}\\
    &=\ExpSub{\probavailable}{\norm{h^{t+1}_{1} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{1}}}}^2} \\
    &=\frac{1}{n^2}\sum_{i=1}^n\ExpSub{\probavailable}{\norm{h^{t+1}_{i,1} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{i,1}}}}^2} \\
    &\quad +\frac{1}{n^2}\sum_{i\neq j}^n\ExpSub{\probavailable}{\inp{h^{t+1}_{i,1} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{i,1}}}}{h^{t+1}_{j,1} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{j,1}}}}} \\
    &=\frac{(1 - \probavailable)^2}{n^2 \probavailable}\sum_{i=1}^n\norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right)}^2 \\
    &\quad + \frac{1 - \probavailable}{n^2}\sum_{i=1}^n\norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right)}^2\\
    &\quad +\frac{\probpairaa(\probavailable - 1)^2}{n^2 \probavailable^2}\sum_{i\neq j}^n\inp{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right)}{\nabla f_j(x^{t+1}) - \nabla f_j(x^{t}) - \frac{b}{\probpage} \left(h^t_j - \nabla f_j(x^{t})\right)} \\
    &\quad +\frac{2\probpairan (\probavailable - 1)}{n^2 \probavailable}\sum_{i\neq j}^n\inp{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right)}{\nabla f_j(x^{t+1}) - \nabla f_j(x^{t}) - \frac{b}{\probpage} \left(h^t_j - \nabla f_j(x^{t})\right)} \\
    &\quad +\frac{\probpairnn}{n^2}\sum_{i\neq j}^n\inp{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right)}{\nabla f_j(x^{t+1}) - \nabla f_j(x^{t}) - \frac{b}{\probpage} \left(h^t_j - \nabla f_j(x^{t})\right)} \\
  \end{align*}
  Considering Assumption~\ref{ass:prob_sampling}, we have
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{1} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{1}}}}^2}}\\
    &=\frac{1 - \probavailable}{n^2 \probavailable}\sum_{i=1}^n\norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right)}^2 \\
    &\quad +\frac{\probpairaa - \probavailable^2}{n^2 \probavailable^2}\sum_{i\neq j}^n\inp{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right)}{\nabla f_j(x^{t+1}) - \nabla f_j(x^{t}) - \frac{b}{\probpage} \left(h^t_j - \nabla f_j(x^{t})\right)} \\
    &=\frac{\probavailable - \probpairaa}{n^2 \probavailable^2}\sum_{i=1}^n\norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t}) - \frac{b}{\probpage} \left(h^t_i - \nabla f_i(x^{t})\right)}^2 \\
    &\quad +\frac{\probpairaa - \probavailable^2}{\probavailable^2}\norm{\nabla f(x^{t+1}) - \nabla f(x^{t}) - \frac{b}{\probpage} \left(h^t - \nabla f(x^{t})\right)}^2. \\
  \end{align*}
  Now, we bound $\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{2} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{2}}}}^2}}$:
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{2} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{2}}}}^2}}\\
    &=\frac{1}{n^2}\sum_{i=1}^n\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{i,2} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{i,2}}}}^2}} \\
    &\quad +\frac{1}{n^2}\sum_{i\neq j}^n\ExpSub{B}{\ExpSub{\probavailable}{\inp{h^{t+1}_{i,2} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{i,2}}}}{h^{t+1}_{j,2} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{j,2}}}}}} \\
    &=\frac{\probavailable}{n^2}\sum_{i=1}^n\ExpSub{B}{\norm{h^t_i + \frac{1}{\probavailable} k^{t+1}_{i, 2} - \left(h^t_i + \nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}^2} \\
    &\quad + \frac{1 - \probavailable}{n^2}\sum_{i=1}^n\norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})}^2 \\
    &\quad +\frac{\probpairaa}{n^2}\sum_{i\neq j}^n\ExpSub{B}{\inp{h^t_i + \frac{1}{\probavailable} k^{t+1}_{i, 2} - \left(h^t_i + \nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}{h^t_j + \frac{1}{\probavailable} k^{t+1}_{j, 2} - \left(h^t_j + \nabla f_j(x^{t+1}) - \nabla f_j(x^{t})\right)}} \\
    &\quad +\frac{2\probpairan}{n^2}\sum_{i\neq j}^n\ExpSub{B}{\inp{h^t_i + \frac{1}{\probavailable} k^{t+1}_{i, 2} - \left(h^t_i + \nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}{h^t_j - \left(h^t_j + \nabla f_j(x^{t+1}) - \nabla f_j(x^{t})\right)}} \\
    &\quad +\frac{\probpairnn}{n^2}\sum_{i\neq j}^n\inp{h^t_i - \left(h^t_i + \nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}{h^t_j - \left(h^t_j + \nabla f_j(x^{t+1}) - \nabla f_j(x^{t})\right)} \\
    &=\frac{\probavailable}{n^2}\sum_{i=1}^n\ExpSub{B}{\norm{\frac{1}{\probavailable} k^{t+1}_{i, 2} - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}^2} \\
    &\quad + \frac{1 - \probavailable}{n^2}\sum_{i=1}^n\norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})}^2 \\
    &\quad +\left(\frac{\probpairaa (\probavailable - 1)^2}{n^2 \probavailable^2} + \frac{2\probpairan (\probavailable - 1)}{n^2 \probavailable} + \frac{\probpairnn}{n^2}\right)\sum_{i\neq j}^n\inp{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})}{\nabla f_j(x^{t+1}) - \nabla f_j(x^{t})}.
  \end{align*}
  Using Assumption~\ref{prob} and \eqref{auxiliary:variance_decomposition}, we get
  \begin{align*}
    &\ExpSub{B}{\ExpSub{\probavailable}{\norm{h^{t+1}_{2} - \ExpSub{B}{\ExpSub{\probavailable}{h^{t+1}_{2}}}}^2}}\\
    &=\frac{1}{n^2 \probavailable}\sum_{i=1}^n\ExpSub{B}{\norm{k^{t+1}_{i, 2} - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}^2} \\
    &\quad + \frac{1 - \probavailable}{n^2 \probavailable}\sum_{i=1}^n\norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})}^2 \\
    &\quad +\frac{\probpairaa - \probavailable^2}{n^2 \probavailable^2}\sum_{i\neq j}^n\inp{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})}{\nabla f_j(x^{t+1}) - \nabla f_j(x^{t})} \\
    &=\frac{1}{n^2 \probavailable}\sum_{i=1}^n\ExpSub{B}{\norm{k^{t+1}_{i, 2} - \left(\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})\right)}^2} \\
    &\quad + \frac{\probavailable - \probpairaa}{n^2 \probavailable^2}\sum_{i=1}^n\norm{\nabla f_i(x^{t+1}) - \nabla f_i(x^{t})}^2 \\
    &\quad +\frac{\probpairaa - \probavailable^2}{\probavailable^2}\norm{\nabla f(x^{t+1}) - \nabla f(x^{t})}^2.
  \end{align*}
\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section*{Checklist}

%%% BEGIN INSTRUCTIONS %%%
The checklist follows the references.  Please
read the checklist guidelines carefully for information on how to answer these
questions.  For each question, change the default \answerTODO{} to \answerYes{},
\answerNo{}, or \answerNA{}.  You are strongly encouraged to include a {\bf
justification to your answer}, either by referencing the appropriate section of
your paper or providing a brief inline description.  For example:
\begin{itemize}
  \item Did you include the license to the code and datasets? \answerYes{See Section~\ref{gen_inst}.}
  \item Did you include the license to the code and datasets? \answerNo{The code and the data are proprietary.}
  \item Did you include the license to the code and datasets? \answerNA{}
\end{itemize}
Please do not modify the questions and only use the provided macros for your
answers.  Note that the Checklist section does not count towards the page
limit.  In your paper, please delete this instructions block and only keep the
Checklist section heading above along with the questions/answers below.
%%% END INSTRUCTIONS %%%

\begin{enumerate}

\item For all authors...
\begin{enumerate}
  \item Do the main claims made in the abstract and introduction accurately reflect the paper's contributions and scope?
    \answerTODO{}
  \item Did you describe the limitations of your work?
    \answerTODO{}
  \item Did you discuss any potential negative societal impacts of your work?
    \answerTODO{}
  \item Have you read the ethics review guidelines and ensured that your paper conforms to them?
    \answerTODO{}
\end{enumerate}

\item If you are including theoretical results...
\begin{enumerate}
  \item Did you state the full set of assumptions of all theoretical results?
    \answerTODO{}
	\item Did you include complete proofs of all theoretical results?
    \answerTODO{}
\end{enumerate}

\item If you ran experiments...
\begin{enumerate}
  \item Did you include the code, data, and instructions needed to reproduce the main experimental results (either in the supplemental material or as a URL)?
    \answerTODO{}
  \item Did you specify all the training details (e.g., data splits, hyperparameters, how they were chosen)?
    \answerTODO{}
	\item Did you report error bars (e.g., with respect to the random seed after running experiments multiple times)?
    \answerTODO{}
	\item Did you include the total amount of compute and the type of resources used (e.g., type of GPUs, internal cluster, or cloud provider)?
    \answerTODO{}
\end{enumerate}

\item If you are using existing assets (e.g., code, data, models) or curating/releasing new assets...
\begin{enumerate}
  \item If your work uses existing assets, did you cite the creators?
    \answerTODO{}
  \item Did you mention the license of the assets?
    \answerTODO{}
  \item Did you include any new assets either in the supplemental material or as a URL?
    \answerTODO{}
  \item Did you discuss whether and how consent was obtained from people whose data you're using/curating?
    \answerTODO{}
  \item Did you discuss whether the data you are using/curating contains personally identifiable information or offensive content?
    \answerTODO{}
\end{enumerate}

\item If you used crowdsourcing or conducted research with human subjects...
\begin{enumerate}
  \item Did you include the full text of instructions given to participants and screenshots, if applicable?
    \answerTODO{}
  \item Did you describe any potential participant risks, with links to Institutional Review Board (IRB) approvals, if applicable?
    \answerTODO{}
  \item Did you include the estimated hourly wage paid to participants and the total amount spent on participant compensation?
    \answerTODO{}
\end{enumerate}

\end{enumerate}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\end{document}
